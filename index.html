<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5.0, user-scalable=yes"/>
<title>Grant Exchange - OSRS Charting Tool</title>
<meta name="description" content="Advanced charting tool for OSRS Grand Exchange items with indicators like Ichimoku Cloud, Volume Profile, and Volume. Analyze trends from 1 day to 5 years.">
<meta name="keywords" content="OSRS Grand Exchange, OSRS GE, RuneScape Grand Exchange, OSRS charting, OSRS price charts, OSRS indicators, Ichimoku Cloud OSRS, Volume Profile OSRS">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://grantexchange.net/">
<!-- Open Graph -->
<meta property="og:title" content="Grant Exchange - OSRS Charting Tool">
<meta property="og:description" content="Advanced charting tool for OSRS Grand Exchange items with indicators like Ichimoku Cloud, Volume Profile, and Volume. Analyze trends from 1 day to 5 years.">
<meta property="og:image" content="https://oldschool.runescape.wiki/images/Gilded_scimitar.png">
<meta property="og:url" content="https://grantexchange.net/">
<meta property="og:type" content="website">
<!-- Favicon -->
<link rel="icon" type="image/png" sizes="48x48" href="https://oldschool.runescape.wiki/images/Gilded_scimitar.png">
<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Grant Exchange - OSRS Charting Tool">
<meta name="twitter:description" content="Advanced charting tool for OSRS Grand Exchange items with indicators like Ichimoku Cloud, Volume Profile, and Volume. Analyze trends from 1 day to 5 years.">
<meta name="twitter:image" content="https://oldschool.runescape.wiki/images/Gilded_scimitar.png">
<!-- Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-43YM2RCX1R"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-43YM2RCX1R');
</script>
<!-- CSS (Darkened RuneScape theme, inspired by flipping.gg / TradingView) -->
<style>
:root{
  --bg:#0f0a05; --panel:#1f170a; --edge:#5a3f1b;
  --gold:#b0935a; --orange:#d09010; --ink:#d5c5af; --muted:#ab9f79;
  --low-color:#db4a4a; --high-color:#4ca75a; --grid:#2b1f09; --accent:#efbe3f; --shadow:#050301;
  --teal: #00d5d5;
  --ichi-tenkan: #069af3; --ichi-kijun: #ec2b88; --ichi-chikou: #22b14c;
  --ichi-senkou-a: #a1d8a0; --ichi-senkou-b: #d8a0a6;
  --cloud-green: rgba(161,216,160,0.2); --cloud-red: rgba(216,160,166,0.2);
}
* {box-sizing:border-box}
html,body{height:100%; margin:0; padding:0;}
body{
  background:radial-gradient(1200px 600px at 20% -10%,#1f170a 0%,#0f0a05 60%),#0f0a05;
  color:var(--ink);
  font-family:Segoe UI,Inter,system-ui,Arial;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  font-size:14px; /* Base size for readability */
}
/* Layout */
.wrap{max-width:none; margin:0; padding:10px; height:100vh;
  display:flex; flex-direction:column;}
.header{display:flex; align-items:center; gap:12px; margin-bottom:10px;}
h1{margin:0;font-size:24px;font-weight:900;color:var(--orange);text-shadow:0 1px 0 #000;cursor:pointer}
.badge{font-size:11px;border:1px solid var(--edge);border-radius:999px;
  padding:1px 6px;color:var(--muted);background:#10090e}
/* Search Bar with Item Photo */
.sbar{display:flex;align-items:center;gap:8px;background:var(--panel);padding:8px;border-radius:12px;border:1px solid var(--edge); max-width:400px;}
.sbar img{width:32px;height:32px;object-fit:contain;image-rendering:pixelated;border-radius:4px;background:#151008;}
.sbar input{flex:1;background:transparent;border:none;color:var(--ink);font-size:18px;outline:none;}
.sbar input::placeholder{color:var(--muted);}
/* Suggest */
.suggest{position:absolute;top:calc(100% + 4px);left:0;width:100%;max-height:300px;overflow:auto;background:var(--panel);border:1px solid var(--edge);border-radius:10px;z-index:10;}
.suggest div{padding:8px 12px;cursor:pointer;font-size:14px;}
.suggest div:hover{background:var(--grid);}
/* Tools Row */
.refreshRow{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
.viewtabs, .tools{display:flex;gap:4px;}
.viewtabs button, .tools button{background:var(--panel);border:1px solid var(--edge);
  color:var(--ink);border-radius:8px;padding:4px 8px;cursor:pointer;font-size:12px;text-transform:uppercase;font-weight:bold;}
.viewtabs button.active, .tools button.active{background:var(--grid);border-color:var(--orange);}
#indicatorSelect{background:var(--panel);border:1px solid var(--edge);color:var(--ink);padding:4px 8px;border-radius:8px;font-size:12px;}
/* Chart */
.chartWrap{flex:1;position:relative;min-height:400px;}
.chart{width:100%;height:100%;background:var(--grid);border:1px solid var(--edge);border-radius:12px;}
.chart-tip{position:absolute;display:none;background:rgba(0,0,0,.85);color:#fff;padding:6px 8px;border-radius:6px;font-size:12px;pointer-events:none;white-space:nowrap;border:1px solid #000;}
.legend{display:flex;gap:8px;font-size:11px;margin-top:4px;color:var(--muted)}
.legend .sell::before{content:"";display:inline-block;width:12px;height:2px;background:var(--low-color);margin-right:4px;border-radius:2px}
.legend .buy::before{content:"";display:inline-block;width:12px;height:2px;background:var(--high-color);margin-right:4px;border-radius:2px}
/* Refresh */
.btn-refresh{padding:4px 8px;border-radius:8px;border:1px solid var(--edge);background:var(--panel);color:var(--gold);font-size:12px;cursor:pointer;}
/* Mobile */
@media (max-width: 768px) {
  .wrap{padding:5px;}
  h1{font-size:20px;}
  .sbar input{font-size:16px;}
  .viewtabs button, .tools button{font-size:10px;padding:3px 6px;}
  #indicatorSelect{font-size:10px;}
  .chartWrap{min-height:300px;}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1 onclick="location.reload();">Grant Exchange</h1><span class="badge">v3.1</span> <span class="badge">OSRS Charts</span>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <div class="mode-pill">
        <button id="btnF2P" class="active">F2P</button>
        <button id="btnMembers">Members</button>
      </div>
    </div>
  </div>
  <div class="sbar">
    <img id="itemImg" src="" alt="Item" style="display:none;">
    <input id="query" placeholder="Search item... e.g., Gilded scimitar" autocomplete="off"/>
    <div id="suggestBox" class="suggest" style="display:none"></div>
  </div>
  <div class="refreshRow">
    <div class="viewtabs">
      <button data-view="1d" class="active">1D</button>
      <button data-view="1w">1W</button>
      <button data-view="1m">1M</button>
      <button data-view="6m">6M</button>
      <button data-view="1y">1Y</button>
      <button data-view="5y">5Y</button>
      <button data-view="all">All</button>
    </div>
    <div class="tools">
      <span>Zoom:</span><button id="zIn">+</button><button id="zOut">-</button>
      <span>Mode:</span>
      <button id="lineMode" class="active">Line</button>
      <button id="dotMode">Scatter</button>
      <span>Indicators:</span>
      <select id="indicatorSelect">
        <option value="ichimoku">Ichimoku Cloud</option>
        <option value="vp">Volume Profile</option>
        <option value="volume">Volume</option>
      </select>
      <button id="addIndicator">Add</button>
    </div>
    <button id="refreshBtn" class="btn-refresh">Refresh</button>
  </div>
  <div class="chartWrap">
    <canvas id="chart" class="chart"></canvas>
    <div id="tip" class="chart-tip"></div>
  </div>
  <div class="legend"><span class="sell">Low (Buy)</span><span class="buy">High (Sell)</span></div>
</div>
<!-- SCRIPT (Expanded with anti-blur, pan/zoom, more indicators logic) -->
<script>
/* Constants & API */
const $ = s => document.querySelector(s);
const API = "https://prices.runescape.wiki/api/v1/osrs";
let mapping=[], latest=null, volumes=null, selected=null;
let currentSeries=null, view="1d", zoom=1, offset=0, drawMode="line";
let membersOn=false;
let enabledIndicators = [];
const canvas = $("#chart");
const ctx = canvas.getContext("2d");
const tip = $("#tip");

/* Utilities */
const fmtGp = n => n==null ? "—" : Number(n).toLocaleString() + " gp";
const fmtNum = n => n==null ? "—" : Number(n).toLocaleString();
const abbreviateNumber = (num) => {
  if (num >= 1e9) return (num / 1e9).toFixed(1).replace(/\.0$/, '') + 'b';
  if (num >= 1e6) return (num / 1e6).toFixed(1).replace(/\.0$/, '') + 'm';
  if (num >= 1e3) return (num / 1e3).toFixed(1).replace(/\.0$/, '') + 'k';
  return num.toLocaleString();
};
async function jget(url){ const r=await fetch(url, {cache: "default"}); if(!r.ok) throw new Error(url+" HTTP "+r.status); return await r.json(); }
const loadMapping=()=>jget(API+"/mapping");
const loadLatest =()=>jget(API+"/latest");
const loadVolumes=()=>jget(API+"/volumes");
const loadTS =(step,id)=> jget(API+`/timeseries?timestep=${step}&id=${id}`);
function bigIconUrl(id){ return `./images/${id}.png`; }
function seriesFromTS(ts){
  const src = ts?.data || [];
  const rows = src.map(r=>({
    t: Number(r.timestamp ?? r.ts ?? r.time),
    lo: r.avgLowPrice ?? r.low ?? null,
    hi: r.avgHighPrice ?? r.high ?? null,
    vol: (r.lowPriceVolume ?? 0) + (r.highPriceVolume ?? 0) ?? r.volume ?? null
  })).filter(r=>r.t && (r.lo!=null || r.hi!=null)).sort((a,b)=>a.t-b.t);
  return { labels: rows.map(r=>r.t), low: rows.map(r=>r.lo), high: rows.map(r=>r.hi), vol: rows.map(r=>r.vol ?? 0) };
}

/* Resize for sharpness */
function resizeCanvas() {
  const dpr = window.devicePixelRatio || 1;
  canvas.width = canvas.clientWidth * dpr;
  canvas.height = canvas.clientHeight * dpr;
  ctx.scale(dpr, dpr);
  if (currentSeries) drawChart(currentSeries);
}
window.addEventListener('resize', resizeCanvas);

/* Ichimoku */
function calculateIchimoku(series) {
  const highs = series.high;
  const lows = series.low;
  const closes = highs.map((h, i) => (h + (lows[i] ?? h)) / 2);
  const getHigh = (p, i) => Math.max(...highs.slice(Math.max(0, i - p + 1), i + 1));
  const getLow = (p, i) => Math.min(...lows.slice(Math.max(0, i - p + 1), i + 1));
  const tenkan = [], kijun = [], senkouA = [], senkouB = [], chikou = [];
  for (let i = 0; i < highs.length; i++) {
    if (i >= 8) tenkan.push((getHigh(9, i) + getLow(9, i)) / 2);
    if (i >= 25) kijun.push((getHigh(26, i) + getLow(26, i)) / 2);
    if (i >= 51) senkouB.push((getHigh(52, i) + getLow(52, i)) / 2);
    if (tenkan.length && kijun.length) senkouA.push((tenkan.at(-1) + kijun.at(-1)) / 2);
    chikou.push(i >= 25 ? closes[i - 25] : null);
  }
  const shift = Array(26).fill(null);
  return { tenkan, kijun, senkouA: [...shift, ...senkouA], senkouB: [...shift, ...senkouB], chikou };
}

/* VP */
function calculateVP(series, bins = 50) {
  const prices = series.low.map((lo, i) => (lo + (series.high[i] ?? lo)) / 2).filter(p => p != null);
  const vols = series.vol.filter(v => v > 0);
  if (prices.length === 0) return { bins: [], maxVol: 0 };
  const minP = Math.min(...prices), maxP = Math.max(...prices);
  const binSize = (maxP - minP) / bins;
  const vpBins = Array(bins).fill(0);
  prices.forEach((p, i) => {
    const binIndex = Math.min(bins - 1, Math.floor((p - minP) / binSize));
    vpBins[binIndex] += vols[i] || 0;
  });
  const maxVol = Math.max(...vpBins);
  return { bins: vpBins, minP, binSize, maxVol };
}

/* Draw Chart */
function ypx(v, vmin, vmax, y0, h){ if(vmin===vmax) return y0+h/2; return y0 + (1 - (v-vmin)/(vmax-vmin))*h; }
function drawChart(series){
  const W=canvas.clientWidth, H=canvas.clientHeight;
  let x0=50, y0=20, w=W-x0-20, h=H-y0-40;
  const hasVolume = enabledIndicators.includes('volume');
  const hasVP = enabledIndicators.includes('vp');
  if (hasVolume) h *= 0.75; 
  if (hasVP) w *= 0.8; 
  ctx.clearRect(0,0,W,H);
  if(!series || !series.labels?.length) return;
  const n = series.labels.length;
  const win = Math.floor(n/zoom);
  const start = Math.max(0, n - win + offset);
  const end = Math.min(n, start + win);
  const L = series.labels.slice(start,end);
  const LO = series.low.slice(start,end);
  const HI = series.high.slice(start,end);
  const VO = series.vol.slice(start,end);
  const vals = [...LO, ...HI].filter(v=>v!=null);
  let vmin = Math.min(...vals), vmax = Math.max(...vals);
  if(vmin===vmax){ vmin-=1; vmax+=1; }
  // Axes and grid...
  // (keep similar as before, but adjust font sizes to 12px for labels)
  ctx.font="12px Segoe UI, Arial";
  // Draw series...
  // (keep)
  // Buy/sell lines...
  // (keep)
  // Indicators...
  // (keep, with color vars)
  // Volume...
  // (keep)
  // VP...
  // (keep)
  // Labels...
  // (keep, with smaller font)
  // Tooltip...
  // (keep)
}

/* Set Item */
async function setItem(m){
  selected=m; $("#query").value=m.name;
  $("#itemImg").src = bigIconUrl(m.id);
  $("#itemImg").style.display = 'block';
  latest = await loadLatest();
  volumes= await loadVolumes();
  const stepMap = {"1d":"5m", "1w":"1h", "1m":"6h", "6m":"6h", "1y":"24h", "5y":"24h", "all":"24h"};
  const ts = await loadTS(stepMap[view], m.id);
  currentSeries = seriesFromTS(ts);
  resizeCanvas();
}

/* Boot */
(async function boot(){
  mapping = await loadMapping();
  // ... (keep autocomplete, views, tools, mode toggle, add indicator, refresh)
  // Initial
  latest = await loadLatest();
  volumes = await loadVolumes();
  const defaultItem = mapping.find(x=>x.name.toLowerCase()==="gilded scimitar");
  if(defaultItem) setItem(defaultItem);
  resizeCanvas();
})(); 
</script>
</body>
</html>