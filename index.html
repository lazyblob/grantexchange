<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=5.0, user-scalable=yes"/>
<title>Grant Exchange - OSRS Charting Tool</title>
<meta name="description" content="Advanced charting tool for OSRS Grand Exchange items with indicators like Ichimoku Cloud, Volume Profile, and Volume. Analyze trends from 1 day to 5 years.">
<meta name="keywords" content="OSRS Grand Exchange, OSRS GE, RuneScape Grand Exchange, OSRS charting, OSRS price charts, OSRS indicators, Ichimoku Cloud OSRS, Volume Profile OSRS">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://grantexchange.net/">
<!-- Open Graph -->
<meta property="og:title" content="Grant Exchange - OSRS Charting Tool">
<meta property="og:description" content="Advanced charting tool for OSRS Grand Exchange items with indicators like Ichimoku Cloud, Volume Profile, and Volume. Analyze trends from 1 day to 5 years.">
<meta property="og:image" content="https://oldschool.runescape.wiki/images/Gilded_scimitar.png">
<meta property="og:url" content="https://grantexchange.net/">
<meta property="og:type" content="website">
<!-- Favicon -->
<link rel="icon" type="image/png" sizes="48x48" href="https://oldschool.runescape.wiki/images/Gilded_scimitar.png">
<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Grant Exchange - OSRS Charting Tool">
<meta name="twitter:description" content="Advanced charting tool for OSRS Grand Exchange items with indicators like Ichimoku Cloud, Volume Profile, and Volume. Analyze trends from 1 day to 5 years.">
<meta name="twitter:image" content="https://oldschool.runescape.wiki/images/Gilded_scimitar.png">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Grant Exchange - OSRS Charting Tool",
  "url": "https://grantexchange.net/",
  "description": "Advanced charting tool for OSRS Grand Exchange items with indicators like Ichimoku Cloud, Volume Profile, and Volume. Analyze trends from 1 day to 5 years.",
  "applicationCategory": "Game",
  "operatingSystem": "Web",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  }
}
</script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-43YM2RCX1R"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-43YM2RCX1R');
</script>
<!-- CSS -->
<style>
:root{
  --bg:#1b140a; --panel:#2b2110; --edge:#6a4f2b;
  --gold:#cfb36a; --orange:#f0a020; --ink:#eee5cf; --muted:#cbbf99;
  --low-color:#fb6a6a; --high-color:#5cc76a; --grid:#3b2f19; --accent:#ffce4f; --shadow:#0b0703;
  --teal: #00ffff;
  --ichi-tenkan: #069af3; --ichi-kijun: #ec2b88; --ichi-chikou: #22b14c;
  --ichi-senkou-a: #a1d8a0; --ichi-senkou-b: #d8a0a6;
  --cloud-green: rgba(161,216,160,0.2); --cloud-red: rgba(216,160,166,0.2);
}
* {box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:radial-gradient(1200px 600px at 20% -10%,#2b2210 0%,#1b140a 60%),#1b140a;
  color:var(--ink);
  font-family:Segoe UI,Inter,system-ui,Arial;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
/* Layout */
.wrap{max-width:1280px;margin:18px auto;padding:0 7px; min-height: calc(100vh - 36px);
  display:grid;grid-template-columns:1fr;gap:16px;align-items:start}
.header{grid-column:1 / -1;display:grid;
  grid-template-columns:1fr auto auto;gap:12px;align-items:center}
/* Branding */
h1{margin:0;font-size:26px;font-weight:900;color:var(--orange);text-shadow:0 1px 0 #000;cursor:pointer}
.badge{font-size:12px;border:1px solid var(--edge);border-radius:999px;
  padding:2px 8px;color:var(--muted);background:#20190e}
.small{font-size:12px;color:var(--muted)}
.status-error{color:#ffb4b4}
/* Cards */
.card{background:linear-gradient(180deg,#2d220f 0%, #241b0c 100%);
  border:1px solid var(--edge);border-radius:16px;padding:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.28)}
.left{display:flex;flex-direction:column}
.hr{border:none;border-top:1px solid var(--edge);margin:10px 0}
/* Main grid: image / search / stats */
.grid{display:grid;grid-template-columns:240px 1fr 260px;
  gap:14px;align-items:center}
.imgbox{
  width:240px;height:240px;border:1px solid var(--edge);
  border-radius:14px;background:#22180b;
  display:flex;align-items:center;justify-content:center;
  box-shadow:inset 0 0 0 1px #151008,0 8px 18px rgba(0,0,0,.25) }
.imgbox img{width:100%;height:100%;object-fit:contain;image-rendering:pixelated}
/* Search */
.label{font-size:26px;color:var(--orange);font-weight:900;margin-bottom:0}
.sbar{display:flex;gap:10px;margin-top:2px;position:relative}
.sbar input{
  flex:1;background:#1e170c;border:3px solid var(--edge);color:var(--ink);
  border-radius:14px;padding:16px;font-size:20px;outline:none;
  box-shadow:0 0 0 0 rgba(240,160,32,0);transition:box-shadow .18s,border-color .18s }
.sbar input:focus{border-color:var(--orange);
  box-shadow:0 0 0 4px rgba(240,160,32,0.25)}
.sbar button{
  background:#2b2212;border:1px solid var(--edge);color:var(--gold);
  border-radius:12px;padding:12px 16px;cursor:pointer;font-size:15px;
  text-transform:uppercase;letter-spacing:.5px;transition:box-shadow .18s,border-color .18s }
.sbar button:focus{border-color:var(--orange);
  box-shadow:0 0 0 4px rgba(240,160,32,0.25)}
.suggest{margin-top:6px;border:1px solid var(--edge);border-radius:10px;
  max-height:360px;overflow:auto;background:#231b0d;position:absolute;z-index:10;width: calc(100% - 90px); left:0;}
.suggest::-webkit-scrollbar {width:8px; background:var(--panel);}
.suggest::-webkit-scrollbar-thumb {background:var(--edge); border-radius:4px;}
.suggest div{display:flex;align-items:center;gap:6px;
  padding:8px 10px;border-bottom:1px solid #3e3119;cursor:pointer; word-break: break-word; white-space: normal; word-wrap: break-word;}
.suggest div:hover{background:#2d220f}
.suggest img{width:20px;height:20px;image-rendering:pixelated}
/* Stats */
.title{font-size:15px;letter-spacing:.3px;
  text-transform:uppercase;margin-bottom:4px}
.title.low{color:var(--low-color)}
.title.high{color:var(--high-color)}
.big-buy{font-size:36px;font-weight:900;color:var(--low-color)}
.big-sell{font-size:36px;font-weight:900;color:var(--high-color)}
.kv{display:flex;justify-content:space-between;margin:5px 0}
.kv strong.spread{font-size:24px;animation: rainbow 5s linear infinite;}
.kv .price-adjust{display:flex;align-items:center;gap:5px;border:1px solid var(--edge);padding:8px;border-radius:8px;background:#2b2212}
.kv .price-adjust button{padding:0 5px;font-size:24px;font-weight:bold;color:var(--gold);background:transparent;border:none;cursor:pointer;}
.kv .price-adjust.low button{color:var(--low-color)}
.kv .price-adjust.high button{color:var(--high-color)}
.kv .price-adjust span{font-size:24px;font-weight:bold}
.kv .price-adjust.low span{color:var(--low-color)}
.kv .price-adjust.high span{color:var(--high-color)}
.kv .price-input{width:140px; text-align:center; font-size:24px; background:transparent; border:none; color:var(--gold)}
.kv .buy-limit-input{width:140px; text-align:center; font-size:24px; background:transparent; border:none; color:var(--gold)}
/* Tabs + Tools */
.viewtabs, .mode-pill {display:flex;gap:6px;}
.viewtabs button, .mode-pill button{background:#2b2212;border:1px solid var(--edge);
  color:var(--ink);border-radius:10px;padding:6px 10px;
  cursor:pointer;text-transform:uppercase;font-weight: bold; font-size: 14px;transition:box-shadow .18s,border-color .18s}
.viewtabs button.active, .mode-pill button.active{background:#3a2f17; box-shadow: 0 0 10px rgba(240,160,32,0.8);border-color:var(--orange)}
.viewtabs button:focus, .mode-pill button:focus{border-color:var(--orange);
  box-shadow:0 0 0 4px rgba(240,160,32,0.25)}
.tools{display:flex;gap:6px;align-items:center;margin-top:6px}
.tools button{background:#2b2212;border:1px solid var(--edge);
  color:var(--ink);border-radius:10px;padding:5px 9px;cursor:pointer;
  text-transform:uppercase;font-weight: bold; font-size: 14px;transition:box-shadow .18s,border-color .18s}
.tools button.active{background:#3a2f17; box-shadow: 0 0 10px rgba(240,160,32,0.8);border-color:var(--orange)}
.tools button:focus{border-color:var(--orange);
  box-shadow:0 0 0 4px rgba(240,160,32,0.25)}
/* Chart */
.chartWrap{position:relative}
.chart{
  width:100%;height:500px;
  background:repeating-linear-gradient(to bottom,
    rgba(255,255,255,0.03),rgba(255,255,255,0.03) 1px,
    transparent 1px,transparent 24px),#181208;
  border:1px solid var(--edge);border-radius:12px }
.chart-tip{
  position:absolute;display:none;background:rgba(0,0,0,.85);
  color:#fff;padding:6px 8px;border-radius:6px;font-size:12px;
  pointer-events:none;white-space:nowrap;border:1px solid #000 }
.legend{display:flex;gap:12px;font-size:12px;margin-top:6px;color:var(--muted)}
.legend .sell::before{content:"";display:inline-block;width:14px;height:3px;
  background:var(--low-color);margin-right:6px;border-radius:2px}
.legend .buy::before{content:"";display:inline-block;width:14px;height:3px;
  background:var(--high-color);margin-right:6px;border-radius:2px}
/* Refresh button glow */
.refreshRow{display:flex;align-items:center;gap:12px;margin:6px 0}
.btn-refresh{
  padding:12px 20px;border-radius:18px;border:2px solid var(--edge);
  background:linear-gradient(180deg,#3a2f17 0%,#2b2212 100%);
  color:var(--gold);font-weight:900;cursor:pointer;font-size:16px;
  text-transform:uppercase;letter-spacing:.5px;
  box-shadow:0 4px 12px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.5);
  transition:transform .08s ease,filter .12s ease,box-shadow .12s ease }
.btn-refresh:hover{filter:brightness(1.05);
  transform:translateY(-1px);
  box-shadow:0 6px 16px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.5)}
.btn-refresh:active{transform:translateY(0);
  box-shadow:0 2px 8px rgba(0,0,0,.2), inset 0 1px 0 rgba(255,255,255,.5)}
.btn-refresh.loading {
  animation: pulse-rs 1.5s infinite;
}
@keyframes pulse-rs {
  0% { box-shadow: 0 0 0 0 rgba(240,160,32,0.7); }
  70% { box-shadow: 0 0 0 10px rgba(240,160,32,0); }
  100% { box-shadow: 0 0 0 0 rgba(240,160,32,0); }
}
/* Rainbow spread */
@keyframes rainbow {
  0% {border-color: #ff0000;}
  14% {border-color: #ff7f00;}
  28% {border-color: #ffff00;}
  42% {border-color: #00ff00;}
  57% {border-color: #00ffff;}
  71% {border-color: #0000ff;}
  85% {border-color: #8b00ff;}
  100% {border-color: #ff0000;}
}
.sbar {
  position: relative; /* Anchor dropdown to this container */
}
.suggest { /* Matches your existing class */
  position: absolute;
  left: 0;
  top: 100%; /* Drops directly below the input */
  width: 100%; /* Matches search bar width */
  z-index: 10;
  background: #231b0d; /* Matches your theme */
  border: 1px solid var(--edge);
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  overflow: auto;
  max-height: 200px; /* Optional: scroll if many results */
}
/* Suggestion box */
.suggest-box .item{display:flex;align-items:center;gap:10px;padding:10px;background:#2d220f;border:1px solid var(--edge);border-radius:10px;cursor:pointer;position:relative}
.suggest-box img{width:100px;height:100px;image-rendering:pixelated}
.suggest-box .details{flex:1}
.suggest-box .name{font-weight:700;color:var(--orange)}
.suggest-box .prices{display:flex;gap:20px}
.suggest-box .price label{color:var(--muted);font-size:12px}
.suggest-box .price strong{display:block;font-size:16px}
.suggest-box .buy strong{color:var(--low-color)}
.suggest-box .sell strong{color:var(--high-color)}
.suggest-box .margin strong{color:var(--gold)}
.suggest-box .next-btn{background:#2b2212;border:1px solid #ff0000;color:var(--gold);
  border-radius:12px;padding:8px 12px;cursor:pointer;font-size:16px;font-weight:bold;
  text-transform:uppercase;letter-spacing:.5px;margin-top:10px;animation: rainbow 5s linear infinite}
.suggest-box .good-deal{position:absolute;top:10px;right:10px;background:#ff0000;color:#fff;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold}
.suggest-box .kv span{margin-right:5px}
/* Category select */
select{background:#1e170c;border:3px solid var(--edge);color:var(--ink);border-radius:14px;padding:8px;font-size:16px;outline:none;width:100%;margin-bottom:8px;transition:box-shadow .18s,border-color .18s}
select:focus{border-color:var(--orange);box-shadow:0 0 0 4px rgba(240,160,32,0.25)}
/* Loading animation */
.loading { animation: pulse-rs 1.5s infinite; }
@keyframes pulse-rs {
  0% { box-shadow: 0 0 0 0 rgba(240,160,32,0.7); }
  70% { box-shadow: 0 0 0 10px rgba(240,160,32,0); }
  100% { box-shadow: 0 0 0 0 rgba(240,160,32,0); }
}
/* Small chart */
.small-chart { width: 100%; height: 2in; margin-bottom: 10px; background: var(--grid); border:1px solid var(--edge); border-radius:8px; }
/* Card-like for small chart */
.card-like {background:linear-gradient(180deg,#2d220f 0%, #241b0c 100%);
  border:1px solid var(--edge);border-radius:16px;padding:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.28)}
.spread-margin { font-size: 18px; color: var(--teal); text-align: center; margin: 10px 0; }
/* Loader overlay */
#loader-overlay { 
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: 100%; 
  background: rgba(0, 0, 0, 0.8); 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  z-index: 1000; 
  flex-direction: column; 
  color: var(--ink); 
  font-size: 18px; 
}
.loader-wheel { 
  border: 8px solid var(--edge); 
  border-top: 8px solid var(--orange); 
  border-radius: 50%; 
  width: 60px; 
  height: 60px; 
  animation: spin 2s linear infinite; 
  margin-bottom: 20px; 
}
@keyframes spin { 
  0% { transform: rotate(0deg); } 
  100% { transform: rotate(360deg); } 
}
/* Tabs for bottom section */
.help-tabs { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
.help-tabs button { background: #2b2212; border: 1px solid var(--edge); color: var(--ink); border-radius: 10px; padding: 8px 14px; cursor: pointer; text-transform: uppercase; font-weight: bold; font-size: 14px; transition: box-shadow .18s, border-color .18s; }
.help-tabs button.active { background: #3a2f17; box-shadow: 0 0 10px rgba(240,160,32,0.8); border-color:var(--orange); }
.help-tab-content { display: none; }
.help-tab-content.active { display: block; }
/* Alch table (tighter) */
.alch-tb, .sets-tb, .craft-tb, .enchant-tb, .smith-tb { display: flex; flex-direction: column; gap: 6px; overflow: auto; max-height: 500px; }
.alch-tb::-webkit-scrollbar, .sets-tb::-webkit-scrollbar, .craft-tb::-webkit-scrollbar, .enchant-tb::-webkit-scrollbar, .smith-tb::-webkit-scrollbar { width: 8px; background: var(--panel); }
.alch-tb::-webkit-scrollbar-thumb, .sets-tb::-webkit-scrollbar-thumb, .craft-tb::-webkit-scrollbar-thumb, .enchant-tb::-webkit-scrollbar-thumb, .smith-tb::-webkit-scrollbar-thumb { background: var(--edge); border-radius: 4px; }
.alch-row, .sets-row, .craft-row, .enchant-row, .smith-row { display: grid; gap: 12px; align-items: center; background: #231b0d; border: 1px solid var(--edge); border-radius: 10px; padding: 12px 16px; }
.alch-row { grid-template-columns: 40px 1fr 120px 120px 120px 140px; }
.sets-row { grid-template-columns: 1fr 120px 120px 120px 1fr; } /* Added column for pieces */
.craft-row { grid-template-columns: 40px 1fr 80px 80px 120px 120px; }
.enchant-row { grid-template-columns: 40px 1fr 80px 1fr 1fr 80px 120px; }
.smith-row { grid-template-columns: 40px 1fr 80px 80px 120px 120px; }
.alch-row img, .sets-row img, .craft-row img, .enchant-row img, .smith-row img { width: 32px; height: 32px; image-rendering: pixelated; cursor: pointer; }
.alch-sym, .sets-sym, .craft-sym, .enchant-sym, .smith-sym { font-weight: 700; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
.alch-buy, .alch-nat, .alch-value, .alch-profit, .sets-buy, .sets-sell, .sets-profit, .craft-level, .craft-exp, .craft-buy, .craft-profit, .enchant-level, .enchant-base, .enchant-enchanted, .enchant-runes, .enchant-exp, .enchant-profit, .smith-bars, .smith-level, .smith-exp, .smith-alch, .smith-profit { font-variant-numeric: tabular-nums; text-align: right; color: var(--gold); }
.alch-profit.positive, .sets-profit.positive, .craft-profit.positive, .enchant-profit.positive, .smith-profit.positive { color: var(--high-color); }
.alch-profit.negative, .sets-profit.negative, .craft-profit.negative, .enchant-profit.negative, .smith-profit.negative { color: var(--low-color); }
/* Desktop scaling */
@media (min-width: 769px) {
  html {
    transform: scale(0.8); /* Scale everything to 80% */
    transform-origin: top left; /* Anchor scaling from top-left to avoid centering issues */
    width: 125%; /* Compensate for scaling by increasing width (100% / 0.8 = 125%) */
    height: 125%; /* Same for height */
  }
}
/* Mobile Responsiveness */
@media (max-width: 768px) {
  body {
    overflow-x: hidden;
  }
  .wrap {
    grid-template-columns: 1fr; /* Stack sidebar below main content */
    padding: 0 8px; /* Compact padding */
    gap: 10px; /* Reduced gap for modern, tight layout */
    max-width: 100%;
    margin: 10px auto;
  }
  .grid {
    display: grid;
    grid-template-columns: 1fr;
    grid-template-rows: auto auto auto;
    gap: 8px; /* Smaller gaps */
    align-items: start; /* Top align */
  }
  .imgbox { 
    grid-column: 1;
    grid-row: 1;
    width: 80px; /* Smaller image to compact */
    height: 80px;
    margin: 0; /* Left align, no margin */
    justify-self: start;
    order: 1;
  }
  .imgbox img { 
    width: 100%; 
    height: 100%; 
    object-fit: contain; 
    cursor: pointer; /* Clickable for item search focus */
  }
  .grid > div:nth-child(2) { /* Search/profit right of image, top row */
    grid-column: 1;
    grid-row: 2;
    order: 2;
    display: flex;
    flex-direction: column;
    gap: 2px; /* Tighter */
  }
  .grid > div:nth-child(3) { /* Smart prices right of image, bottom row */
    grid-column: 1;
    grid-row: 3;
    order: 3;
    display: flex;
    flex-direction: column;
    gap: 2px; /* Tighter gaps between rows/columns */
    background: #231b0d; /* Dark bg for panel feel */
    border: 1px solid var(--edge); /* Border for definition */
    border-radius: 10px; /* Rounded */
    padding: 4px; /* Reduced inner padding */
  }
  .label { 
    font-size: 16px; /* Smaller label */
    margin: 0; 
  }
  .sbar input { 
    font-size: 14px; /* Smaller input */
    padding: 8px; 
  }
  .kv { 
    display: flex; 
    flex-direction: row; /* Keep row for better space use */
    justify-content: space-between; 
    align-items: center; 
    margin: 2px 0; /* Even tighter margins */
    font-size: 12px; /* Smaller font for info */
  }
  .kv span { 
    flex: 1; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
  }
  .kv strong { 
    flex: 1; 
    text-align: right; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    font-size: 14px; /* Slightly larger for numbers */
  }
  #flipProfitLabel, #capitalRequired, #buyLimitInfo, #spreadMargin { 
    font-size: 12px; /* Compact text */ 
  }
  #spreadMargin { 
    text-align: left; 
    margin: 2px 0; 
  }
  .small { 
    font-size: 10px; /* Smaller buy limit info */ 
  }
  .title { 
    font-size: 12px; /* Smaller titles */ 
    margin: 0; /* No margins for tight fit */ 
    text-align: left; /* Left align for flow */ 
  }
  .price-adjust { 
    flex-direction: row; /* Arrows on sides of value, same line */ 
    align-items: center; 
    gap: 2px; /* Very tight gaps between arrows and input */ 
    border: none; /* Remove inner borders if too busy */ 
    background: transparent; /* Clean look */ 
    justify-content: flex-start; /* Left align */ 
  }
  .price-input, .buy-limit-input { 
    flex: 1; 
    font-size: 14px; /* Smaller text size for values */ 
    text-align: right; /* Right align numbers */ 
    width: auto; /* Auto width to fit */ 
    max-width: none; /* Remove max-width to handle long numbers */ 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
  }
  .price-adjust button { 
    font-size: 16px; /* Smaller arrows */ 
    padding: 0 4px; 
    min-width: 24px; 
  }
  .chart { 
    height: 280px; /* Slightly shorter for compact view */ 
  }
  .side { 
    display: grid; 
    grid-template-columns: 1fr 1fr; /* Side-by-side for suggestion and 1-year chart */ 
    gap: 8px; 
  }
  .side .suggest-box, .side .card-like { 
    grid-column: span 1; /* Each takes half */ 
    padding: 8px; /* Narrower padding */ 
    max-width: 100%; /* Fit to mobile */ 
  }
  .side .card-like { 
    order: -1; 
  }
  .side .card:nth-child(3) { /* Watchlist card full width */ 
    grid-column: 1 / -1; /* Span both columns for full width */ 
    padding: 8px; /* Narrower */ 
  }
  .suggest-box .item { 
    flex-direction: column; /* Stack for narrow fit */ 
    gap: 4px; 
    padding: 6px; 
  }
  .suggest-box img { 
    width: 60px; 
    height: 60px; 
    margin: 0 auto; 
  }
  .suggest-box .details { 
    text-align: center; 
  }
  .suggest-box .prices { 
    justify-content: center; 
    gap: 10px; 
  }
  .suggest-box .price strong { 
    font-size: 14px; 
  }
  .suggest-box .next-btn { 
    font-size: 12px; 
    padding: 4px 8px; 
  }
  .card-like { 
    padding: 8px; 
  }
  .card-like h3 { 
    font-size: 14px; 
  }
  .small-chart { 
    height: 200px; 
  }
  .tb { 
    max-height: 350px; /* Slightly shorter */ 
  }
  .head { 
    grid-template-columns: 20px 1fr 50px 50px; /* Narrower columns for watchlist */ 
    font-size: 10px; 
    gap: 4px; 
    padding: 4px 6px; 
  }
  .row { 
    grid-template-columns: 20px 1fr 50px 50px; 
    padding: 6px; 
    gap: 4px; 
    min-height: 30px; 
  }
  .row.long-price { 
    min-height: 50px; 
  }
  .sym { 
    font-size: 12px; 
  }
  .delta, .vol { 
    font-size: 10px; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
  }
  .alch-tb .head, .sets-tb .head, .craft-tb .head, .enchant-tb .head, .smith-tb .head { 
    grid-template-columns: 30px 1fr 50px 50px 50px 60px; 
    gap: 4px; 
    padding: 4px 6px; 
    font-size: 10px; 
  }
  .alch-row, .sets-row, .craft-row, .enchant-row, .smith-row { 
    grid-template-columns: 30px 1fr 50px 50px 50px 60px; 
    gap: 4px; 
    padding: 6px; 
  }
  .alch-sym, .alch-value, .alch-buy, .alch-nat, .alch-profit, .sets-sym, .sets-buy, .sets-sell, .sets-profit, .craft-sym, .craft-level, .craft-exp, .craft-buy, .craft-profit, .enchant-sym, .enchant-level, .enchant-base, .enchant-enchanted, .enchant-runes, .enchant-exp, .enchant-profit, .smith-sym, .smith-bars, .smith-level, .smith-exp, .smith-alch, .smith-profit { 
    font-size: 10px; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
  }
  .sbar { gap: 5px; }
  .sbar input { padding: 12px; font-size: 16px; }
  .sbar button { padding: 8px 12px; font-size: 14px; }
  .viewtabs, .mode-pill { gap: 3px; }
  .viewtabs button, .mode-pill button { padding: 4px 8px; font-size: 12px; }
  .tools { gap: 3px; }
  .tools button { padding: 3px 6px; font-size: 12px; }
  .refreshRow { gap: 5px; }
  .btn-refresh, .btn-watch { padding: 8px 12px; font-size: 14px; }
  .help-tabs button { padding: 6px 10px; font-size: 12px; }
  .side h3 { font-size: 16px; }
  .suggest-box .item { padding: 5px; gap: 5px; }
  .suggest-box img { width: 80px; height: 80px; }
  .suggest-box .name { font-size: 14px; }
  .suggest-box .prices { gap: 10px; }
  .suggest-box .price label { font-size: 10px; }
  .suggest-box .price strong { font-size: 14px; }
  .next-btn { padding: 6px 10px; font-size: 14px; }
  .card-like h3 { font-size: 16px; }
  .card { padding: 8px; }
  select { padding: 6px; font-size: 14px; }
  .help h2 { font-size: 18px; }
  .help p { font-size: 12px; }
  .help ul { margin: 4px 0 0 14px; }
  .kv { margin: 2px 0; }
  .kv strong { font-size: 18px; }
  .spread-margin { font-size: 16px; }
  #chart, #historicalChart { width: 100% !important; }
  .chartWrap { overflow-x: hidden; }
  /* Themed Up/Down Arrows */
  .price-adjust button { 
    background: linear-gradient(180deg, #3a2f17 0%, #2b2212 100%); /* Gradient like refresh button */
    border: 2px solid var(--edge); /* Thicker border for emphasis */
    border-radius: 12px; /* More rounded */
    padding: 2px 8px; /* Smaller padding */
    font-size: 18px; /* Slightly smaller text/symbols */
    font-weight: 900; /* Max bold */
    color: var(--gold); /* Gold base, overridden for low/high */
    cursor: pointer; 
    transition: box-shadow .18s, transform .08s, filter .12s; /* Add brightness hover */
    box-shadow: 0 2px 6px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.3); /* Depth shadow */
    text-shadow: 0 1px 2px rgba(0,0,0,0.5); /* Shadow for better visibility on dark bg */
    line-height: 1; /* Tight line height */
    min-width: 32px; /* Smaller minimum width */
    display: flex; 
    align-items: center; 
    justify-content: center; 
  }
  .price-adjust button.down::before { 
    content: "▽"; /* Tip-only down arrow (no tail) */ 
  }
  .price-adjust button.up::before { 
    content: "△"; /* Tip-only up arrow (no tail) */ 
  }
  .price-adjust button { 
    content: ""; /* Clear original text */ 
  }
  .price-adjust button:hover { 
    box-shadow: 0 4px 12px rgba(240,160,32,0.6); /* Stronger orange glow */ 
    transform: translateY(-2px); /* More lift */ 
    filter: brightness(1.1); /* Brighter on hover */ 
  }
  .price-adjust button:active { 
    transform: translateY(0); /* Press down effect */ 
    box-shadow: 0 1px 4px rgba(0,0,0,.2), inset 0 1px 0 rgba(255,255,255,.3); 
  }
  .price-adjust.low button { 
    color: var(--low-color); /* Red for low arrows */ 
  }
  .price-adjust.high button { 
    color: var(--high-color); /* Green for high arrows */ 
  }
  /* Themed Color Selectors */
  .color-picker { 
    display: flex; 
    align-items: center; 
    gap: 4px; 
    background: #2b2212; /* Dark panel bg */ 
    border: 1px solid var(--edge); /* Edge border */ 
    border-radius: 8px; 
    padding: 4px 8px; 
    color: var(--muted); /* Muted label text */ 
  }
  .color-picker input[type="color"] { 
    -webkit-appearance: none; /* Remove default styling */ 
    appearance: none; 
    width: 24px; /* Small square */ 
    height: 24px; 
    border: none; /* No border */ 
    background: transparent; /* Transparent bg */ 
    cursor: pointer; 
  }
  .color-picker input[type="color"]::-webkit-color-swatch-wrapper { 
    padding: 0; 
  }
  .color-picker input[type="color"]::-webkit-color-swatch { 
    border: 1px solid var(--edge); /* Theme border */ 
    border-radius: 4px; /* Rounded */ 
  }
  .color-picker input[type="color"]::-moz-color-swatch { 
    border: 1px solid var(--edge); /* Firefox compat */ 
    border-radius: 4px; 
  }
  @keyframes glow { 
    from { box-shadow: 0 0 5px #00ff00; } 
    to { box-shadow: 0 0 15px #00ff00; } 
  }
  h1 { font-size: 20px; }
  h3 { font-size: 16px; }
  .label { font-size: 20px; }
  .help { font-size: 14px; }
  .chart { height: 200px; }
  .tb { max-height: 200px; }
  .small-chart { height: 120px; }
  .suggest { width: 100%; }
  .head { 
    grid-template-columns: 22px 1fr 60px 60px; 
    font-size: 10px; 
  }
  .row { 
    grid-template-columns: 22px 1fr 60px 60px; 
    padding: 8px; 
    gap: 4px; 
  }
  .sym { 
    font-size: 13px; 
  }
  .last, .delta, .pct, .vol { 
    font-size: 12px; 
  }
  .alch-tb .head { 
    grid-template-columns: 32px 1fr 60px 60px 60px 70px; 
    gap: 6px; 
    padding: 6px 8px; 
    font-size: 10px; 
  }
  .alch-row { 
    grid-template-columns: 32px 1fr 60px 60px 60px 70px; 
    gap: 6px; 
    padding: 8px 8px; 
  }
  .alch-sym, .alch-value, .alch-buy, .alch-nat, .alch-profit { 
    font-size: 12px; 
  }
  .sbar { gap: 5px; }
  .sbar input { padding: 12px; font-size: 16px; }
  .sbar button { padding: 8px 12px; font-size: 14px; }
  .viewtabs, .mode-pill { gap: 3px; }
  .viewtabs button, .mode-pill button { padding: 4px 8px; font-size: 12px; }
  .tools { gap: 3px; }
  .tools button { padding: 3px 6px; font-size: 12px; }
  .refreshRow { gap: 5px; }
  .btn-refresh, .btn-watch { padding: 8px 12px; font-size: 14px; }
  .help-tabs button { padding: 6px 10px; font-size: 12px; }
  .side h3 { font-size: 16px; }
  .suggest-box .item { padding: 5px; gap: 5px; }
  .suggest-box img { width: 80px; height: 80px; }
  .suggest-box .name { font-size: 14px; }
  .suggest-box .prices { gap: 10px; }
  .suggest-box .price label { font-size: 10px; }
  .suggest-box .price strong { font-size: 14px; }
  .next-btn { padding: 6px 10px; font-size: 14px; }
  .card-like h3 { font-size: 16px; }
  .card { padding: 8px; }
  select { padding: 6px; font-size: 14px; }
  .help h2 { font-size: 18px; }
  .help p { font-size: 12px; }
  .help ul { margin: 4px 0 0 14px; }
  .kv { margin: 2px 0; }
  .kv strong { font-size: 18px; }
  .spread-margin { font-size: 16px; }
  #chart, #historicalChart { width: 100% !important; }
  .chartWrap { overflow-x: hidden; }
}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div><h1 onclick="location.reload();">Grant Exchange</h1><span class="badge">v3.0</span> <span class="badge">OSRS Charts</span></div>
    <div id="status" class="small">Ready</div>
    <div style="display:flex;gap:10px;align-items:center">
      <div class="mode-pill" id="modePill">
        <button data-mode="f2p" id="btnF2P" class="active">F2P</button>
        <button data-mode="members" id="btnMembers">Members</button>
      </div>
    </div>
  </div>
  <!-- Main panel -->
  <div class="card left">
    <div class="grid">
      <!-- Large item image -->
      <div class="imgbox"><img id="itemImg" alt="Item"/></div>
      <!-- Search column -->
      <div>
        <div class="label">What item?</div>
        <div class="sbar">
          <input id="query" placeholder="Type here… e.g., Uncut diamond" autocomplete="off"/>
          <div id="suggestBox" class="suggest" style="display:none"></div>
        </div>
        <div class="kv" style="margin-top:4px"><span id="flipProfitLabel">Expected Flip Profit</span><strong id="flipProfit" style="color:var(--gold);font-size:20px">—</strong></div>
        <div class="kv" style="margin-top:12px"><span>Capital Required</span><strong id="capitalRequired" style="color:var(--gold);font-size:20px">—</strong></div>
        <div class="small" id="buyLimitInfo"></div>
        <div id="spreadMargin" class="spread-margin">1h Spread: —</div>
      </div>
      <!-- Smart prices -->
      <div>
        <div class="title low">Smart Low Buy (Offer)</div>
        <div class="kv price-adjust low"><button onclick="adjustPrice('buy', -1)">↓</button><input id="smartBuyInput" class="price-input" type="text" value="—" onchange="updateSmartBuyFromInput()" /><button onclick="adjustPrice('buy', 1)">↑</button></div>
        <div class="title high" style="margin-top:10px">Smart High Sell (List)</div>
        <div class="kv price-adjust high"><button onclick="adjustPrice('sell', -1)">↓</button><input id="smartSellInput" class="price-input" type="text" value="—" onchange="updateSmartSellFromInput()" /><button onclick="adjustPrice('sell', 1)">↑</button></div>
        <div class="title" style="margin-top:10px">Buy Limit</div>
        <div class="kv price-adjust"><button onclick="adjustBuyLimit(-1)">↓</button><input id="buyLimitDisplay" class="buy-limit-input" type="text" value="—" onchange="updateBuyLimitFromInput()" /><button onclick="adjustBuyLimit(1)">↑</button></div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="refreshRow">
      <div class="viewtabs">
        <button data-view="day" class="active">1D</button>
        <button data-view="week">1W</button>
        <button data-view="month">1M</button>
      </div>
      <div class="tools">
        <span class="small">Zoom:</span><button id="zIn">+</button><button id="zOut">−</button>
        <span class="small" style="margin-left:10px">Mode:</span>
        <button id="lineMode" class="active">Line</button>
        <button id="dotMode">Scatter</button>
        <span class="small" style="margin-left:10px">View:</span>
        <button id="popoutBtn">Popout</button>
      </div>
    </div>
    <div class="chartWrap">
      <canvas id="chart" class="chart" width="980" height="500"></canvas>
      <div id="tip" class="chart-tip"></div>
    </div>
    <div class="legend"><span class="sell">Low (Buy)</span><span class="buy">High (Sell)</span></div>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; gap:10px;">
      <div style="display:flex; gap:10px; align-items:center;">
        <label class="color-picker">Low: <input type="color" id="lowColorPicker" value="#fb6a6a"></label>
        <label class="color-picker">High: <input type="color" id="highColorPicker" value="#5cc76a"></label>
      </div>
      <div style="display:flex; gap:10px;">
        <button id="refreshBtn" class="btn-refresh">Refresh All Data</button>
        <button id="addWatchBtn" class="btn-watch">Add to Watch</button>
      </div>
    </div>
    <div id="itemDesc" class="help" style="margin-top:20px"></div>
  </div> <!-- end .card.left -->
  <!-- Sidebar -->
  <div class="side">
    <div class="card suggest-box">
      <h3 style="margin:0 0 10px;font-size:18px;font-weight:900;color:var(--orange)">Smart Flip Suggestion</h3>
      <div id="smartSuggest" class="item">
        <!-- Filled by JS -->
      </div>
      <div id="suggestProfit" class="kv" style="margin-top:10px"><span>Expected Profit</span><strong style="color:var(--gold);font-size:18px">—</strong></div>
      <button id="nextSuggest" class="next-btn">Next Suggestion</button>
    </div>
    <div class="card card-like">
      <h3 style="margin:0 0 10px;font-size:18px;font-weight:900;color:var(--orange)">1 Year Price Data</h3>
      <canvas id="historicalChart" width="360" height="144"></canvas>
    </div>
    <div class="card">
      <h3>Watchlist</h3>
      <select id="categorySelect">
        <option value="custom">Custom Watchlist</option>
        <option value="gilded">Gilded Items</option>
        <option value="runes">Runes</option>
        <option value="herbs">Herbs</option>
        <option value="food">Food</option>
        <option value="armour">Armour</option>
        <option value="weapons">Weapons</option>
        <option value="gems">Gems</option>
        <option value="ores-and-bars">Ores & Bars</option>
        <option value="charging-items">Charging Items</option>
        <option value="3rd-age-items">3rd Age Items</option>
        <option value="potions">Potions</option>
        <option value="range-armour">Range Armour</option>
        <option value="melee-armour">Melee Armour</option>
        <option value="mage-armour">Mage Armour</option>
        <option value="range-weapons">Range Weapons</option>
        <option value="melee-weapons">Melee Weapons</option>
        <option value="mage-weapons">Mage Weapons</option>
        <option value="ammo">Ammo</option>
      </select>
      <!-- Column headers (tighter) -->
      <div class="head">
        <div></div>
        <div id="sortSymbol">Symbol <span class="sort-arrow">▼</span></div>
        <div class="delta" id="sortBuy">Buy gp <span class="sort-arrow">▼</span></div>
        <div class="vol" id="sortSell">Sell gp <span class="sort-arrow">▼</span></div>
      </div>
      <div id="watch" class="tb"></div>
    </div>
  </div>
  <div class="card left" style="grid-column:1 / -1">
    <div class="help-tabs">
      <button id="faqTab" class="active">FAQ</button>
      <button id="alchTab">High Alch Guide</button>
      <button id="setsTab">Sets</button>
      <button id="craftingTab">Crafting</button>
      <button id="enchantingTab">Enchanting</button>
      <button id="smithingTab">Smithing</button>
      <button id="contactTab">Contact</button>
    </div>
    <div id="faqContent" class="help-tab-content active">
      <div class="help" style="margin-top:20px">
        <h2>Tools for OSRS Grand Exchange and Money Making</h2>
        <p>Our flipping tool provides real-time prices from the OSRS Grand Exchange to help you maximize gold earnings. Designed for both F2P and Members, it offers market data, buy/sell recommendations, and profit tools to streamline your trades. Search for items, fine-tune prices, and track favorites in the watchlist. Ideal for flipping gems, ores, and more based on trends and volumes—enhance your RuneScape experience with efficient gold strategies. Check our <button onclick="switchToAlchTab()">high alch guide</button> for additional earning tips.</p>
        <!-- FAQ -->
        <h2>Common Questions on OSRS GE and Gold Strategies</h2>
        <h3>How Does Item Flipping Work on the OSRS Grand Exchange?</h3>
        <p>Item flipping means purchasing low and selling high for profit. Tips include focusing on high-volume goods like runes or gems for quick turnover. Use our tool to view current spreads and aim for solid returns per trade, considering taxes and limits.</p>
        <ul>
          <li>High-volume items ensure faster transactions.</li>
          <li>Check real-time data to identify profitable opportunities.</li>
          <li>Account for the 1% tax, capped at 5m GP.</li>
          <li>Adhere to buy limits for accurate capital planning.</li>
          <li>Analyze charts for optimal timing.</li>
          <li>Begin with smaller investments in F2P, expand in Members mode.</li>
        </ul>
        <h3>F2P vs. Members Mode for OSRS Money Making?</h3>
        <p>F2P limits to free items, while Members unlocks higher-profit options like herbs. Toggle modes for customized flipping ideas tailored to your playstyle.</p>
        <h3>Are Profit Estimates Reliable for OSRS Gold Making?</h3>
        <p>Calculations use live GE data with tax considerations. Markets fluctuate, so refresh often and monitor your watchlist for updates.</p>
        <h3>How Do Price Alerts Function in the Watchlist?</h3>
        <p>Alerts highlight changes in high prices over five minutes with borders:</p>
        <ul>
          <li>Green glow for +20% or more.</li>
          <li>Green for +10%.</li>
          <li>Cyan for +5%.</li>
          <li>Yellow for -5%.</li>
          <li>Red for -10%.</li>
          <li>Dark red for -20%.</li>
        </ul>
        <p>These signal short-term shifts; large swings are uncommon for stable items like adamant bars.</p>
      </div>
    </div>
    <div id="alchContent" class="help-tab-content">
      <div class="help" style="margin-top:20px">
        <h2>High Alchemy Profit Guide & Calculator for OSRS</h2>
        <p>High alch turns items into gold with the alchemy spell, ideal for passive earnings and Magic training. Purchase below alch value on the GE, cast the spell, and pocket the difference minus rune costs. Our calculator highlights top items with current prices for efficient gold farming.</p>
        <h3>Steps for Profitable High Alch in OSRS</h3>
        <ul>
          <li>Use a fire staff to cut rune expenses.</li>
          <li>Source items and nature runes from the GE.</li>
          <li>Compute profit: alch value minus buy and rune prices.</li>
          <li>Target profitable entries; alch safely near banks.</li>
          <li>F2P shows accessible items; Members expands choices.</li>
        </ul>
        <p>Nature Rune Price: <span id="natPrice">Loading...</span></p>
        <div class="head"> <!-- Header like watchlist -->
          <div></div>
          <div>Item</div>
          <div>Alch Value</div>
          <div>Buy GP</div>
          <div>Nat GP</div>
          <div>Profit/Alch</div>
        </div>
        <div id="alchList" class="alch-tb"></div>
      </div>
    </div>
    <div id="setsContent" class="help-tab-content">
      <div class="help" style="margin-top:20px">
        <h2>Armor Sets Profit Calculator for OSRS</h2>
        <p>Profit by assembling or disassembling sets on the GE, factoring in taxes. This method complements other strategies for steady gold gains.</p>
        <div class="head">
          <div>Set</div>
          <div>Buy Pieces</div>
          <div>Sell Set</div>
          <div>Profit (Pack)</div>
          <div>Pieces</div>
        </div>
        <div id="setsList" class="sets-tb"></div>
      </div>
    </div>
    <div id="craftingTabContent" class="help-tab-content">
      <div class="help" style="margin-top:20px">
        <h2>Crafting Profit Guide for OSRS</h2>
        <p>Craft jewelry from gold bars and gems bought on the GE, then sell for profit after taxes. A reliable approach for skill and gold progression.</p>
        <div class="head">
          <div></div>
          <div>Item</div>
          <div>Level</div>
          <div>Exp</div>
          <div>Buy Cost</div>
          <div>Profit</div>
        </div>
        <div id="craftList" class="craft-tb"></div>
      </div>
    </div>
    <div id="enchantingContent" class="help-tab-content">
      <div class="help" style="margin-top:20px">
        <h2>Enchanting Profit Guide for OSRS</h2>
        <p>Enchant jewelry using GE-sourced bases and runes, selling enchanted versions post-tax. Boosts Magic while generating income.</p>
        <div class="head">
          <div></div>
          <div>Spell</div>
          <div>Level</div>
          <div>Base Item</div>
          <div>Enchanted</div>
          <div>Exp</div>
          <div>Profit</div>
        </div>
        <div id="enchantList" class="enchant-tb"></div>
      </div>
    </div>
    <div id="smithingContent" class="help-tab-content">
      <div class="help" style="margin-top:20px">
        <h2>Smithing Profit Guide (Steel to Rune) for OSRS</h2>
        <p>Smith bars into items for alching or selling, using GE prices. Effective for Smithing levels and gold accumulation.</p>
        <div class="head">
          <div></div>
          <div>Item</div>
          <div>Bars</div>
          <div>Level</div>
          <div>Exp</div>
          <div>Profit (Alch)</div>
        </div>
        <div id="smithList" class="smith-tb"></div>
      </div>
    </div>
    <div id="contactContent" class="help-tab-content">
      <div class="help" style="margin-top:20px">
        <h2>Contact Us</h2>
        <p>Share feature ideas or report issues below.</p>
        <p>The contact form is temporarily unavailable. Email us at example@email.com for assistance.</p>
      </div>
    </div>
  </div>
</div>
<!-- SCRIPT -->
<script>
/* ========== Constants & API ========== */
const $ = s => document.querySelector(s);
const API = "https://prices.runescape.wiki/api/v1/osrs";
let mapping=[], latest=null, volumes=null, selected=null;
let currentSeries=null, view="day", zoom=1.5, offset=0, drawMode="line";
let membersOn=false;
let watchlist = [];
let customWatchlist = [];
let dismissed = [];
let flipSuggestions = [];
let suggestIndex = 0;
let adjustedBuy = null;
let adjustedSell = null;
let buyLimit = 0;
const buyLimits = {}; // Cached buy limits (lazy-loaded from items-json/${id}.json)
const categoryItems = {};
const f2pAlchItems = ['rune pickaxe', 'rune platebody', 'rune kiteshield', 'rune battleaxe', 'rune longsword', 'rune med helm', 'rune 2h sword', 'rune full helm', 'green d\'hide body', 'rune sword', 'rune mace', 'rune platelegs', 'rune plateskirt', 'rune axe', 'rune scimitar', 'adamant platebody', 'rune sq shield', 'rune chainbody', 'mithril kiteshield', 'adamant kiteshield', 'adamant chainbody', 'mithril platebody', 'adamant platelegs', 'Steel platebody', 'rune dagger'];
const membersAlchItems = ['dragon med helm', 'dragon battleaxe', 'dragon platelegs', 'black d\'hide body', 'dragon halberd', 'red d\'hide body', 'dragon scimitar', 'dragon longsword', 'rune halberd', 'dragon dagger', 'rune dagger(p+)', 'rune hasta', 'red d\'hide vambraces', 'dragon plateskirt', ...f2pAlchItems, 'blue d\'hide vambraces', 'combat bracelet', 'mystic water staff', 'mystic gloves', 'black d\'hide vambraces', 'water battlestaff', 'air battlestaff', 'red d\'hide chaps', 'earth battlestaff', 'fire battlestaff', 'diamond bracelet'];
const natRuneId = 561; // Nature rune
const goldBarId = 2357; // Gold bar ID
const armorSets = [{"set_name":"Bronze set (lg)","components":["Bronze platebody","Bronze platelegs","Bronze full helm","Bronze kiteshield"]},{"set_name":"Iron set (lg)","components":["Iron platebody","Iron platelegs","Iron full helm","Iron kiteshield"]},{"set_name":"Steel set (lg)","components":["Steel platebody","Steel platelegs","Steel full helm","Steel kiteshield"]},{"set_name":"Black set (lg)","components":["Black platebody","Black platelegs","Black full helm","Black kiteshield"]},{"set_name":"Mithril set (lg)","components":["Mithril platebody","Mithril platelegs","Mithril full helm","Mithril kiteshield"]},{"set_name":"Adamant set (lg)","components":["Adamant platebody","Adamant platelegs","Adamant full helm","Adamant kiteshield"]},{"set_name":"Rune armour set (lg)","components":["Rune platebody","Rune platelegs","Rune full helm","Rune kiteshield"]},{"set_name":"Dragon armour set (lg)","components":["Dragon platebody","Dragon platelegs","Dragon full helm","Dragon kiteshield"]},{"set_name":"Bronze gold-trimmed set (lg)","components":["Bronze platebody (g)","Bronze platelegs (g)","Bronze full helm (g)","Bronze kiteshield (g)"]},{"set_name":"Iron gold-trimmed set (lg)","components":["Iron platebody (g)","Iron platelegs (g)","Iron full helm (g)","Iron kiteshield (g)"]},{"set_name":"Steel gold-trimmed set (lg)","components":["Steel platebody (g)","Steel platelegs (g)","Steel full helm (g)","Steel kiteshield (g)"]},{"set_name":"Black gold-trimmed set (lg)","components":["Black platebody (g)","Black platelegs (g)","Black full helm (g)","Black kiteshield (g)"]},{"set_name":"Mithril gold-trimmed set (lg)","components":["Mithril platebody (g)","Mithril platelegs (g)","Mithril full helm (g)","Mithril kiteshield (g)"]},{"set_name":"Adamant gold-trimmed set (lg)","components":["Adamant platebody (g)","Adamant platelegs (g)","Adamant full helm (g)","Adamant kiteshield (g)"]},{"set_name":"Rune gold-trimmed set (lg)","components":["Rune platebody (g)","Rune platelegs (g)","Rune full helm (g)","Rune kiteshield (g)"]},{"set_name":"Gilded armour set (lg)","components":["Gilded platebody","Gilded platelegs","Gilded full helm","Gilded kiteshield"]},{"set_name":"Bronze trimmed set (lg)","components":["Bronze platebody (t)","Bronze platelegs (t)","Bronze full helm (t)","Bronze kiteshield (t)"]},{"set_name":"Iron trimmed set (lg)","components":["Iron platebody (t)","Iron platelegs (t)","Iron full helm (t)","Iron kiteshield (t)"]},{"set_name":"Steel trimmed set (lg)","components":["Steel platebody (t)","Steel platelegs (t)","Steel full helm (t)","Steel kiteshield (t)"]},{"set_name":"Black trimmed set (lg)","components":["Black platebody (t)","Black platelegs (t)","Black full helm (t)","Black kiteshield (t)"]},{"set_name":"Mithril trimmed set (lg)","components":["Mithril platebody (t)","Mithril platelegs (t)","Mithril full helm (t)","Mithril kiteshield (t)"]},{"set_name":"Adamant trimmed set (lg)","components":["Adamant platebody (t)","Adamant platelegs (t)","Adamant full helm (t)","Adamant kiteshield (t)"]},{"set_name":"Rune trimmed set (lg)","components":["Rune platebody (t)","Rune platelegs (t)","Rune full helm (t)","Rune kiteshield (t)"]},{"set_name":"Guthix armour set (lg)","components":["Guthix platebody","Guthix platelegs","Guthix full helm","Guthix kiteshield"]},{"set_name":"Saradomin armour set (lg)","components":["Saradomin platebody","Saradomin platelegs","Saradomin full helm","Saradomin kiteshield"]},{"set_name":"Zamorak armour set (lg)","components":["Zamorak platebody","Zamorak platelegs","Zamorak full helm","Zamorak kiteshield"]},{"set_name":"Ancient rune armour set (lg)","components":["Ancient platebody","Ancient platelegs","Ancient full helm","Ancient kiteshield"]},{"set_name":"Armadyl rune armour set (lg)","components":["Armadyl platebody","Armadyl platelegs","Armadyl full helm","Armadyl kiteshield"]},{"set_name":"Bandos rune armour set (lg)","components":["Bandos platebody","Bandos platelegs","Bandos full helm","Bandos kiteshield"]},{"set_name":"Bronze set (sk)","components":["Bronze platebody","Bronze plateskirt","Bronze full helm","Bronze kiteshield"]},{"set_name":"Iron set (sk)","components":["Iron platebody","Iron plateskirt","Iron full helm","Iron kiteshield"]},{"set_name":"Steel set (sk)","components":["Steel platebody","Steel plateskirt","Steel full helm","Steel kiteshield"]},{"set_name":"Black set (sk)","components":["Black platebody","Black plateskirt","Black full helm","Black kiteshield"]},{"set_name":"Mithril set (sk)","components":["Mithril platebody","Mithril plateskirt","Mithril full helm","Mithril kiteshield"]},{"set_name":"Adamant set (sk)","components":["Adamant platebody","Adamant plateskirt","Adamant full helm","Adamant kiteshield"]},{"set_name":"Rune armour set (sk)","components":["Rune platebody","Rune plateskirt","Rune full helm","Rune kiteshield"]},{"set_name":"Dragon armour set (sk)","components":["Dragon platebody","Dragon plateskirt","Dragon full helm","Dragon kiteshield"]},{"set_name":"Bronze gold-trimmed set (sk)","components":["Bronze platebody (g)","Bronze plateskirt (g)","Bronze full helm (g)","Bronze kiteshield (g)"]},{"set_name":"Iron gold-trimmed set (sk)","components":["Iron platebody (g)","Iron plateskirt (g)","Iron full helm (g)","Iron kiteshield (g)"]},{"set_name":"Steel gold-trimmed set (sk)","components":["Steel platebody (g)","Steel plateskirt (g)","Steel full helm (g)","Steel kiteshield (g)"]},{"set_name":"Black gold-trimmed set (sk)","components":["Black platebody (g)","Black plateskirt (g)","Black full helm (g)","Black kiteshield (g)"]},{"set_name":"Mithril gold-trimmed set (sk)","components":["Mithril platebody (g)","Mithril plateskirt (g)","Mithril full helm (g)","Mithril kiteshield (g)"]},{"set_name":"Adamant gold-trimmed set (sk)","components":["Adamant platebody (g)","Adamant plateskirt (g)","Adamant full helm (g)","Adamant kiteshield (g)"]},{"set_name":"Rune gold-trimmed set (sk)","components":["Rune platebody (g)","Rune plateskirt (g)","Rune full helm (g)","Rune kiteshield (g)"]},{"set_name":"Gilded armour set (sk)","components":["Gilded platebody","Gilded plateskirt","Gilded full helm","Gilded kiteshield"]},{"set_name":"Bronze trimmed set (sk)","components":["Bronze platebody (t)","Bronze plateskirt (t)","Bronze full helm (t)","Bronze kiteshield (t)"]},{"set_name":"Iron trimmed set (sk)","components":["Iron platebody (t)","Iron plateskirt (t)","Iron full helm (t)","Iron kiteshield (t)"]},{"set_name":"Steel trimmed set (sk)","components":["Steel platebody (t)","Steel plateskirt (t)","Steel full helm (t)","Steel kiteshield (t)"]},{"set_name":"Black trimmed set (sk)","components":["Black platebody (t)","Black plateskirt (t)","Black full helm (t)","Black kiteshield (t)"]},{"set_name":"Mithril trimmed set (sk)","components":["Mithril platebody (t)","Mithril plateskirt (t)","Mithril full helm (t)","Mithril kiteshield (t)"]},{"set_name":"Adamant trimmed set (sk)","components":["Adamant platebody (t)","Adamant plateskirt (t)","Adamant full helm (t)","Adamant kiteshield (t)"]},{"set_name":"Rune trimmed set (sk)","components":["Rune platebody (t)","Rune plateskirt (t)","Rune full helm (t)","Rune kiteshield (t)"]},{"set_name":"Guthix armour set (sk)","components":["Guthix platebody","Guthix plateskirt","Guthix full helm","Guthix kiteshield"]},{"set_name":"Saradomin armour set (sk)","components":["Saradomin platebody","Saradomin plateskirt","Saradomin full helm","Saradomin kiteshield"]},{"set_name":"Zamorak armour set (sk)","components":["Zamorak platebody","Zamorak plateskirt","Zamorak full helm","Zamorak kiteshield"]},{"set_name":"Ancient rune armour set (sk)","components":["Ancient platebody","Ancient plateskirt","Ancient full helm","Ancient kiteshield"]},{"set_name":"Armadyl rune armour set (sk)","components":["Armadyl platebody","Armadyl plateskirt","Armadyl full helm","Armadyl kiteshield"]},{"set_name":"Bandos rune armour set (sk)","components":["Bandos platebody","Bandos plateskirt","Bandos full helm","Bandos kiteshield"]},{"set_name":"Initiate harness m","components":["Initiate hauberk","Initiate cuisse","Initiate helm"]}];
const goldJewelry = [{"item":"Gold ring","level":5,"exp":15,"gem":null},{"item":"Gold necklace","level":6,"exp":20,"gem":null},{"item":"Gold bracelet","level":7,"exp":25,"gem":null},{"item":"Gold amulet (u)","level":8,"exp":30,"gem":null},{"item":"Sapphire ring","level":20,"exp":40,"gem":"sapphire"},{"item":"Sapphire necklace","level":22,"exp":55,"gem":"sapphire"},{"item":"Sapphire bracelet","level":23,"exp":60,"gem":"sapphire"},{"item":"Sapphire amulet (u)","level":24,"exp":65,"gem":"sapphire"},{"item":"Emerald ring","level":27,"exp":55,"gem":"emerald"},{"item":"Emerald necklace","level":29,"exp":60,"gem":"emerald"},{"item":"Emerald bracelet","level":30,"exp":65,"gem":"emerald"},{"item":"Emerald amulet (u)","level":31,"exp":70,"gem":"emerald"},{"item":"Ruby ring","level":34,"exp":70,"gem":"ruby"},{"item":"Ruby necklace","level":40,"exp":75,"gem":"ruby"},{"item":"Ruby bracelet","level":42,"exp":80,"gem":"ruby"},{"item":"Ruby amulet (u)","level":50,"exp":85,"gem":"ruby"},{"item":"Diamond ring","level":43,"exp":85,"gem":"diamond"},{"item":"Diamond necklace","level":56,"exp":90,"gem":"diamond"},{"item":"Diamond bracelet","level":58,"exp":95,"gem":"diamond"},{"item":"Diamond amulet (u)","level":70,"exp":100,"gem":"diamond"},{"item":"Dragonstone ring","level":55,"exp":100,"gem":"dragonstone"},{"item":"Dragon necklace","level":72,"exp":105,"gem":"dragonstone"},{"item":"Dragonstone bracelet","level":74,"exp":110,"gem":"dragonstone"},{"item":"Dragonstone amulet (u)","level":80,"exp":150,"gem":"dragonstone"},{"item":"Onyx ring","level":67,"exp":115,"gem":"onyx"},{"item":"Onyx necklace","level":82,"exp":120,"gem":"onyx"},{"item":"Onyx bracelet","level":84,"exp":125,"gem":"onyx"},{"item":"Onyx amulet (u)","level":90,"exp":165,"gem":"onyx"},{"item":"Zenyte ring","level":89,"exp":150,"gem":"zenyte"},{"item":"Zenyte necklace","level":92,"exp":165,"gem":"zenyte"},{"item":"Zenyte bracelet","level":95,"exp":180,"gem":"zenyte"},{"item":"Zenyte amulet (u)","level":98,"exp":200,"gem":"zenyte"}];
const enchantJewelry = [{"spell":"Lvl-1 Enchant","level":7,"base_item":"Opal ring","enchanted_item":"Ring of pursuit","runes":"1 Water rune, 1 Cosmic rune","exp":17.5},{"spell":"Lvl-1 Enchant","level":7,"base_item":"Opal necklace","enchanted_item":"Dodgy necklace","runes":"1 Water rune, 1 Cosmic rune","exp":17.5},{"spell":"Lvl-1 Enchant","level":7,"base_item":"Opal bracelet","enchanted_item":"Expeditious bracelet","runes":"1 Water rune, 1 Cosmic rune","exp":17.5},{"spell":"Lvl-1 Enchant","level":7,"base_item":"Opal amulet","enchanted_item":"Amulet of bounty","runes":"1 Water rune, 1 Cosmic rune","exp":17.5},{"spell":"Lvl-2 Enchant","level":27,"base_item":"Jade ring","enchanted_item":"Ring of returning","runes":"3 Air rune, 1 Cosmic rune","exp":37},{"spell":"Lvl-2 Enchant","level":27,"base_item":"Jade necklace","enchanted_item":"Necklace of passage","runes":"3 Air rune, 1 Cosmic rune","exp":37},{"spell":"Lvl-2 Enchant","level":27,"base_item":"Jade bracelet","enchanted_item":"Flamtaer bracelet","runes":"3 Air rune, 1 Cosmic rune","exp":37},{"spell":"Lvl-2 Enchant","level":27,"base_item":"Jade amulet","enchanted_item":"Amulet of chemistry","runes":"3 Air rune, 1 Cosmic rune","exp":37},{"spell":"Lvl-1 Enchant","level":7,"base_item":"Sapphire ring","enchanted_item":"Ring of recoil","runes":"1 Water rune, 1 Cosmic rune","exp":17.5},{"spell":"Lvl-1 Enchant","level":7,"base_item":"Sapphire necklace","enchanted_item":"Games necklace","runes":"1 Water rune, 1 Cosmic rune","exp":17.5},{"spell":"Lvl-1 Enchant","level":7,"base_item":"Sapphire bracelet","enchanted_item":"Bracelet of clay","runes":"1 Water rune, 1 Cosmic rune","exp":17.5},{"spell":"Lvl-1 Enchant","level":7,"base_item":"Sapphire amulet","enchanted_item":"Amulet of magic","runes":"1 Water rune, 1 Cosmic rune","exp":17.5},{"spell":"Lvl-2 Enchant","level":27,"base_item":"Emerald ring","enchanted_item":"Ring of dueling","runes":"3 Air rune, 1 Cosmic rune","exp":37},{"spell":"Lvl-2 Enchant","level":27,"base_item":"Emerald necklace","enchanted_item":"Binding necklace","runes":"3 Air rune, 1 Cosmic rune","exp":37},{"spell":"Lvl-2 Enchant","level":27,"base_item":"Emerald bracelet","enchanted_item":"Castle wars bracelet","runes":"3 Air rune, 1 Cosmic rune","exp":37},{"spell":"Lvl-2 Enchant","level":27,"base_item":"Emerald amulet","enchanted_item":"Amulet of defence","runes":"3 Air rune, 1 Cosmic rune","exp":37},{"spell":"Lvl-3 Enchant","level":49,"base_item":"Topaz ring","enchanted_item":"Efaritay's aid","runes":"5 Fire rune, 1 Cosmic rune","exp":59},{"spell":"Lvl-3 Enchant","level":49,"base_item":"Topaz necklace","enchanted_item":"Necklace of faith","runes":"5 Fire rune, 1 Cosmic rune","exp":59},{"spell":"Lvl-3 Enchant","level":49,"base_item":"Topaz bracelet","enchanted_item":"Bracelet of slaughter","runes":"5 Fire rune, 1 Cosmic rune","exp":59},{"spell":"Lvl-3 Enchant","level":49,"base_item":"Topaz amulet","enchanted_item":"Burning amulet","runes":"5 Fire rune, 1 Cosmic rune","exp":59},{"spell":"Lvl-3 Enchant","level":49,"base_item":"Ruby ring","enchanted_item":"Ring of forging","runes":"5 Fire rune, 1 Cosmic rune","exp":59},{"spell":"Lvl-3 Enchant","level":49,"base_item":"Ruby necklace","enchanted_item":"Digsite pendant","runes":"5 Fire rune, 1 Cosmic rune","exp":59},{"spell":"Lvl-3 Enchant","level":49,"base_item":"Ruby bracelet","enchanted_item":"Inoculation bracelet","runes":"5 Fire rune, 1 Cosmic rune","exp":59},{"spell":"Lvl-3 Enchant","level":49,"base_item":"Ruby amulet","enchanted_item":"Amulet of strength","runes":"5 Fire rune, 1 Cosmic rune","exp":59},{"spell":"Lvl-4 Enchant","level":57,"base_item":"Diamond ring","enchanted_item":"Ring of life","runes":"10 Earth rune, 1 Cosmic rune","exp":67},{"spell":"Lvl-4 Enchant","level":57,"base_item":"Diamond necklace","enchanted_item":"Phoenix necklace","runes":"10 Earth rune, 1 Cosmic rune","exp":67},{"spell":"Lvl-4 Enchant","level":57,"base_item":"Diamond bracelet","enchanted_item":"Abyssal bracelet","runes":"10 Earth rune, 1 Cosmic rune","exp":67},{"spell":"Lvl-4 Enchant","level":57,"base_item":"Diamond amulet","enchanted_item":"Amulet of power","runes":"10 Earth rune, 1 Cosmic rune","exp":67},{"spell":"Lvl-5 Enchant","level":68,"base_item":"Dragonstone ring","enchanted_item":"Ring of wealth","runes":"15 Earth rune, 15 Water rune, 1 Cosmic rune","exp":78},{"spell":"Lvl-5 Enchant","level":68,"base_item":"Dragon necklace","enchanted_item":"Skills necklace","runes":"15 Earth rune, 15 Water rune, 1 Cosmic rune","exp":78},{"spell":"Lvl-5 Enchant","level":68,"base_item":"Dragonstone bracelet","enchanted_item":"Combat bracelet","runes":"15 Earth rune, 15 Water rune, 1 Cosmic rune","exp":78},{"spell":"Lvl-5 Enchant","level":68,"base_item":"Dragonstone amulet","enchanted_item":"Amulet of glory","runes":"15 Earth rune, 15 Water rune, 1 Cosmic rune","exp":78},{"spell":"Lvl-6 Enchant","level":87,"base_item":"Onyx ring","enchanted_item":"Ring of stone","runes":"20 Earth rune, 20 Fire rune, 1 Cosmic rune","exp":97},{"spell":"Lvl-6 Enchant","level":87,"base_item":"Onyx necklace","enchanted_item":"Berserker necklace","runes":"20 Earth rune, 20 Fire rune, 1 Cosmic rune","exp":97},{"spell":"Lvl-6 Enchant","level":87,"base_item":"Onyx bracelet","enchanted_item":"Regen bracelet","runes":"20 Earth rune, 20 Fire rune, 1 Cosmic rune","exp":97},{"spell":"Lvl-6 Enchant","level":87,"base_item":"Onyx amulet","enchanted_item":"Amulet of fury","runes":"20 Earth rune, 20 Fire rune, 1 Cosmic rune","exp":97},{"spell":"Lvl-7 Enchant","level":93,"base_item":"Zenyte ring","enchanted_item":"Ring of suffering","runes":"20 Blood rune, 1 Cosmic rune, 20 Soul rune","exp":110},{"spell":"Lvl-7 Enchant","level":93,"base_item":"Zenyte necklace","enchanted_item":"Necklace of anguish","runes":"20 Blood rune, 1 Cosmic rune, 20 Soul rune","exp":110},{"spell":"Lvl-7 Enchant","level":93,"base_item":"Zenyte bracelet","enchanted_item":"Tormented bracelet","runes":"20 Blood rune, 1 Cosmic rune, 20 Soul rune","exp":110},{"spell":"Lvl-7 Enchant","level":93,"base_item":"Zenyte amulet","enchanted_item":"Amulet of torture","runes":"20 Blood rune, 1 Cosmic rune, 20 Soul rune","exp":110}];
const smithItems = [
  // Steel
  {"item":"Steel dagger","bars":1,"level":30,"exp":37.5,"barId":2353},
  {"item":"Steel axe","bars":1,"level":31,"exp":37.5,"barId":2353},
  {"item":"Steel mace","bars":1,"level":32,"exp":37.5,"barId":2353},
  {"item":"Steel med helm","bars":1,"level":33,"exp":37.5,"barId":2353},
  {"item":"Steel sword","bars":1,"level":34,"exp":37.5,"barId":2353},
  {"item":"Steel scimitar","bars":2,"level":35,"exp":75,"barId":2353},
  {"item":"Steel limbs","bars":1,"level":36,"exp":37.5,"barId":2353},
  {"item":"Steel longsword","bars":2,"level":36,"exp":75,"barId":2353},
  {"item":"Steel studs","bars":1,"level":36,"exp":37.5,"barId":2353},
  {"item":"Steel full helm","bars":2,"level":37,"exp":75,"barId":2353},
  {"item":"Steel sq shield","bars":2,"level":38,"exp":75,"barId":2353},
  {"item":"Steel warhammer","bars":3,"level":39,"exp":112.5,"barId":2353},
  {"item":"Steel battleaxe","bars":3,"level":40,"exp":112.5,"barId":2353},
  {"item":"Steel chainbody","bars":3,"level":41,"exp":112.5,"barId":2353},
  {"item":"Steel kiteshield","bars":3,"level":42,"exp":112.5,"barId":2353},
  {"item":"Steel claws","bars":2,"level":43,"exp":75,"barId":2353},
  {"item":"Steel 2h sword","bars":3,"level":44,"exp":112.5,"barId":2353},
  {"item":"Steel platelegs","bars":3,"level":46,"exp":112.5,"barId":2353},
  {"item":"Steel plateskirt","bars":3,"level":46,"exp":112.5,"barId":2353},
  {"item":"Steel platebody","bars":5,"level":48,"exp":187.5,"barId":2353},
  // Mithril
  {"item":"Mithril dagger","bars":1,"level":50,"exp":50,"barId":2359},
  {"item":"Mithril axe","bars":1,"level":51,"exp":50,"barId":2359},
  {"item":"Mithril mace","bars":1,"level":52,"exp":50,"barId":2359},
  {"item":"Mithril med helm","bars":1,"level":53,"exp":50,"barId":2359},
  {"item":"Mithril sword","bars":1,"level":54,"exp":50,"barId":2359},
  {"item":"Mithril scimitar","bars":2,"level":55,"exp":100,"barId":2359},
  {"item":"Mithril limbs","bars":1,"level":56,"exp":50,"barId":2359},
  {"item":"Mithril longsword","bars":2,"level":56,"exp":100,"barId":2359},
  {"item":"Mithril full helm","bars":2,"level":57,"exp":100,"barId":2359},
  {"item":"Mithril sq shield","bars":2,"level":58,"exp":100,"barId":2359},
  {"item":"Mithril warhammer","bars":3,"level":59,"exp":150,"barId":2359},
  {"item":"Mith grapple tip","bars":1,"level":59,"exp":50,"barId":2359},
  {"item":"Mithril battleaxe","bars":3,"level":60,"exp":150,"barId":2359},
  {"item":"Mithril chainbody","bars":3,"level":61,"exp":150,"barId":2359},
  {"item":"Mithril kiteshield","bars":3,"level":62,"exp":150,"barId":2359},
  {"item":"Mithril claws","bars":2,"level":63,"exp":100,"barId":2359},
  {"item":"Mithril 2h sword","bars":3,"level":64,"exp":150,"barId":2359},
  {"item":"Mithril platelegs","bars":3,"level":66,"exp":150,"barId":2359},
  {"item":"Mithril plateskirt","bars":3,"level":66,"exp":150,"barId":2359},
  {"item":"Mithril platebody","bars":5,"level":68,"exp":250,"barId":2359},
  // Adamant
  {"item":"Adamant dagger","bars":1,"level":70,"exp":62.5,"barId":2361},
  {"item":"Adamant axe","bars":1,"level":71,"exp":62.5,"barId":2361},
  {"item":"Adamant mace","bars":1,"level":72,"exp":62.5,"barId":2361},
  {"item":"Adamant med helm","bars":1,"level":73,"exp":62.5,"barId":2361},
  {"item":"Adamant sword","bars":1,"level":74,"exp":62.5,"barId":2361},
  {"item":"Adamant scimitar","bars":2,"level":75,"exp":125,"barId":2361},
  {"item":"Adamantite limbs","bars":1,"level":76,"exp":62.5,"barId":2361},
  {"item":"Adamant longsword","bars":2,"level":76,"exp":125,"barId":2361},
  {"item":"Adamant full helm","bars":2,"level":77,"exp":125,"barId":2361},
  {"item":"Adamant sq shield","bars":2,"level":78,"exp":125,"barId":2361},
  {"item":"Adamant warhammer","bars":3,"level":79,"exp":187.5,"barId":2361},
  {"item":"Adamant battleaxe","bars":3,"level":80,"exp":187.5,"barId":2361},
  {"item":"Adamant chainbody","bars":3,"level":81,"exp":187.5,"barId":2361},
  {"item":"Adamant kiteshield","bars":3,"level":82,"exp":187.5,"barId":2361},
  {"item":"Adamant claws","bars":2,"level":83,"exp":125,"barId":2361},
  {"item":"Adamant 2h sword","bars":3,"level":84,"exp":187.5,"barId":2361},
  {"item":"Adamant platelegs","bars":3,"level":86,"exp":187.5,"barId":2361},
  {"item":"Adamant plateskirt","bars":3,"level":86,"exp":187.5,"barId":2361},
  {"item":"Adamant platebody","bars":5,"level":88,"exp":312.5,"barId":2361},
  // Rune
  {"item":"Rune dagger","bars":1,"level":85,"exp":75,"barId":2363},
  {"item":"Rune axe","bars":1,"level":86,"exp":75,"barId":2363},
  {"item":"Rune mace","bars":1,"level":87,"exp":75,"barId":2363},
  {"item":"Rune med helm","bars":1,"level":88,"exp":75,"barId":2363},
  {"item":"Rune sword","bars":1,"level":89,"exp":75,"barId":2363},
  {"item":"Rune scimitar","bars":2,"level":90,"exp":150,"barId":2363},
  {"item":"Runite limbs","bars":1,"level":91,"exp":75,"barId":2363},
  {"item":"Rune longsword","bars":2,"level":91,"exp":150,"barId":2363},
  {"item":"Rune full helm","bars":2,"level":92,"exp":150,"barId":2363},
  {"item":"Rune sq shield","bars":2,"level":93,"exp":150,"barId":2363},
  {"item":"Rune warhammer","bars":3,"level":94,"exp":225,"barId":2363},
  {"item":"Rune battleaxe","bars":3,"level":95,"exp":225,"barId":2363},
  {"item":"Rune chainbody","bars":3,"level":96,"exp":225,"barId":2363},
  {"item":"Rune kiteshield","bars":3,"level":97,"exp":225,"barId":2363},
  {"item":"Rune claws","bars":2,"level":98,"exp":150,"barId":2363},
  {"item":"Rune 2h sword","bars":3,"level":99,"exp":225,"barId":2363},
  {"item":"Rune platelegs","bars":3,"level":99,"exp":225,"barId":2363},
  {"item":"Rune plateskirt","bars":3,"level":99,"exp":225,"barId":2363},
  {"item":"Rune platebody","bars":5,"level":99,"exp":375,"barId":2363}
];
/* ---------- Utilities ---------- */
const fmtGp = n => n==null ? "—" : Number(n).toLocaleString() + " gp";
const fmtNum = n => n==null ? "—" : Number(n).toLocaleString();
const abbreviateNumber = (num) => {
  if (num >= 1e9) {
    return (num / 1e9).toFixed(1).replace(/\.0$/, '') + 'b';
  }
  if (num >= 1e6) {
    return (num / 1e6).toFixed(1).replace(/\.0$/, '') + 'm';
  }
  if (num >= 1e3) {
    return (num / 1e3).toFixed(1).replace(/\.0$/, '') + 'k';
  }
  return num.toLocaleString();
};
async function jget(url){
  const r=await fetch(url, {cache: "default"});
  if(!r.ok) throw new Error(url+" HTTP "+r.status);
  return await r.json();
}
const loadMapping=()=>jget(API+"/mapping");
const loadLatest =()=>jget(API+"/latest");
const loadVolumes=()=>jget(API+"/volumes");
const loadTS =(step,id)=> jget(API+`/timeseries?timestep=${step}&id=${id}`);
function bigIconUrl(id){ 
  return `./images/${id}.png`; // Relative path; works locally and on GitHub Pages 
}
function wikiIconUrl(name){
  if(!name) return "";
  const m = mapping.find(x => x.name.toLowerCase() === name.toLowerCase()); // Get ID from name
  return m ? `./images/${m.id}.png` : ""; // Use ID for consistency 
}
function suggestPrices(low, high) {
  if (low == null || high == null) return { buyMin: null, buyMax: null, sellMin: null, sellMax: null };
  const spread = high - low;
  let buyMargin = Math.max(1, Math.floor(spread * 0.1)); // Increased to 10% for lower buy prices
  let sellMargin = Math.max(1, Math.floor(spread * 0.1)); // Increased to 10% for higher sell prices
  if (high < 100) {
    buyMargin = 2;
    sellMargin = 4;
  } else if (high < 1000) {
    buyMargin = 5;
    sellMargin = 10;
  } else if (high < 10000) {
    buyMargin = 10;
    sellMargin = 20;
  } else {
    buyMargin = Math.floor(high * 0.005); // Increased to 0.5%
    sellMargin = Math.floor(high * 0.01); // Increased to 1%
  }
  const buyMin = Math.max(1, low - buyMargin);
  const buyMax = low;
  let sellMin = high;
  let sellMax = Math.max(1, high + sellMargin);
  const tax = 0.01;
  const minSell = Math.ceil(buyMax / (1 - tax)) + 1;
  sellMin = Math.max(sellMin, minSell);
  sellMax = Math.max(sellMax, minSell + Math.max(2, Math.floor(sellMargin / 2)));
  return { buyMin, buyMax, sellMin, sellMax };
}
/* Map backend timeseries to arrays */
function seriesFromTS(ts){
  const src = ts?.data || [];
  const rows = src.map(r=>({
    t: Number(r.timestamp ?? r.ts ?? r.time),
    lo: r.avgLowPrice ?? r.low ?? null,
    hi: r.avgHighPrice ?? r.high ?? null,
    vol: r.lowPriceVolume ?? r.highPriceVolume ?? r.volume ?? null
  })).filter(r=>r.t && (r.lo!=null || r.hi!=null)).sort((a,b)=>a.t-b.t);
  return { labels: rows.map(r=>r.t), low: rows.map(r=>r.lo), high: rows.map(r=>r.hi), vol: rows.map(r=>r.vol ?? 0) };
}
/* ========== Chart (line + scatter + hold line) ========== */
const canvas = document.getElementById("chart");
const ctx = canvas.getContext("2d");
const tip = document.getElementById("tip");
function ypx(v, vmin, vmax, y0, h){
  if(vmin===vmax) return y0+h/2;
  const p=(v-vmin)/(vmax-vmin);
  return y0 + (1-p)*h;
}
function linearRegression(x, y) {
  const n = x.length;
  const sumX = x.reduce((a, b) => a + b, 0);
  const sumY = y.reduce((a, b) => a + b, 0);
  const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
  const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
  const meanX = sumX / n;
  const meanY = sumY / n;
  const slope = (sumXY - n * meanX * meanY) / (sumX2 - n * meanX * meanX);
  const intercept = meanY - slope * meanX;
  return { slope, intercept };
}
function drawChart(series, context = ctx, can = canvas, z = zoom, off = offset, mode = drawMode){
  const c = can;
  const W=c.width, H=c.height;
  const x0=60, y0=30, w=W-x0-14, h=H-y0-42;
  context.clearRect(0,0,W,H);
  if(!series || !series.labels?.length){ return; }
  // windowing (zoom + pan)
  const n = series.labels.length;
  const win = Math.max(12, Math.floor(n/z));
  const start = Math.max(0,Math.min(n-win, Math.floor(off)));
  const end = start + win;
  const L = series.labels.slice(start,end);
  const LO = series.low.slice(start,end);
  const HI = series.high.slice(start,end);
  const VO = (series.vol||[]).slice(start,end);
  // value domain from price series
  const vals = [...LO, ...HI].filter(v=>v!=null);
  if(!vals.length) return;
  let vmin = Math.min(...vals), vmax = Math.max(...vals);
  if(vmin===vmax){ vmin-=1; vmax+=1; }
  // axes
  context.strokeStyle="#000"; context.globalAlpha=0.5;
  context.beginPath(); context.moveTo(x0,y0); context.lineTo(x0,y0+h); context.lineTo(x0+w,y0+h); context.stroke();
  context.globalAlpha=1;
  // background grid
  context.fillStyle="#fff"; context.font="bold 14px Segoe UI, Arial";
  const lines=5;
  for(let i=0;i<=lines;i++){
    const y=y0 + (h*i/lines);
    context.strokeStyle="rgba(255,255,255,0.06)";
    context.beginPath(); context.moveTo(x0,y); context.lineTo(x0+w,y); context.stroke();
  }
  const stepX = w / Math.max(1,(L.length-1));
  // draw low (offer) red and high (list) green
  function drawSeries(arr, color, mode){
    context.strokeStyle=color;
    context.fillStyle=color;
    if(mode==="line"){
      context.beginPath();
      for(let i=0;i<arr.length;i++){
        const v=arr[i]; if(v==null) continue;
        const x=x0 + i*stepX;
        const y=ypx(v, vmin, vmax, y0, h);
        if(i===0) context.moveTo(x,y); else context.lineTo(x,y);
      }
      context.lineWidth=2; context.stroke();
    }else{ // scatter
      for(let i=0;i<arr.length;i++){
        const v=arr[i]; if(v==null) continue;
        const x=x0 + i*stepX;
        const y=ypx(v, vmin, vmax, y0, h);
        context.beginPath(); context.arc(x,y,3,0,Math.PI*2); context.fill();
      }
    }
  }
  // draw low (offer) red and high (list) green
  drawSeries(LO, getComputedStyle(document.documentElement).getPropertyValue('--low-color').trim(), (mode==="line"?"line":"dot"));
  let highColor = getComputedStyle(document.documentElement).getPropertyValue('--high-color').trim();
  if (can.id === 'historicalChart') highColor = '#ff69b4';
  drawSeries(HI, highColor, (mode==="line"?"line":"dot"));
  // Dotted prediction lines
  function drawPrediction(arr, color) {
    const nonNull = arr.map((v, i) => ({v, i})).filter(({v}) => v != null);
    if (nonNull.length < 2) return;
    const xVals = nonNull.map(({i}) => i);
    const yVals = nonNull.map(({v}) => v);
    const { slope, intercept } = linearRegression(xVals, yVals);
    context.save();
    context.setLineDash([6,6]);
    context.strokeStyle = color;
    context.beginPath();
    const startX = x0;
    const startY = ypx(slope * 0 + intercept, vmin, vmax, y0, h);
    const endX = x0 + (arr.length - 1) * stepX + stepX * 0.2; // extend 20%
    const endY = ypx(slope * (arr.length - 1 + (arr.length * 0.2)) + intercept, vmin, vmax, y0, h);
    context.moveTo(startX, startY);
    context.lineTo(endX, endY);
    context.stroke();
    context.restore();
  }
  drawPrediction(LO, getComputedStyle(document.documentElement).getPropertyValue('--low-color').trim());
  drawPrediction(HI, highColor);
  // y labels on top
  context.fillStyle="#fff"; context.font="bold 14px Segoe UI, Arial";
  for(let i=0;i<=lines;i++){
    const y=y0 + (h*i/lines);
    const v = Math.round(vmax - (vmax-vmin)*i/lines);
    context.fillText(abbreviateNumber(v), 6, y-4);
  }
  // X axis labels (dates) on top
  context.fillStyle="#fff"; context.font="bold 12px Segoe UI, Arial";
  const numLabels = 6;
  const labelStep = Math.floor(L.length / (numLabels - 1)) || 1;
  for(let i=0; i < L.length; i += labelStep){
    let dateStr;
    if (can.id === 'historicalChart') {
      dateStr = new Date(L[i]*1000).getFullYear().toString();
    } else {
      dateStr = new Date(L[i]*1000).toLocaleDateString();
    }
    const x = x0 + i*stepX;
    context.fillText(dateStr, x - 20, H - 10);
  }
  // hover tooltip
  c.onmousemove = (ev)=>{
    const rect=c.getBoundingClientRect();
    const mx=ev.clientX-rect.left, my=ev.clientY-rect.top;
    if(mx<x0 || mx>x0+w || my<y0 || my>y0+h){ tip.style.display="none"; return; }
    const idx=Math.max(0,Math.min(L.length-1, Math.round((mx-x0)/stepX)));
    const t=L[idx]*1000;
    const lo=LO[idx], hi=HI[idx], vol=VO[idx]||0;
    tip.style.display="block";
    tip.style.left = (mx+12)+"px";
    tip.style.top = (my-10)+"px";
    tip.innerHTML = `<strong>${new Date(t).toLocaleString()}</strong><br/>
      Low: ${fmtGp(lo)}<br/>
      High: ${fmtGp(hi)}<br/>
      Vol: ${fmtNum(vol)}`;
  };
  c.onmouseleave = () => tip.style.display="none";
}
/* ---------- Item selection & sidebar ---------- */
async function getBuyLimit(id) {
  if (buyLimits[id]) return buyLimits[id];
  try {
    const res = await fetch(`./items-json/${id}.json`);
    const data = await res.json();
    buyLimits[id] = data.buy_limit;
    return buyLimits[id];
  } catch (e) {
    console.warn(`Failed to load buy limit for item ${id}:`, e);
    return null;
  }
}
async function getItemId(name) {
  const m = mapping.find(x => x.name.toLowerCase() === name.toLowerCase());
  return m ? m.id : null;
}
async function getAlchValue(id) {
  try {
    const data = await jget(`./items-json/${id}.json`);
    return data.highalch || 0;
  } catch (e) {
    return 0;
  }
}
async function setItem(m){
  selected=m; $("#query").value=m.name;
  document.title = `${m.name} Live Prices, Graphs, Historical Data - (OSRS) GE - Flipping Tool`;
  const img=$("#itemImg");
  img.src=bigIconUrl(m.id);
  img.alt = m.name; // e.g., "Gilded scimitar"
  img.onerror=()=>{ img.onerror=null; img.src=wikiIconUrl(m.icon||m.name); };
  $("#status").textContent="Loading latest…";
  latest = await loadLatest();
  volumes= await loadVolumes();
  const node=latest.data[String(m.id)];
  const lo=node?.low ?? node?.avgLowPrice ?? null;
  const hi=node?.high ?? node?.avgHighPrice ?? null;
  let rec=suggestPrices(lo,hi);
  adjustedBuy = rec.buyMin ? Math.floor((rec.buyMin + rec.buyMax) / 2) : null;
  adjustedSell = rec.sellMin ? Math.floor((rec.sellMin + rec.sellMax) / 2) : null;
  buyLimit = await getBuyLimit(m.id) || 10000; // Lazy load + cache
  $("#smartBuyInput").value = adjustedBuy ? adjustedBuy.toLocaleString() : "—";
  $("#smartSellInput").value = adjustedSell ? adjustedSell.toLocaleString() : "—";
  $("#buyLimitDisplay").value = buyLimit.toLocaleString();
  $("#flipProfitLabel").textContent = "Expected Flip Profit";
  updateFlipProfit();
  $("#capitalRequired").textContent = adjustedBuy ? fmtGp(adjustedBuy * buyLimit) : "—";
  $("#buyLimitInfo").textContent = `with ${buyLimit.toLocaleString()} units (4h buy limit)`;
  $("#status").textContent="Loading chart…";
  const step = (view==="day"?"1h":view==="week"?"6h":view==="month"?"24h":"24h");
  const ts = await loadTS(step, m.id);
  currentSeries = seriesFromTS(ts);
  // Load recent 5m series to cap suggestions
  const tsRecent = await loadTS("5m", m.id);
  const seriesRecent = seriesFromTS(tsRecent);
  const recentHighs = seriesRecent.high.filter(v => v != null);
  const maxRecentHi = recentHighs.length ? Math.max(...recentHighs) : hi || 0;
  rec.sellMin = Math.min(rec.sellMin, maxRecentHi + Math.floor(maxRecentHi * 0.05)); // Relaxed cap to +5%
  rec.sellMax = Math.min(rec.sellMax, maxRecentHi + Math.floor(maxRecentHi * 0.1)); // Relaxed cap to +10%
  if(view === "day") zoom = 6;
  else if(view === "month") zoom = 1;
  else zoom = 1.5;
  offset = Math.max(0, (currentSeries.labels.length - Math.floor(currentSeries.labels.length / zoom)));
  drawChart(currentSeries);
  // Update 1h spread
  const ts1h = await loadTS("1h", m.id);
  const series1h = seriesFromTS(ts1h);
  const lo1h = series1h.low[series1h.low.length - 1] || lo;
  const hi1h = series1h.high[series1h.high.length - 1] || hi;
  const spread1h = hi1h - lo1h;
  $("#spreadMargin").textContent = `1h Spread: ${fmtGp(spread1h)}`;
  // Update small historical chart with lifetime data (using 24h for more history)
  const tsHistorical = await loadTS("24h", m.id);
  const historicalSeries = seriesFromTS(tsHistorical);
  const histSeries = {...historicalSeries, low: historicalSeries.low.map(()=>null)}; // Only high line
  drawChart(histSeries, $("#historicalChart").getContext("2d"), $("#historicalChart"), 4, 0, "line");
  // Update lifetime title
  const historicalH3 = document.querySelector('.side .card-like h3');
  historicalH3.innerHTML = `1 Year: <span style="color:var(--ink)">${m.name}</span>`;
  // Fetch item description from OSRS Wiki
  let desc = '';
  try {
    const response = await fetch(`https://oldschool.runescape.wiki/api.php?action=query&prop=extracts&exintro&explaintext&redirects=1&titles=${encodeURIComponent(m.name)}&format=json`);
    const data = await response.json();
    const page = Object.values(data.query.pages)[0];
    desc = page.extract || 'No description available.';
  } catch (e) {
    desc = 'Failed to load description.';
  }
  $("#itemDesc").innerHTML = `<h3>About ${m.name}</h3><p>${desc}</p>`;
  $("#status").textContent="Ready";
  // Update add to watchlist button
  $("#addWatchBtn").disabled = customWatchlist.includes(m.id);
}
function updateSmartBuyFromInput(){
  adjustedBuy = parseInt($("#smartBuyInput").value.replace(/,/g, '')) || null;
  $("#smartBuyInput").value = adjustedBuy ? adjustedBuy.toLocaleString() : "—";
  $("#capitalRequired").textContent = adjustedBuy ? fmtGp(adjustedBuy * buyLimit) : "—";
  updateFlipProfit();
}
function updateSmartSellFromInput(){
  adjustedSell = parseInt($("#smartSellInput").value.replace(/,/g, '')) || null;
  $("#smartSellInput").value = adjustedSell ? adjustedSell.toLocaleString() : "—";
  updateFlipProfit();
}
function adjustPrice(type, delta){
  if (type === 'buy') {
    adjustedBuy = (adjustedBuy || 0) + delta;
    $("#smartBuyInput").value = adjustedBuy.toLocaleString() + ' gp';
    $("#capitalRequired").textContent = fmtGp(adjustedBuy * buyLimit);
  } else if (type === 'sell') {
    adjustedSell = (adjustedSell || 0) + delta;
    $("#smartSellInput").value = adjustedSell.toLocaleString() + ' gp';
  }
  updateFlipProfit();
}
function adjustBuyLimit(delta){
  buyLimit += delta;
  if (buyLimit < 1) buyLimit = 1;
  $("#buyLimitDisplay").value = buyLimit.toLocaleString();
  $("#buyLimitInfo").textContent = `with ${buyLimit.toLocaleString()} units (4h buy limit)`;
  $("#capitalRequired").textContent = adjustedBuy ? fmtGp(adjustedBuy * buyLimit) : "—";
  updateFlipProfit();
}
function updateBuyLimitFromInput(){
  buyLimit = parseInt($("#buyLimitDisplay").value.replace(/,/g, '')) || 10000;
  $("#buyLimitDisplay").value = buyLimit.toLocaleString();
  $("#buyLimitInfo").textContent = `with ${buyLimit.toLocaleString()} units (4h buy limit)`;
  $("#capitalRequired").textContent = adjustedBuy ? fmtGp(adjustedBuy * buyLimit) : "—";
  updateFlipProfit();
}
function updateFlipProfit(){
  if (adjustedBuy && adjustedSell && buyLimit) {
    const profitPerItem = adjustedSell - adjustedBuy - Math.min(5000000, Math.floor(adjustedSell * 0.01)); // 1% tax, cap 5m
    const totalProfit = profitPerItem * Math.min(buyLimit, 100); // Cap at 100 units for realistic profit
    $("#flipProfit").textContent = fmtGp(totalProfit);
  } else {
    $("#flipProfit").textContent = "—";
  }
}
function rowIcon(m){ return bigIconUrl(m.id); }
async function buildSidebar(){
  if(!latest||!mapping) return;
  const candidates = [];
  const volMin = 50000; // Increased for higher volume
  const minPrice = 500; // Increased for higher price items
  const minProfit = 50000; // Minimum expected profit
  for(const m of mapping){
    if(dismissed.includes(m.id)) continue;
    if(!membersOn && m.members) continue; // hide member items in F2P mode
    const node=latest.data[String(m.id)];
    if(!node) continue;
    const lo=node.low??node.avgLowPrice;
    const hi=node.high??node.avgHighPrice;
    if(lo==null||hi==null) continue;
    const spread=(hi-lo);
    if(spread <=1 || (lo && (spread / lo < 0.01))) continue; // Skip low margin
    const vol=volumes?.data?.[String(m.id)] ?? 0;
    if(vol < volMin) continue;
    const rec = suggestPrices(lo, hi);
    const medianBuy = rec.buyMin ? Math.floor((rec.buyMin + rec.buyMax) / 2) : null;
    const medianSell = rec.sellMin ? Math.floor((rec.sellMin + rec.sellMax) / 2) : null;
    if (medianBuy < minPrice) continue; // Skip low value
    const profitPerItem = medianSell - medianBuy - Math.min(5000000, Math.floor(medianSell * 0.01));
    // Temp expectedProfit without buyLimit (we'll recalculate after fetching)
    const tempExpectedProfit = profitPerItem * 10000; // Default for pre-filter
    if (tempExpectedProfit < minProfit) continue;
    candidates.push({id:m.id, name:m.name, icon:rowIcon(m), spread, vol, medianBuy, medianSell, preScore: vol * spread});
  }
  candidates.sort((a,b) => b.preScore - a.preScore);
  const topCandidates = candidates.slice(0, 100); // Limit to top 100 for speed
  // Fetch timeseries in parallel for top candidates
  const tsPromises = topCandidates.map(c => loadTS("5m", c.id));
  const tsResults = await Promise.all(tsPromises);
  // Fetch buy limits in parallel for top candidates
  const buyLimitPromises = topCandidates.map(c => getBuyLimit(c.id));
  const buyLimitResults = await Promise.all(buyLimitPromises);
  topCandidates.forEach((c, i) => {
    const seriesRecent = seriesFromTS(tsResults[i]);
    const recentLows = seriesRecent.low.filter(v => v != null).slice(-10); // Last 10 points
    const avgRecentLow = recentLows.length ? recentLows.reduce((a,b)=>a+b,0)/recentLows.length : c.lo;
    const dropPercent = (avgRecentLow - c.lo) / avgRecentLow;
    c.isGoodDeal = dropPercent > 0.1; // >10% drop from recent avg
    c.profitPerItem = c.medianSell - c.medianBuy - Math.min(5000000, Math.floor(c.medianSell * 0.01));
    c.buyLimit = buyLimitResults[i] || 10000; // Use fetched/cached value
    c.expectedProfit = c.profitPerItem * c.buyLimit;
    c.score = c.vol * c.spread * (1 + dropPercent);
  });
  topCandidates.sort((a,b)=> b.expectedProfit - a.expectedProfit); // Prioritize by total expected profit
  flipSuggestions = topCandidates;
  updateSmartSuggest();
}
function updateSmartSuggest(){
  if(flipSuggestions.length === 0) return;
  const top = flipSuggestions[suggestIndex % flipSuggestions.length];
  const m = mapping.find(x=>x.id === top.id);
  if(!m) return;
  $("#smartSuggest").innerHTML = `
    <img src="${bigIconUrl(top.id)}" alt="${m.name}">
    <div class="details">
      <div class="name">${m.name}</div>
      <div class="prices">
        <div class="price buy"><label>Buy</label><strong>${top.medianBuy ? top.medianBuy.toLocaleString() + ' gp' : '—'}</strong></div>
        <div class="price sell"><label>Sell</label><strong>${top.medianSell ? top.medianSell.toLocaleString() + ' gp' : '—'}</strong></div>
      </div>
    </div>
    ${top.isGoodDeal ? '<div class="good-deal">Good Deal Alert!</div>' : ''}
  `;
  $("#smartSuggest").dataset.id = top.id;
  $("#smartSuggest").onclick = () => {
    const mItem = mapping.find(x => x.id == top.id);
    if (mItem) setItem(mItem);
  };
  const profitPerItem = top.medianSell - top.medianBuy - Math.min(5000000, Math.floor(top.medianSell * 0.01));
  const itemBuyLimit = top.buyLimit; // Use pre-fetched from buildSidebar
  const totalProfit = profitPerItem * Math.min(itemBuyLimit, 100); // Cap for realistic profit
  $("#suggestProfit strong").textContent = fmtGp(totalProfit);
}
async function buildWatchlist(sortBy = 'buy'){
  if(!latest||!mapping) return;
  const rows=[];
  for(const id of watchlist){
    const m = mapping.find(x=>x.id === id);
    if(!m) continue;
    const node=latest.data[String(id)];
    if(!node) continue;
    const lo=node.low??node.avgLowPrice;
    const hi=node.high??node.avgHighPrice;
    if(lo==null||hi==null) continue;
    const spread=(hi-lo);
    const vol=volumes?.data?.[String(id)] ?? 0;
    const rec = suggestPrices(lo, hi);
    const medianBuy = rec.buyMin ? Math.floor((rec.buyMin + rec.buyMax) / 2) : null;
    const medianSell = rec.sellMin ? Math.floor((rec.sellMin + rec.sellMax) / 2) : null;
    rows.push({id:m.id,name:m.name,icon:rowIcon(m), spread, vol, medianBuy, medianSell});
  }
  if(sortBy === 'name') rows.sort((a,b)=> a.name.localeCompare(b.name));
  else if(sortBy === 'buy') rows.sort((a,b)=> (b.medianBuy || 0) - (a.medianBuy || 0));
  else if(sortBy === 'sell') rows.sort((a,b)=> (b.medianSell || 0) - (a.medianSell || 0));
  else rows.sort((a,b)=> b.spread - a.spread);
  $("#watch").innerHTML = rows.map(r=>{
    const isLong = (r.medianBuy && r.medianBuy > 999999) || (r.medianSell && r.medianSell > 999999);
    return `
  <div class="row ${isLong ? 'long-price' : ''}">
    <img src="${r.icon}" alt="${r.name}">
    <div class="sym" data-id="${r.id}" title="${r.name}">${r.name}</div>
    <div class="delta">${r.medianBuy ? abbreviateNumber(r.medianBuy) : '—'}</div>
    <div class="vol">${r.medianSell ? abbreviateNumber(r.medianSell) : '—'}</div>
  </div>
  `}).join("");
  document.querySelectorAll('#watch .sym').forEach(el => {
    el.onclick = () => {
      const m = mapping.find(x => x.id == el.dataset.id);
      if (m) setItem(m);
    };
  });
}
async function buildAlchList() {
  const items = membersOn ? membersAlchItems : f2pAlchItems;
  const natNode = latest.data[natRuneId];
  const natPrice = natNode?.low ?? natNode?.avgLowPrice ?? 0;
  $('#natPrice').textContent = fmtGp(natPrice);
  const rows = [];
  for (const name of items) {
    const m = mapping.find(x => x.name.toLowerCase() === name.toLowerCase());
    if (!m) continue;
    const node = latest.data[m.id];
    const buyPrice = node?.low ?? node?.avgLowPrice ?? 0;
    let alchValue = 0;
    try {
      const itemData = await jget(`./items-json/${m.id}.json`);
      alchValue = itemData.highalch ?? 0;
    } catch (e) { console.warn(`Failed to load alch for ${m.id}`); }
    const profit = alchValue - buyPrice - natPrice;
    rows.push({id: m.id, name: m.name, icon: rowIcon(m), buyPrice, natPrice, alchValue, profit});
  }
  rows.sort((a,b) => b.profit - a.profit); // Sort by profit desc
  $('#alchList').innerHTML = rows.map(r => `
    <div class="alch-row">
      <img src="${r.icon}" alt="${r.name}">
      <div class="alch-sym" data-id="${r.id}" title="${r.name}">${r.name}</div>
      <div class="alch-value">${abbreviateNumber(r.alchValue)}</div>
      <div class="alch-buy">${abbreviateNumber(r.buyPrice)}</div>
      <div class="alch-nat">${abbreviateNumber(r.natPrice)}</div>
      <div class="alch-profit ${r.profit > 0 ? 'positive' : 'negative'}">${fmtGp(r.profit)}</div>
    </div>
  `).join('');
  document.querySelectorAll('#alchList .alch-sym').forEach(el => {
    el.onclick = () => { const m = mapping.find(x => x.id == el.dataset.id); if (m) setItem(m); };
  });
}
async function buildSetsList() {
  const rows = [];
  for (const s of armorSets) {
    const setM = mapping.find(x => x.name.toLowerCase() === s.set_name.toLowerCase());
    if (!setM) continue;
    const setBuy = latest.data[setM.id]?.low ?? 0;
    let piecesSell = 0;
    let tax = 0;
    for (const comp of s.components) {
      const compM = mapping.find(x => x.name.toLowerCase() === comp.toLowerCase());
      if (!compM) continue;
      const high = latest.data[compM.id]?.high ?? 0;
      piecesSell += high;
      tax += Math.min(5000000, Math.floor(high * 0.01));
    }
    const profit = piecesSell - tax - setBuy; // Profit from buying set, unpacking, selling pieces
    rows.push({name: s.set_name, buy: setBuy, sell: piecesSell, profit, pieces: s.components.join(', ')});
  }
  rows.sort((a,b) => b.profit - a.profit);
  $('#setsList').innerHTML = rows.map(r => `
    <div class="sets-row">
      <div class="sets-sym" title="${r.name}">${r.name}</div>
      <div class="sets-buy">${abbreviateNumber(r.buy)}</div>
      <div class="sets-sell">${abbreviateNumber(r.sell)}</div>
      <div class="sets-profit ${r.profit > 0 ? 'positive' : 'negative'}">${fmtGp(r.profit)}</div>
      <div class="sets-pieces" style="font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${r.pieces}</div>
    </div>
  `).join('');
}
async function buildCraftList() {
  const goldBarPrice = latest.data[goldBarId]?.low ?? 0;
  const rows = [];
  for (const c of goldJewelry) {
    const itemM = mapping.find(x => x.name.toLowerCase() === c.item.toLowerCase());
    if (!itemM || (!membersOn && itemM.members)) continue;
    const sell = latest.data[itemM.id]?.high ?? 0;
    let buyCost = goldBarPrice;
    if (c.gem) {
      const gemM = mapping.find(x => x.name.toLowerCase() === `uncut ${c.gem}`.toLowerCase() || x.name.toLowerCase() === c.gem.toLowerCase());
      if (gemM) buyCost += latest.data[gemM.id]?.low ?? 0;
    }
    const tax = Math.min(5000000, Math.floor(sell * 0.01));
    const profit = sell - tax - buyCost;
    rows.push({id: itemM.id, name: c.item, level: c.level, exp: c.exp, buyCost, profit});
  }
  if (rows.length === 0) {
    $('#craftList').innerHTML = '<p>No F2P items available for crafting.</p>';
    return;
  }
  rows.sort((a,b) => b.profit - a.profit);
  $('#craftList').innerHTML = rows.map(r => `
    <div class="craft-row">
      <img src="${bigIconUrl(r.id)}" alt="${r.name}">
      <div class="craft-sym" data-id="${r.id}" title="${r.name}">${r.name}</div>
      <div class="craft-level">${r.level}</div>
      <div class="craft-exp">${r.exp}</div>
      <div class="craft-buy">${abbreviateNumber(r.buyCost)}</div>
      <div class="craft-profit ${r.profit > 0 ? 'positive' : 'negative'}">${fmtGp(r.profit)}</div>
    </div>
  `).join('');
}
async function buildEnchantList() {
  const rows = [];
  for (const e of enchantJewelry) {
    const baseM = mapping.find(x => x.name.toLowerCase() === e.base_item.toLowerCase());
    if (!baseM || (!membersOn && baseM.members)) continue;
    const enchM = mapping.find(x => x.name.toLowerCase() === e.enchanted_item.toLowerCase());
    if (!enchM || (!membersOn && enchM.members)) continue;
    const buyBase = latest.data[baseM.id]?.low ?? 0;
    const sellEnch = latest.data[enchM.id]?.high ?? 0;
    let runesCost = 0;
    // Parse runes, e.g. "1 Water rune, 1 Cosmic rune"
    const runes = e.runes.split(', ');
    for (const runeStr of runes) {
      const [amount, ...runeNameArr] = runeStr.split(' ');
      const runeName = runeNameArr.join(' ');
      const runeM = mapping.find(x => x.name.toLowerCase() === runeName.toLowerCase());
      if (runeM) runesCost += (parseInt(amount) || 1) * (latest.data[runeM.id]?.low ?? 0);
    }
    const tax = Math.min(5000000, Math.floor(sellEnch * 0.01));
    const profit = sellEnch - tax - buyBase - runesCost;
    rows.push({level: e.level, spell: e.spell, base: e.base_item, enchanted: e.enchanted_item, runes: e.runes, exp: e.exp, profit, id: enchM.id});
  }
  if (rows.length === 0) {
    $('#enchantList').innerHTML = '<p>No F2P items available for enchanting.</p>';
    return;
  }
  rows.sort((a,b) => b.profit - a.profit);
  $('#enchantList').innerHTML = rows.map(r => `
    <div class="enchant-row">
      <img src="${bigIconUrl(r.id)}" alt="${r.enchanted}">
      <div class="enchant-sym">${r.spell}</div>
      <div class="enchant-level">${r.level}</div>
      <div class="enchant-base">${r.base}</div>
      <div class="enchant-enchanted">${r.enchanted}</div>
      <div class="enchant-exp">${r.exp}</div>
      <div class="enchant-profit ${r.profit > 0 ? 'positive' : 'negative'}">${fmtGp(r.profit)}</div>
    </div>
  `).join('');
}
async function buildSmithList() {
  const rows = [];
  for (const s of smithItems) {
    if (!membersOn && s.level > 48) continue; // Assume steel max for F2P, adjust if needed
    const itemM = mapping.find(x => x.name.toLowerCase() === s.item.toLowerCase());
    if (!itemM) continue;
    const alchValue = await getAlchValue(itemM.id);
    const barPrice = latest.data[s.barId]?.low ?? 0;
    const buyCost = s.bars * barPrice;
    const profit = alchValue - buyCost;
    rows.push({id: itemM.id, name: s.item, bars: s.bars, level: s.level, exp: s.exp, alchValue, profit});
  }
  rows.sort((a,b) => b.profit - a.profit);
  $('#smithList').innerHTML = rows.map(r => `
    <div class="smith-row">
      <img src="${bigIconUrl(r.id)}" alt="${r.name}">
      <div class="smith-sym" data-id="${r.id}" title="${r.name}">${r.name}</div>
      <div class="smith-bars">${r.bars}</div>
      <div class="smith-level">${r.level}</div>
      <div class="smith-exp">${r.exp}</div>
      <div class="smith-alch">${abbreviateNumber(r.alchValue)}</div>
      <div class="smith-profit ${r.profit > 0 ? 'positive' : 'negative'}">${fmtGp(r.profit)}</div>
    </div>
  `).join('');
}
/* ---------- Popout Chart ---------- */
function popoutChart(){
  const popup = window.open('', '_blank', 'width=900,height=600');
  popup.document.write(`
    <html>
    <head><title>Chart Popout</title></head>
    <body style="margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,Inter,system-ui,Arial;">
    <div style="padding:10px;display:flex;flex-direction:column;height:100%;">
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;">
      <div class="viewtabs">
        <button data-view="day" class="active">Day</button>
        <button data-view="week">Week</button>
        <button data-view="month">Month</button>
      </div>
      <div class="tools" style="margin-left:auto;display:flex;gap:6px;align-items:center;">
        <span class="small">Zoom:</span><button id="zIn">+</button><button id="zOut">−</button>
        <span class="small" style="margin-left:10px">Mode:</span>
        <button id="lineMode" class="active">Line</button>
        <button id="dotMode">Scatter</button>
      </div>
    </div>
    <canvas id="popChart" style="flex:1;background:var(--grid);border:1px solid var(--edge);border-radius:12px;"></canvas>
    <div class="legend" style="display:flex;gap:12px;font-size:12px;margin-top:6px;color:var(--muted)">
      <span class="sell">Low (Buy)</span><span class="buy">High (Sell)</span>
    </div>
    <div id="foot" class="small" style="margin-top:6px"></div>
    </div>
    </body>
    </html>
  `);
  popup.document.head.appendChild(document.createElement('style')).textContent = document.querySelector('style').textContent;
  const popCanvas = popup.document.getElementById('popChart');
  popCanvas.width = 880;
  popCanvas.height = 480;
  const popCtx = popCanvas.getContext('2d');
  let popSeries = currentSeries;
  let popView = view;
  let popZoom = zoom;
  let popOffset = offset;
  let popDrawMode = drawMode;
  function popDraw() {
    drawChart(popSeries, popCtx, popCanvas, popZoom, popOffset, popDrawMode);
    popup.document.getElementById('foot').textContent = $("#foot").textContent;
  }
  popup.document.querySelectorAll('.viewtabs button').forEach(b=>{
    b.onclick=async ()=>{ 
      popup.document.querySelector('.viewtabs button.active').classList.remove("active");
      b.classList.add("active");
      popView = b.dataset.view;
      const step = (popView==="day"?"1h":popView==="week"?"6h":"24h");
      const ts = await loadTS(step, selected.id);
      popSeries = seriesFromTS(ts);
      popZoom = 1.5;
      popOffset = Math.max(0, (popSeries.labels.length - 60));
      popDraw();
    }
  });
  popup.document.getElementById("zIn").onclick = ()=>{ popZoom=Math.min(8, popZoom*1.25); popDraw(); };
  popup.document.getElementById("zOut").onclick= ()=>{ popZoom=Math.max(1, popZoom/1.25); popDraw(); };
  popup.document.getElementById("lineMode").onclick=()=>{ popDrawMode="line"; popup.document.getElementById("lineMode").classList.add("active"); popup.document.getElementById("dotMode").classList.remove("active"); popDraw(); };
  popup.document.getElementById("dotMode").onclick =()=>{ popDrawMode="dot"; popup.document.getElementById("dotMode").classList.add("active"); popup.document.getElementById("lineMode").classList.remove("active"); popDraw(); };
  popDraw();
}
/* ---------- Boot ---------- */
(async function boot(){
  try{
    $("#status").textContent="Fetching mapping…";
    mapping = await loadMapping();
    // Load categoryItems from categories.json
    let categoryItems = {}; // Default to empty
    try {
      const categoriesResponse = await fetch('./categories.json');
      categoryItems = await categoriesResponse.json();
    } catch (e) {
      console.warn("Failed to load categories.json:", e);
    }
    // Load watchlist
    let watchKey = membersOn ? 'watchlist_members' : 'watchlist_f2p';
    watchlist = JSON.parse(localStorage.getItem(watchKey)) || [];
    customWatchlist = JSON.parse(localStorage.getItem('customWatchlist')) || [];
    dismissed = [];
    const membersOnlyCategories = ['herbs', 'potions', '3rd-age-items', 'charging-items', 'mage-armour', 'melee-armour', 'range-armour'];
    const categorySelect = $("#categorySelect");
    function updateCategoryOptions() {
      categorySelect.innerHTML = '';
      const option = document.createElement('option');
      option.value = 'custom';
      option.textContent = 'Custom Watchlist';
      categorySelect.appendChild(option);
      Object.keys(categoryItems).forEach(cat => {
        if (cat !== 'custom' && (membersOn || !membersOnlyCategories.includes(cat))) {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat.replace(/-/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
          categorySelect.appendChild(option);
        }
      });
    }
    updateCategoryOptions(); // Call after loading categoryItems
    categorySelect.value = 'gems'; // Default, assuming 'gems' exists in categories.json
    const loadCategory = async (cat) => {
      if (cat === 'custom') {
        watchlist = customWatchlist;
      } else {
        const itemNames = categoryItems[cat] || []; // Now from loaded JSON
        watchlist = [];
        for (const name of itemNames) {
          const m = mapping.find(x => x.name.toLowerCase() === name.toLowerCase());
          if (m && (membersOn || !m.members)) watchlist.push(m.id);
        }
      }
      latest = await loadLatest();
      watchlist.sort((a,b) => {
        const pa = latest.data[a]?.high || 0;
        const pb = latest.data[b]?.high || 0;
        return pb - pa; // descending
      });
      localStorage.setItem(watchKey, JSON.stringify(watchlist));
      buildWatchlist();
    };
    loadCategory('gems');
    categorySelect.addEventListener('change', () => loadCategory(categorySelect.value));
    // Autocomplete
    const sb=$("#suggestBox");
    $("#query").addEventListener("input", ()=>{
      const q=$("#query").value.trim().toLowerCase();
      if(!q){ sb.style.display="none"; sb.innerHTML=""; return; }
      const list=mapping.filter(x=> (!membersOn && x.members ? false : true) && x.name.toLowerCase().includes(q)).slice(0,20);
      sb.innerHTML=list.map(x=>`<div data-id="${x.id}">${x.name}</div>`).join("");
      sb.style.display=list.length?"block":"none";
    });
    sb.addEventListener("click", (e)=>{
      const id=e.target?.dataset?.id;
      if(!id) return;
      const m=mapping.find(x=>String(x.id)===String(id));
      if(m){ sb.style.display="none"; setItem(m); }
    });
    // View buttons
    document.querySelectorAll(".viewtabs button").forEach(b=>{
      b.onclick=()=>{ 
        document.querySelector('.viewtabs button.active').classList.remove("active");
        b.classList.add("active");
        view = b.dataset.view;
        if (selected) setItem(selected);
      }
    });
    // Chart tools
    $("#zIn").onclick = ()=>{ zoom=Math.min(8, zoom*1.25); offset = currentSeries.labels.length - Math.floor(currentSeries.labels.length / zoom); drawChart(currentSeries); };
    $("#zOut").onclick= ()=>{ zoom=Math.max(1, zoom/1.25); offset = currentSeries.labels.length - Math.floor(currentSeries.labels.length / zoom); drawChart(currentSeries); };
    $("#lineMode").onclick=()=>{ drawMode="line"; $("#lineMode").classList.add("active"); $("#dotMode").classList.remove("active"); drawChart(currentSeries); };
    $("#dotMode").onclick =()=>{ drawMode="dot"; $("#dotMode").classList.add("active"); $("#lineMode").classList.remove("active"); drawChart(currentSeries); };
    $("#popoutBtn").onclick = () => popoutChart();
    // Mode pill for F2P/Members
    $("#btnF2P").onclick=()=>{
      membersOn=false; $("#btnF2P").classList.add("active"); $("#btnMembers").classList.remove("active");
      watchKey = 'watchlist_f2p';
      watchlist = JSON.parse(localStorage.getItem(watchKey)) || [];
      updateCategoryOptions();
      loadCategory(categorySelect.value);
      buildSidebar(); buildWatchlist(); buildAlchList(); buildSetsList(); buildCraftList(); buildEnchantList(); buildSmithList();
    };
    $("#btnMembers").onclick=()=>{
      membersOn=true; $("#btnMembers").classList.add("active"); $("#btnF2P").classList.remove("active");
      watchKey = 'watchlist_members';
      watchlist = JSON.parse(localStorage.getItem(watchKey)) || [];
      updateCategoryOptions();
      loadCategory(categorySelect.value);
      buildSidebar(); buildWatchlist(); buildAlchList(); buildSetsList(); buildCraftList(); buildEnchantList(); buildSmithList();
    };
    // Add to watchlist
    $("#addWatchBtn").onclick = ()=>{
      if(selected && !customWatchlist.includes(selected.id)){
        customWatchlist.push(selected.id);
        localStorage.setItem('customWatchlist', JSON.stringify(customWatchlist));
        if (categorySelect.value === 'custom') {
          buildWatchlist();
        }
        $("#addWatchBtn").disabled = true;
      }
    };
    // Next suggestion
    $("#nextSuggest").onclick = () => {
      suggestIndex = (suggestIndex + 1) % flipSuggestions.length;
      updateSmartSuggest();
    };
    // Refresh
    $("#refreshBtn").onclick=async ()=>{
      $("#loader-overlay").style.display = "flex";
      $("#status").textContent="Refreshing…";
      latest = await loadLatest();
      volumes = await loadVolumes();
      dismissed = [];
      await buildSidebar();
      buildWatchlist();
      if(selected) await setItem(selected);
      await buildAlchList();
      await buildSetsList();
      await buildCraftList();
      await buildEnchantList();
      await buildSmithList();
      $("#loader-overlay").style.display = "none";
      $("#status").textContent="Live data refreshed";
      setTimeout(()=>$("#status").textContent="Ready", 1200);
    };
    // Initial load
    latest = await loadLatest();
    volumes = await loadVolumes();
    await buildSidebar();
    buildWatchlist();
    // Preload a default item if present
    const gildedScimitar = mapping.find(x=>x.name.toLowerCase()==="gilded scimitar");
    if(gildedScimitar) setItem(gildedScimitar);
    // Color pickers
    const lowColorPicker = document.getElementById('lowColorPicker');
    const highColorPicker = document.getElementById('highColorPicker');
    const savedLowColor = localStorage.getItem('lowColor') || '#fb6a6a';
    const savedHighColor = localStorage.getItem('highColor') || '#5cc76a';
    document.documentElement.style.setProperty('--low-color', savedLowColor);
    document.documentElement.style.setProperty('--high-color', savedHighColor);
    lowColorPicker.value = savedLowColor;
    highColorPicker.value = savedHighColor;
    lowColorPicker.addEventListener('change', (e) => {
      document.documentElement.style.setProperty('--low-color', e.target.value);
      localStorage.setItem('lowColor', e.target.value);
      if (currentSeries) drawChart(currentSeries);
    });
    highColorPicker.addEventListener('change', (e) => {
      document.documentElement.style.setProperty('--high-color', e.target.value);
      localStorage.setItem('highColor', e.target.value);
      if (currentSeries) drawChart(currentSeries);
    });
    // Watchlist sorting
    let sortDirections = {symbol: 'desc', buy: 'desc', sell: 'desc'};
    function updateSortArrows() {
      $('#sortSymbol .sort-arrow').textContent = sortDirections.symbol === 'asc' ? '▲' : '▼';
      $('#sortBuy .sort-arrow').textContent = sortDirections.buy === 'asc' ? '▲' : '▼';
      $('#sortSell .sort-arrow').textContent = sortDirections.sell === 'asc' ? '▲' : '▼';
    }
    $("#sortSymbol").onclick = () => {
      sortDirections.symbol = sortDirections.symbol === 'asc' ? 'desc' : 'asc';
      buildWatchlist('name');
      updateSortArrows();
    };
    $("#sortBuy").onclick = () => {
      sortDirections.buy = sortDirections.buy === 'asc' ? 'desc' : 'asc';
      buildWatchlist('buy');
      updateSortArrows();
    };
    $("#sortSell").onclick = () => {
      sortDirections.sell = sortDirections.sell === 'asc' ? 'desc' : 'asc';
      buildWatchlist('sell');
      updateSortArrows();
    };
    updateSortArrows();
    // Tab switching
    const tabs = {
      faq: $('#faqContent'),
      alch: $('#alchContent'),
      sets: $('#setsContent'),
      crafting: $('#craftingTabContent'),
      enchanting: $('#enchantingContent'),
      smithing: $('#smithingContent'),
      contact: $('#contactContent')
    };
    const tabButtons = {
      faq: $('#faqTab'),
      alch: $('#alchTab'),
      sets: $('#setsTab'),
      crafting: $('#craftingTab'),
      enchanting: $('#enchantingTab'),
      smithing: $('#smithingTab'),
      contact: $('#contactTab')
    };
    function switchTab(tabName, buildFunc) {
      Object.values(tabButtons).forEach(btn => btn.classList.remove('active'));
      Object.values(tabs).forEach(content => content.classList.remove('active'));
      tabButtons[tabName].classList.add('active');
      tabs[tabName].classList.add('active');
      if (buildFunc) buildFunc();
    }
    $('#faqTab').onclick = () => switchTab('faq');
    $('#alchTab').onclick = () => switchTab('alch', buildAlchList);
    $('#setsTab').onclick = () => switchTab('sets', buildSetsList);
    $('#craftingTab').onclick = () => switchTab('crafting', buildCraftList);
    $('#enchantingTab').onclick = () => switchTab('enchanting', buildEnchantList);
    $('#smithingTab').onclick = () => switchTab('smithing', buildSmithList);
    $('#contactTab').onclick = () => switchTab('contact');
    // Initial alch build (optional; or lazy on tab)
    // New: Real-time price alerts (poll every 5 mins)
    let previousPrices = {}; // Store previous high prices
    watchlist.forEach(id => previousPrices[id] = latest.data[id]?.high || 0); // Initial
    setInterval(async () => {
      const newLatest = await loadLatest();
      watchlist.forEach(id => {
        const oldHi = previousPrices[id] || 0;
        const newHi = newLatest.data[id]?.high || 0;
        if (oldHi === 0) return;
        const changePercent = ((newHi - oldHi) / oldHi) * 100;
        const row = document.querySelector(`#watch .row [data-id="${id}"]`)?.parentNode;
        if (!row) return;
        row.style.border = '1px solid var(--edge)'; // Reset
        row.style.animation = 'none';
        if (changePercent <= -20) {
          row.style.border = '2px solid #8b0000'; // Dark red drop
        } else if (changePercent <= -10) {
          row.style.border = '2px solid #ff0000'; // Red drop
        } else if (changePercent <= -5) {
          row.style.border = '2px solid #ffff00'; // Yellow drop
        } else if (changePercent >= 20) {
          row.style.border = '2px solid #00ff00'; // Green gain + glow
          row.style.animation = 'glow 1.5s infinite alternate';
        } else if (changePercent >= 10) {
          row.style.border = '2px solid #00ff00'; // Green gain
        } else if (changePercent >= 5) {
          row.style.border = '2px solid #00ffff'; // Cyan gain
        }
        previousPrices[id] = newHi;
      });
      latest = newLatest; // Update global
      buildWatchlist(); // Refresh watchlist
      buildAlchList();
      buildSetsList();
      buildCraftList();
      buildEnchantList();
      buildSmithList();
    }, 300000); // 5 mins
  } catch (e) {
    console.error('Boot error:', e);
    try { $("#status").textContent = "Error"; } catch (_) {}
  }
})();
</script>
</body>
</html>