<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=5.0, user-scalable=yes"/>
<title>Grant Exchange - OSRS Charting Tool</title>
<meta name="description" content="Advanced charting tool for OSRS Grand Exchange items with indicators like Ichimoku Cloud, Volume Profile, and Volume. Analyze trends from 1 day to 5 years.">
<meta name="keywords" content="OSRS Grand Exchange, OSRS GE, RuneScape Grand Exchange, OSRS charting, OSRS price charts, OSRS indicators, Ichimoku Cloud OSRS, Volume Profile OSRS">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://grantexchange.net/">
<!-- Open Graph -->
<meta property="og:title" content="Grant Exchange - OSRS Charting Tool">
<meta property="og:description" content="Advanced charting tool for OSRS Grand Exchange items with indicators like Ichimoku Cloud, Volume Profile, and Volume. Analyze trends from 1 day to 5 years.">
<meta property="og:image" content="https://oldschool.runescape.wiki/images/Gilded_scimitar.png">
<meta property="og:url" content="https://grantexchange.net/">
<meta property="og:type" content="website">
<!-- Favicon -->
<link rel="icon" type="image/png" sizes="48x48" href="https://oldschool.runescape.wiki/images/Gilded_scimitar.png">
<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Grant Exchange - OSRS Charting Tool">
<meta name="twitter:description" content="Advanced charting tool for OSRS Grand Exchange items with indicators like Ichimoku Cloud, Volume Profile, and Volume. Analyze trends from 1 day to 5 years.">
<meta name="twitter:image" content="https://oldschool.runescape.wiki/images/Gilded_scimitar.png">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-43YM2RCX1R"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-43YM2RCX1R');
</script>
<style>
:root {
  --bg: #0d0d0d;
  --panel: #1a1a1a;
  --edge: #333333;
  --gold: #ffd700;
  --orange: #ff9900;
  --ink: #ffffff;
  --muted: #aaaaaa;
  --low-color: #ff4d4d;
  --high-color: #4dff4d;
  --grid: #222222;
  --accent: #ffff00;
  --shadow: #000000;
  --teal: #00ffff;
  --ichi-tenkan: #00bfff;
  --ichi-kijun: #ff69b4;
  --ichi-chikou: #32cd32;
  --ichi-senkou-a: #90ee90;
  --ichi-senkou-b: #ffb6c1;
  --cloud-green: rgba(144,238,144,0.2);
  --cloud-red: rgba(255,182,193,0.2);
}
* { box-sizing: border-box; }
html, body { height: 100%; }
body { margin: 0; background: var(--bg); color: var(--ink); font-family: Segoe UI, Inter, system-ui, Arial; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
.wrap { max-width: 1440px; margin: 24px auto; padding: 0 12px; min-height: calc(100vh - 48px); display: grid; grid-template-columns: 1fr; gap: 20px; align-items: start; }
.header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; gap: 16px; }
h1 { margin: 0; font-size: 28px; font-weight: 900; color: var(--orange); text-shadow: 0 1px 0 var(--shadow); cursor: pointer; }
.badge { font-size: 13px; border: 1px solid var(--edge); border-radius: 999px; padding: 3px 10px; color: var(--muted); background: var(--panel); }
.small { font-size: 13px; color: var(--muted); }
.card { background: linear-gradient(180deg, var(--panel) 0%, #111 100%); border: 1px solid var(--edge); border-radius: 20px; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.4); }
.left { display: flex; flex-direction: column; }
.hr { border: none; border-top: 1px solid var(--edge); margin: 12px 0; }
.top-row { display: flex; align-items: center; gap: 12px; }
.sbar { flex: 1; position: relative; }
.sbar input { width: 100%; background: var(--panel); border: 2px solid var(--edge); color: var(--ink); border-radius: 12px; padding: 14px 14px 14px 48px; font-size: 18px; outline: none; box-shadow: 0 0 0 0 rgba(255,153,0,0); transition: box-shadow .2s, border-color .2s; }
.sbar input:focus { border-color: var(--orange); box-shadow: 0 0 0 3px rgba(255,153,0,0.3); }
#itemIcon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; image-rendering: pixelated; }
.suggest { margin-top: 8px; border: 1px solid var(--edge); border-radius: 12px; max-height: 400px; overflow: auto; background: var(--panel); position: absolute; z-index: 10; width: 100%; left: 0; }
.suggest::-webkit-scrollbar { width: 6px; background: var(--bg); }
.suggest::-webkit-scrollbar-thumb { background: var(--edge); border-radius: 3px; }
.suggest div { display: flex; align-items: center; gap: 8px; padding: 10px 12px; border-bottom: 1px solid var(--grid); cursor: pointer; word-break: break-word; white-space: normal; word-wrap: break-word; }
.suggest div:hover { background: #222; }
.suggest img { width: 24px; height: 24px; image-rendering: pixelated; }
.price-box { background: var(--panel); border: 1px solid var(--edge); border-radius: 12px; padding: 10px; text-align: center; min-width: 160px; }
.price-box.low { color: var(--low-color); }
.price-box.high { color: var(--high-color); }
.price-box span { font-size: 22px; font-weight: bold; }
.toolbar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: flex-start; }
.toolbar button { background: var(--panel); border: 1px solid var(--edge); color: var(--ink); border-radius: 12px; padding: 8px 12px; cursor: pointer; text-transform: uppercase; font-weight: bold; font-size: 14px; transition: box-shadow .2s, border-color .2s; }
.toolbar button.active { background: #252525; box-shadow: 0 0 12px rgba(255,153,0,0.6); border-color: var(--orange); }
.toolbar button:focus { border-color: var(--orange); box-shadow: 0 0 0 3px rgba(255,153,0,0.3); }
.chartWrap { position: relative; }
.chart { width: 100%; height: 600px; background: repeating-linear-gradient(to bottom, rgba(255,255,255,0.04), rgba(255,255,255,0.04) 1px, transparent 1px, transparent 28px), var(--bg); border: 1px solid var(--edge); border-radius: 16px; }
.chart-tip { position: absolute; display: none; background: rgba(0,0,0,.9); color: #fff; padding: 8px 10px; border-radius: 8px; font-size: 13px; pointer-events: none; white-space: nowrap; border: 1px solid #111; }
.legend { display: flex; gap: 16px; font-size: 13px; margin-top: 8px; color: var(--muted); }
.legend span span { width: 12px; height: 12px; display: inline-block; border-radius: 3px; }
.legend .low span { background: var(--low-color); }
.legend .high span { background: var(--high-color); }
.btn-refresh { padding: 8px 12px; border-radius: 12px; border: 1px solid var(--edge); background: var(--panel); color: var(--ink); cursor: pointer; text-transform: uppercase; font-weight: bold; font-size: 14px; transition: box-shadow .2s, border-color .2s; }
.btn-refresh:hover { box-shadow: 0 0 12px rgba(255,153,0,0.6); border-color: var(--orange); }
.mode-pill button { background: var(--panel); border: 1px solid var(--edge); color: var(--ink); border-radius: 12px; padding: 8px 12px; cursor: pointer; text-transform: uppercase; font-weight: bold; font-size: 14px; transition: box-shadow .2s, border-color .2s; }
.mode-pill button.active { background: #252525; box-shadow: 0 0 12px rgba(255,153,0,0.6); border-color: var(--orange); }
.key-info h2 { margin: 0 0 10px; font-size: 18px; color: var(--gold); }
.info-grid { display: grid; grid-template-columns: auto auto; gap: 8px 20px; }
.info-grid div { font-size: 14px; }
.info-grid div:nth-child(odd) { color: var(--muted); text-align: right; }
.info-grid div:nth-child(even) { font-weight: bold; }
@keyframes rainbow { 
  0% {border-color: #ff0000;} 
  14% {border-color: #ff7f00;} 
  28% {border-color: #ffff00;} 
  42% {border-color: #00ff00;} 
  57% {border-color: #00ffff;} 
  71% {border-color: #0000ff;} 
  85% {border-color: #8b00ff;} 
  100% {border-color: #ff0000;} 
}
@media (max-width: 768px) {
  .top-row { flex-direction: column; gap: 12px; }
  .price-box { min-width: 0; width: 100%; }
  .toolbar { justify-content: center; }
  .chart { height: 400px; }
  .info-grid { grid-template-columns: 1fr; }
  .info-grid div:nth-child(odd) { text-align: left; }
}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div><h1 onclick="location.reload();">Grant Exchange</h1><span class="badge">v3.0 Final</span> <span class="badge">OSRS Charts</span></div>
    <div id="status" class="small">Ready</div>
    <div class="mode-pill">
      <button data-mode="f2p" id="btnF2P" class="active">F2P</button>
      <button data-mode="members" id="btnMembers">Members</button>
    </div>
  </div>
  <div class="card left">
    <div class="top-row">
      <div class="sbar">
        <img id="itemIcon" src="" alt="">
        <input id="query" placeholder="Search item...">
        <div id="suggestBox" class="suggest" style="display:none"></div>
      </div>
      <div id="buyPrice" class="price-box low">Buy Price<br><span>—</span></div>
      <div id="sellPrice" class="price-box high">Sell Price<br><span>—</span></div>
    </div>
    <div class="hr"></div>
    <div class="toolbar">
      <button data-view="1d" class="active view-btn">1D</button>
      <button data-view="1w" class="view-btn">1W</button>
      <button data-view="1m" class="view-btn">1M</button>
      <button data-view="6m" class="view-btn">6M</button>
      <button data-view="1y" class="view-btn">1Y</button>
      <button data-view="all" class="view-btn">ALL</button>
      <span class="small">Zoom:</span><button id="zIn">+</button><button id="zOut">−</button>
      <button id="lineMode" class="active">Line</button>
      <button id="dotMode">Dots</button>
      <button id="vpMode">VP</button>
      <button id="ichiMode">Ichimoku</button>
      <button id="refreshBtn" class="btn-refresh">Refresh</button>
    </div>
    <div class="chartWrap">
      <canvas id="chart" class="chart" width="980" height="600"></canvas>
      <div id="tip" class="chart-tip"></div>
    </div>
    <div class="legend">
      <span>Low: <span></span></span>
      <span>High: <span></span></span>
    </div>
    <div class="hr"></div>
    <div class="key-info">
      <h2>Key Info</h2>
      <div class="info-grid">
        <div>Buy Price</div><div id="keyBuyPrice">—</div>
        <div>Sell Price</div><div id="keySellPrice">—</div>
        <div>Volume</div><div id="keyVolume">—</div>
        <div>Limit</div><div id="keyLimit">—</div>
        <div>Tax</div><div id="keyTax">—</div>
        <div>Margin</div><div id="keyMargin">—</div>
        <div>ROI</div><div id="keyROI">—</div>
        <div>Potential Profit</div><div id="keyPotProfit">—</div>
      </div>
    </div>
  </div>
</div>
<script>
const $ = s => document.querySelector(s);
const API = "https://prices.runescape.wiki/api/v1/osrs";
let mapping = [], latest = null, volumes = null, selected = null;
let currentSeries = null, view = "1d", zoom = 1.5, offset = 0, drawMode = "line";
let vpActive = false, ichiActive = false;
let membersOn = false;
const canvas = document.getElementById("chart");
const ctx = canvas.getContext("2d");
const tip = document.getElementById("tip");
const fmtGp = n => n == null ? "—" : Number(n).toLocaleString() + " gp";
const fmtNum = n => n == null ? "—" : Number(n).toLocaleString();
const abbreviateNumber = (num) => {
  if (num >= 1e9) {
    return (num / 1e9).toFixed(1).replace(/\.0$/, '') + 'b';
  }
  if (num >= 1e6) {
    return (num / 1e6).toFixed(1).replace(/\.0$/, '') + 'm';
  }
  if (num >= 1e3) {
    return (num / 1e3).toFixed(1).replace(/\.0$/, '') + 'k';
  }
  return num.toLocaleString();
};
async function jget(url) {
  const r = await fetch(url, { cache: "default" });
  if (!r.ok) throw new Error(url + " HTTP " + r.status);
  return await r.json();
}
const loadMapping = () => jget(API + "/mapping");
const loadLatest = () => jget(API + "/latest");
const loadVolumes = () => jget(API + "/volumes");
const loadTS = (step, id) => jget(API + `/timeseries?timestep=${step}&id=${id}`);
function bigIconUrl(id) {
  return `https://oldschool.runescape.wiki/images/${id}.png?${id}`;
}
function suggestPrices(low, high) {
  if (low == null || high == null) return { buyMin: null, buyMax: null, sellMin: null, sellMax: null };
  const spread = high - low;
  let buyMargin = Math.max(1, Math.floor(spread * 0.1));
  let sellMargin = Math.max(1, Math.floor(spread * 0.1));
  if (high < 100) {
    buyMargin = 2;
    sellMargin = 4;
  } else if (high < 1000) {
    buyMargin = 5;
    sellMargin = 10;
  } else if (high < 10000) {
    buyMargin = 10;
    sellMargin = 20;
  } else {
    buyMargin = Math.floor(high * 0.005);
    sellMargin = Math.floor(high * 0.01);
  }
  const buyMin = Math.max(1, low - buyMargin);
  const buyMax = low;
  let sellMin = high;
  let sellMax = Math.max(1, high + sellMargin);
  const tax = 0.01;
  const minSell = Math.ceil(buyMax / (1 - tax)) + 1;
  sellMin = Math.max(sellMin, minSell);
  sellMax = Math.max(sellMax, minSell + Math.max(2, Math.floor(sellMargin / 2)));
  return { buyMin, buyMax, sellMin, sellMax };
}
function seriesFromTS(ts) {
  const src = ts?.data || [];
  const rows = src.map(r => ({
    t: Number(r.timestamp ?? r.ts ?? r.time),
    lo: r.avgLowPrice ?? r.low ?? null,
    hi: r.avgHighPrice ?? r.high ?? null,
    vol: r.lowPriceVolume ?? r.highPriceVolume ?? r.volume ?? null
  })).filter(r => r.t && (r.lo != null || r.hi != null)).sort((a, b) => a.t - b.t);
  return { labels: rows.map(r => r.t), low: rows.map(r => r.lo), high: rows.map(r => r.hi), vol: rows.map(r => r.vol ?? 0) };
}
function ypx(v, vmin, vmax, y0, h) {
  if (vmin === vmax) return y0 + h / 2;
  const p = (v - vmin) / (vmax - vmin);
  return y0 + (1 - p) * h;
}
function linearRegression(x, y) {
  const n = x.length;
  const sumX = x.reduce((a, b) => a + b, 0);
  const sumY = y.reduce((a, b) => a + b, 0);
  const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
  const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
  const meanX = sumX / n;
  const meanY = sumY / n;
  const slope = (sumXY - n * meanX * meanY) / (sumX2 - n * meanX * meanX);
  const intercept = meanY - slope * meanX;
  return { slope, intercept };
}
function calculateIchimoku(series) {
  const mid = series.labels.map((_, i) => (series.low[i] + series.high[i]) / 2);
  const getHigh = (arr, start, end) => Math.max(...arr.slice(Math.max(0, start), end));
  const getLow = (arr, start, end) => Math.min(...arr.slice(Math.max(0, start), end));
  const tenkan = Array(mid.length).fill(null);
  const kijun = Array(mid.length).fill(null);
  const senkouA = Array(mid.length).fill(null);
  const senkouB = Array(mid.length).fill(null);
  const chikou = Array(26).fill(null).concat(mid.slice(0, mid.length - 26)); // shifted back
  const len = mid.length;
  for (let i = 8; i < len; i++) {
    tenkan[i] = (getHigh(mid, i - 8, i + 1) + getLow(mid, i - 8, i + 1)) / 2;
  }
  for (let i = 25; i < len; i++) {
    kijun[i] = (getHigh(mid, i - 25, i + 1) + getLow(mid, i - 25, i + 1)) / 2;
  }
  for (let i = 25; i < len; i++) {
    senkouA[i + 26] = (tenkan[i] + kijun[i]) / 2;
  }
  for (let i = 51; i < len; i++) {
    senkouB[i + 26] = (getHigh(mid, i - 51, i + 1) + getLow(mid, i - 51, i + 1)) / 2;
  }
  return { tenkan, kijun, senkouA, senkouB, chikou };
}
function drawChart(series, context = ctx, can = canvas, z = zoom, off = offset, mode = drawMode) {
  const c = can;
  const W = c.width, H = c.height;
  const x0 = 60, y0 = 30, w = W - x0 - 14, h = H - y0 - 42;
  context.clearRect(0, 0, W, H);
  if (!series || !series.labels?.length) { 
    context.fillStyle = "#fff"; 
    context.font = "bold 16px Segoe UI, Arial";
    context.fillText("No data available", W/2 - 80, H/2); 
    return; 
  }
  const n = series.labels.length;
  const win = Math.max(12, Math.floor(n / z));
  offset = Math.max(0, Math.min(n - win, offset));
  const start = offset;
  const end = start + win;
  const L = series.labels.slice(start, end);
  const LO = series.low.slice(start, end);
  const HI = series.high.slice(start, end);
  const VO = (series.vol || []).slice(start, end);
  const vals = [...LO, ...HI].filter(v => v != null);
  if (!vals.length) { 
    context.fillStyle = "#fff"; 
    context.font = "bold 16px Segoe UI, Arial";
    context.fillText("No price data", W/2 - 70, H/2); 
    return; 
  }
  let vmin = Math.min(...vals), vmax = Math.max(...vals);
  if (vmin === vmax) { vmin -= 1; vmax += 1; }
  context.strokeStyle = "#000"; context.globalAlpha = 0.5;
  context.beginPath(); context.moveTo(x0, y0); context.lineTo(x0, y0 + h); context.lineTo(x0 + w, y0 + h); context.stroke();
  context.globalAlpha = 1;
  context.fillStyle = "#fff"; context.font = "bold 14px Segoe UI, Arial";
  const lines = 5;
  for (let i = 0; i <= lines; i++) {
    const y = y0 + (h * i / lines);
    context.strokeStyle = "rgba(255,255,255,0.06)";
    context.beginPath(); context.moveTo(x0, y); context.lineTo(x0 + w, y); context.stroke();
  }
  const stepX = w / Math.max(1, (L.length - 1));
  function drawSeries(arr, color, mode) {
    context.strokeStyle = color;
    context.fillStyle = color;
    if (mode === "line") {
      context.beginPath();
      for (let i = 0; i < arr.length; i++) {
        const v = arr[i]; if (v == null) continue;
        const x = x0 + i * stepX;
        const y = ypx(v, vmin, vmax, y0, h);
        if (i === 0) context.moveTo(x, y); else context.lineTo(x, y);
      }
      context.lineWidth = 2; context.stroke();
    } else if (mode === "dot") { // scatter
      for (let i = 0; i < arr.length; i++) {
        const v = arr[i]; if (v == null) continue;
        const x = x0 + i * stepX;
        const y = ypx(v, vmin, vmax, y0, h);
        context.beginPath(); context.arc(x, y, 3, 0, Math.PI * 2); context.fill();
      }
    }
  }
  const h_price = h * 0.8;
  const h_vol = h * 0.2;
  const y0_vol = y0 + h_price;
  if (drawMode === "line") {
    drawSeries(LO, getComputedStyle(document.documentElement).getPropertyValue('--low-color').trim(), "line");
    drawSeries(HI, getComputedStyle(document.documentElement).getPropertyValue('--high-color').trim(), "line");
  } else if (drawMode === "dot") {
    drawSeries(LO, getComputedStyle(document.documentElement).getPropertyValue('--low-color').trim(), "dot");
    drawSeries(HI, getComputedStyle(document.documentElement).getPropertyValue('--high-color').trim(), "dot");
    // Draw volume bars
    const maxVol = Math.max(...VO);
    for (let i = 0; i < VO.length; i++) {
      const v = VO[i];
      if (v == null) continue;
      const x = x0 + i * stepX - stepX / 4;
      const width = stepX / 2;
      const height = (v / maxVol) * h_vol;
      context.fillStyle = '#fff';
      context.fillRect(x, y0_vol + h_vol - height, width, height);
    }
  }
  if (vpActive) {
    const mid = L.map((_, i) => (LO[i] + HI[i]) / 2);
    const numBins = 20;
    const binSize = (vmax - vmin) / numBins;
    const bins = Array(numBins).fill(0);
    for (let i = 0; i < mid.length; i++) {
      const p = mid[i];
      if (p == null) continue;
      const binIndex = Math.min(numBins - 1, Math.floor((p - vmin) / binSize));
      bins[binIndex] += VO[i];
    }
    const maxBin = Math.max(...bins);
    for (let i = 0; i < numBins; i++) {
      const binVol = bins[i];
      const binCenter = vmin + (i + 0.5) * binSize;
      const y = ypx(binCenter, vmin, vmax, y0, h);
      const binH = (h / (vmax - vmin)) * binSize;
      const binW = (binVol / maxBin) * 100;
      context.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
      context.fillRect(x0 + w + 10, y - binH / 2, binW, binH);
    }
  }
  if (ichiActive) {
    const ichi = calculateIchimoku({low: LO, high: HI, labels: L});
    // Draw cloud
    for (let i = 0; i < L.length; i++) {
      if (ichi.senkouA[i] == null || ichi.senkouB[i] == null) continue;
      const y1 = ypx(ichi.senkouA[i], vmin, vmax, y0, h);
      const y2 = ypx(ichi.senkouB[i], vmin, vmax, y0, h);
      const color = ichi.senkouA[i] > ichi.senkouB[i] ? 'rgba(144,238,144,0.2)' : 'rgba(255,182,193,0.2)';
      context.fillStyle = color;
      context.fillRect(x0 + i * stepX - stepX / 2, Math.min(y1, y2), stepX, Math.abs(y1 - y2));
    }
    drawSeries(ichi.tenkan, getComputedStyle(document.documentElement).getPropertyValue('--ichi-tenkan').trim(), "line");
    drawSeries(ichi.kijun, getComputedStyle(document.documentElement).getPropertyValue('--ichi-kijun').trim(), "line");
    drawSeries(ichi.chikou, getComputedStyle(document.documentElement).getPropertyValue('--ichi-chikou').trim(), "line");
    drawSeries(ichi.senkouA, getComputedStyle(document.documentElement).getPropertyValue('--ichi-senkou-a').trim(), "line");
    drawSeries(ichi.senkouB, getComputedStyle(document.documentElement).getPropertyValue('--ichi-senkou-b').trim(), "line");
  }
  function drawPrediction(arr, color) {
    const nonNull = arr.map((v, i) => ({v, i})).filter(({v}) => v != null);
    if (nonNull.length < 2) return;
    const xVals = nonNull.map(({i}) => i);
    const yVals = nonNull.map(({v}) => v);
    const { slope, intercept } = linearRegression(xVals, yVals);
    context.save();
    context.setLineDash([6, 6]);
    context.strokeStyle = color;
    context.beginPath();
    const startX = x0;
    const startY = ypx(slope * 0 + intercept, vmin, vmax, y0, h);
    const endX = x0 + (arr.length - 1) * stepX + stepX * 0.2;
    const endY = ypx(slope * (arr.length - 1 + (arr.length * 0.2)) + intercept, vmin, vmax, y0, h);
    context.moveTo(startX, startY);
    context.lineTo(endX, endY);
    context.stroke();
    context.restore();
  }
  drawPrediction(LO, getComputedStyle(document.documentElement).getPropertyValue('--low-color').trim());
  drawPrediction(HI, getComputedStyle(document.documentElement).getPropertyValue('--high-color').trim());
  context.fillStyle = "#fff"; context.font = "bold 14px Segoe UI, Arial";
  for (let i = 0; i <= lines; i++) {
    const y = y0 + (h * i / lines);
    const v = Math.round(vmax - (vmax - vmin) * i / lines);
    context.fillText(abbreviateNumber(v), 6, y - 4);
  }
  context.fillStyle = "#fff"; context.font = "bold 12px Segoe UI, Arial";
  const numLabels = 6;
  const labelStep = Math.floor(L.length / (numLabels - 1)) || 1;
  for (let i = 0; i < L.length; i += labelStep) {
    const dateStr = new Date(L[i] * 1000).toLocaleDateString();
    const x = x0 + i * stepX;
    context.fillText(dateStr, x - 20, H - 10);
  }
  let isDragging = false;
  let startX = 0;
  c.onmousedown = (ev) => {
    isDragging = true;
    startX = ev.clientX;
  };
  c.onmouseup = () => isDragging = false;
  c.onmouseleave = () => { isDragging = false; tip.style.display = "none"; };
  c.onmousemove = (ev) => {
    const rect = c.getBoundingClientRect();
    const mx = ev.clientX - rect.left, my = ev.clientY - rect.top;
    if (isDragging) {
      const dx = ev.clientX - startX;
      startX = ev.clientX;
      const pointWidth = w / (end - start);
      offset -= dx / pointWidth;
      offset = Math.max(0, Math.min(n - win, offset));
      drawChart(series);
      return;
    }
    if (mx < x0 || mx > x0 + w || my < y0 || my > y0 + h) { tip.style.display = "none"; return; }
    const idx = Math.max(0, Math.min(L.length - 1, Math.round((mx - x0) / stepX)));
    const t = L[idx] * 1000;
    const lo = LO[idx], hi = HI[idx], vol = VO[idx] || 0;
    tip.style.display = "block";
    tip.style.left = (mx + 12) + "px";
    tip.style.top = (my - 10) + "px";
    tip.innerHTML = `<strong>${new Date(t).toLocaleString()}</strong><br/>
      Low: ${fmtGp(lo)}<br/>
      High: ${fmtGp(hi)}<br/>
      Vol: ${fmtNum(vol)}`;
  };
  c.onwheel = (ev) => {
    ev.preventDefault();
    const delta = ev.deltaY < 0 ? 1.25 : 0.8;
    zoom *= delta;
    zoom = Math.max(1, Math.min(8, zoom));
    drawChart(series);
  };
}
async function setItem(m) {
  selected = m;
  $("#query").value = m.name;
  document.title = `${m.name} - Grant Exchange`;
  $("#itemIcon").src = bigIconUrl(m.id);
  $("#status").textContent = "Loading latest…";
  latest = await loadLatest();
  volumes = await loadVolumes();
  const node = latest.data[String(m.id)];
  const lo = node?.low ?? node?.avgLowPrice ?? null;
  const hi = node?.high ?? node?.avgHighPrice ?? null;
  $("#buyPrice span").textContent = fmtGp(lo);
  $("#sellPrice span").textContent = fmtGp(hi);
  $("#status").textContent = "Loading chart…";
  const step = (view === "1d" ? "1h" : view === "1w" ? "6h" : "24h");
  const ts = await loadTS(step, m.id);
  currentSeries = seriesFromTS(ts);
  offset = Math.max(0, (currentSeries.labels.length - Math.floor(currentSeries.labels.length / zoom)));
  drawChart(currentSeries);
  const vol = volumes.data[String(m.id)] || 0;
  const limit = selected.buy_limit || 0;
  const tax = hi ? Math.floor(hi * 0.01) : 0;
  const margin = hi && lo ? hi - lo - tax : 0;
  const roi = lo ? ((margin / lo) * 100).toFixed(2) + '%' : '0%';
  const potProfit = margin * limit;
  $("#keyBuyPrice").textContent = fmtGp(lo);
  $("#keySellPrice").textContent = fmtGp(hi);
  $("#keyVolume").textContent = fmtNum(vol);
  $("#keyLimit").textContent = fmtNum(limit);
  $("#keyTax").textContent = fmtGp(tax);
  $("#keyMargin").textContent = (margin > 0 ? '+' : '') + fmtGp(margin);
  $("#keyROI").textContent = (margin > 0 ? '+' : '') + roi;
  $("#keyPotProfit").textContent = (margin > 0 ? '+' : '') + fmtGp(potProfit);
  $("#status").textContent = "Ready";
}
(async function boot() {
  try {
    mapping = await loadMapping();
    latest = await loadLatest();
    volumes = await loadVolumes();
    const sb = $("#suggestBox");
    $("#query").addEventListener("input", () => {
      const q = $("#query").value.trim().toLowerCase();
      if (!q) { sb.style.display = "none"; sb.innerHTML = ""; return; }
      const list = mapping.filter(x => x.name.toLowerCase().includes(q)).slice(0, 20);
      sb.innerHTML = list.map(x => `<div data-id="${x.id}"><img src="${bigIconUrl(x.id)}">${x.name}</div>`).join("");
      sb.style.display = list.length ? "block" : "none";
    });
    sb.addEventListener("click", (e) => {
      const id = e.target.closest('div')?.dataset?.id;
      if (!id) return;
      const m = mapping.find(x => String(x.id) === String(id));
      if (m) { sb.style.display = "none"; setItem(m); }
    });
    document.querySelectorAll(".view-btn").forEach(b => {
      b.onclick = () => {
        document.querySelectorAll(".view-btn").forEach(x => x.classList.remove("active"));
        b.classList.add("active");
        view = b.dataset.view;
        if (selected) setItem(selected);
      }
    });
    $("#zIn").onclick = () => { zoom = Math.min(8, zoom * 1.25); drawChart(currentSeries); };
    $("#zOut").onclick = () => { zoom = Math.max(1, zoom / 1.25); drawChart(currentSeries); };
    $("#lineMode").onclick = () => {
      if ($("#dotMode").classList.contains("active")) $("#dotMode").classList.remove("active");
      $("#lineMode").classList.add("active");
      drawMode = "line";
      drawChart(currentSeries);
    };
    $("#dotMode").onclick = () => {
      if ($("#lineMode").classList.contains("active")) $("#lineMode").classList.remove("active");
      $("#dotMode").classList.add("active");
      drawMode = "dot";
      drawChart(currentSeries);
    };
    $("#vpMode").onclick = () => {
      vpActive = !vpActive;
      if (vpActive) $("#vpMode").classList.add("active"); else $("#vpMode").classList.remove("active");
      drawChart(currentSeries);
    };
    $("#ichiMode").onclick = () => {
      ichiActive = !ichiActive;
      if (ichiActive) $("#ichiMode").classList.add("active"); else $("#ichiMode").classList.remove("active");
      drawChart(currentSeries);
    };
    $("#btnF2P").onclick = () => {
      membersOn = false;
      $("#btnF2P").classList.add("active");
      $("#btnMembers").classList.remove("active");
      if (selected) setItem(selected);
    };
    $("#btnMembers").onclick = () => {
      membersOn = true;
      $("#btnMembers").classList.add("active");
      $("#btnF2P").classList.remove("active");
      if (selected) setItem(selected);
    };
    $("#refreshBtn").onclick = async () => {
      $("#status").textContent = "Refreshing…";
      latest = await loadLatest();
      volumes = await loadVolumes();
      if (selected) await setItem(selected);
      $("#status").textContent = "Ready";
    };
    const gildedScimitar = mapping.find(x => x.name.toLowerCase() === "gilded scimitar");
    if (gildedScimitar) setItem(gildedScimitar);
  } catch (e) {
    console.error('Boot error:', e);
    $("#status").textContent = "Error";
  }
})();
</script>
</body>
</html>