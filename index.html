<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=5.0, user-scalable=yes"/>
<title>Grant Exchange - OSRS Charting Tool</title>
<meta name="description" content="Advanced charting tool for OSRS Grand Exchange items with indicators like Ichimoku Cloud, Volume Profile, and Volume. Analyze trends from 1 day to 5 years.">
<meta name="keywords" content="OSRS Grand Exchange, OSRS GE, RuneScape Grand Exchange, OSRS charting, OSRS price charts, OSRS indicators, Ichimoku Cloud OSRS, Volume Profile OSRS">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://grantexchange.net/">
<!-- Open Graph -->
<meta property="og:title" content="Grant Exchange - OSRS Charting Tool">
<meta property="og:description" content="Advanced charting tool for OSRS Grand Exchange items with indicators like Ichimoku Cloud, Volume Profile, and Volume. Analyze trends from 1 day to 5 years.">
<meta property="og:image" content="https://oldschool.runescape.wiki/images/Gilded_scimitar.png">
<meta property="og:url" content="https://grantexchange.net/">
<meta property="og:type" content="website">
<!-- Favicon -->
<link rel="icon" type="image/png" sizes="48x48" href="https://oldschool.runescape.wiki/images/Gilded_scimitar.png">
<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Grant Exchange - OSRS Charting Tool">
<meta name="twitter:description" content="Advanced charting tool for OSRS Grand Exchange items with indicators like Ichimoku Cloud, Volume Profile, and Volume. Analyze trends from 1 day to 5 years.">
<meta name="twitter:image" content="https://oldschool.runescape.wiki/images/Gilded_scimitar.png">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-43YM2RCX1R"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-43YM2RCX1R');
</script>
<style>
:root {
  --bg: #0d0d0d;
  --panel: #1a1a1a;
  --edge: #333333;
  --gold: #ffd700;
  --orange: #ff9900;
  --ink: #ffffff;
  --muted: #aaaaaa;
  --low-color: #ff4d4d;
  --high-color: #4dff4d;
  --grid: #222222;
  --accent: #ffff00;
  --shadow: #000000;
  --teal: #00ffff;
  --ichi-tenkan: #00bfff;
  --ichi-kijun: #ff69b4;
  --ichi-chikou: #32cd32;
  --ichi-senkou-a: #90ee90;
  --ichi-senkou-b: #ffb6c1;
  --cloud-green: rgba(144,238,144,0.2);
  --cloud-red: rgba(255,182,193,0.2);
}
* { box-sizing: border-box; }
html, body { height: 100%; }
body { margin: 0; background: var(--bg); color: var(--ink); font-family: Segoe UI, Inter, system-ui, Arial; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
.wrap { max-width: 1440px; margin: 24px auto; padding: 0 12px; min-height: calc(100vh - 48px); display: grid; grid-template-columns: 1fr; gap: 20px; align-items: start; }
.header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; gap: 16px; }
h1 { margin: 0; font-size: 28px; font-weight: 900; color: var(--orange); text-shadow: 0 1px 0 var(--shadow); cursor: pointer; }
.badge { font-size: 13px; border: 1px solid var(--edge); border-radius: 999px; padding: 3px 10px; color: var(--muted); background: var(--panel); }
.small { font-size: 13px; color: var(--muted); }
.card { background: linear-gradient(180deg, var(--panel) 0%, #111 100%); border: 1px solid var(--edge); border-radius: 20px; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.4); }
.left { display: flex; flex-direction: column; }
.hr { border: none; border-top: 1px solid var(--edge); margin: 12px 0; }
.top-row { display: flex; align-items: center; gap: 12px; }
.sbar { flex: 1; position: relative; }
.sbar input { width: 100%; background: var(--panel); border: 2px solid var(--edge); color: var(--ink); border-radius: 12px; padding: 14px 14px 14px 48px; font-size: 18px; outline: none; box-shadow: 0 0 0 0 rgba(255,153,0,0); transition: box-shadow .2s, border-color .2s; }
.sbar input:focus { border-color: var(--orange); box-shadow: 0 0 0 3px rgba(255,153,0,0.3); }
#itemIcon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; image-rendering: pixelated; }
.suggest { margin-top: 8px; border: 1px solid var(--edge); border-radius: 12px; max-height: 400px; overflow: auto; background: var(--panel); position: absolute; z-index: 10; width: 100%; left: 0; }
.suggest::-webkit-scrollbar { width: 6px; background: var(--bg); }
.suggest::-webkit-scrollbar-thumb { background: var(--edge); border-radius: 3px; }
.suggest div { display: flex; align-items: center; gap: 8px; padding: 10px 12px; border-bottom: 1px solid var(--grid); cursor: pointer; word-break: break-word; white-space: normal; word-wrap: break-word; }
.suggest div:hover { background: #222; }
.suggest img { width: 24px; height: 24px; image-rendering: pixelated; }
.price-box { background: var(--panel); border: 1px solid var(--edge); border-radius: 12px; padding: 10px; text-align: center; min-width: 160px; }
.price-box.low { color: var(--low-color); }
.price-box.high { color: var(--high-color); }
.price-box span { font-size: 22px; font-weight: bold; }
.toolbar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: flex-start; }
.toolbar button { background: var(--panel); border: 1px solid var(--edge); color: var(--ink); border-radius: 12px; padding: 8px 12px; cursor: pointer; text-transform: uppercase; font-weight: bold; font-size: 14px; transition: box-shadow .2s, border-color .2s; }
.toolbar button.active { background: #252525; box-shadow: 0 0 12px rgba(255,153,0,0.6); border-color: var(--orange); }
.toolbar button:focus { border-color: var(--orange); box-shadow: 0 0 0 3px rgba(255,153,0,0.3); }
.chartWrap { position: relative; }
.chart { width: 100%; height: 600px; background: var(--bg); border: 1px solid var(--edge); border-radius: 16px; }
.chart-tip { position: absolute; display: none; background: rgba(0,0,0,.9); color: #fff; padding: 8px 10px; border-radius: 8px; font-size: 13px; pointer-events: none; white-space: nowrap; border: 1px solid #111; }
.legend { display: flex; gap: 16px; font-size: 13px; margin-top: 8px; color: var(--muted); }
.legend span span { width: 12px; height: 12px; display: inline-block; border-radius: 3px; }
.legend .low span { background: var(--low-color); }
.legend .high span { background: var(--high-color); }
.btn-refresh { padding: 8px 12px; border-radius: 12px; border: 1px solid var(--edge); background: var(--panel); color: var(--ink); cursor: pointer; text-transform: uppercase; font-weight: bold; font-size: 14px; transition: box-shadow .2s, border-color .2s; }
.btn-refresh:hover { box-shadow: 0 0 12px rgba(255,153,0,0.6); border-color: var(--orange); }
.mode-pill button { background: var(--panel); border: 1px solid var(--edge); color: var(--ink); border-radius: 12px; padding: 8px 12px; cursor: pointer; text-transform: uppercase; font-weight: bold; font-size: 14px; transition: box-shadow .2s, border-color .2s; }
.mode-pill button.active { background: #252525; box-shadow: 0 0 12px rgba(255,153,0,0.6); border-color: var(--orange); }
.key-info h2 { margin: 0 0 10px; font-size: 18px; color: var(--gold); }
.info-grid { display: grid; grid-template-columns: auto auto; gap: 8px 20px; }
.info-grid div { font-size: 14px; }
.info-grid div:nth-child(odd) { color: var(--muted); text-align: right; }
.info-grid div:nth-child(even) { font-weight: bold; }
@keyframes rainbow { 
  0% {border-color: #ff0000;} 
  14% {border-color: #ff7f00;} 
  28% {border-color: #ffff00;} 
  42% {border-color: #00ff00;} 
  57% {border-color: #00ffff;} 
  71% {border-color: #0000ff;} 
  85% {border-color: #8b00ff;} 
  100% {border-color: #ff0000;} 
}
@media (max-width: 768px) {
  .top-row { flex-direction: column; gap: 12px; }
  .price-box { min-width: 0; width: 100%; }
  .toolbar { justify-content: center; }
  .chart { height: 400px; }
  .info-grid { grid-template-columns: 1fr; }
  .info-grid div:nth-child(odd) { text-align: left; }
}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div><h1 onclick="location.reload();">Grant Exchange</h1><span class="badge">v3.0 Final</span> <span class="badge">OSRS Charts</span></div>
    <div id="status" class="small">Ready</div>
    <div class="mode-pill">
      <button data-mode="f2p" id="btnF2P" class="active">F2P</button>
      <button data-mode="members" id="btnMembers">Members</button>
    </div>
  </div>
  <div class="card left">
    <div class="top-row">
      <div class="sbar">
        <img id="itemIcon" src="" alt="">
        <input id="query" placeholder="Search item...">
        <div id="suggestBox" class="suggest" style="display:none"></div>
      </div>
      <div id="buyPrice" class="price-box low">Buy Price<br><span>—</span></div>
      <div id="sellPrice" class="price-box high">Sell Price<br><span>—</span></div>
    </div>
    <div class="hr"></div>
    <div class="toolbar">
      <button data-view="1d" class="active view-btn">1D</button>
      <button data-view="1w" class="view-btn">1W</button>
      <button data-view="1m" class="view-btn">1M</button>
      <button data-view="6m" class="view-btn">6M</button>
      <button data-view="1y" class="view-btn">1Y</button>
      <button data-view="all" class="view-btn">5Y</button>
      <span class="small">Zoom:</span><button id="zIn">+</button><button id="zOut">−</button>
      <button id="lineMode" class="active">Line</button>
      <button id="dotMode">Dots</button>
      <button id="vpMode">VP</button>
      <button id="ichiMode">Ichimoku</button>
      <button id="refreshBtn" class="btn-refresh">Refresh</button>
    </div>
    <div class="chartWrap">
      <canvas id="chart" class="chart" width="980" height="600"></canvas>
      <div id="tip" class="chart-tip"></div>
    </div>
    <div class="legend">
      <span>Low: <span></span></span>
      <span>High: <span></span></span>
    </div>
    <div class="hr"></div>
    <div class="key-info">
      <h2>Key Info</h2>
      <div class="info-grid">
        <div>Buy Price</div><div id="keyBuyPrice">—</div>
        <div>Sell Price</div><div id="keySellPrice">—</div>
        <div>Volume</div><div id="keyVolume">—</div>
        <div>Limit</div><div id="keyLimit">—</div>
        <div>Tax</div><div id="keyTax">—</div>
        <div>Margin</div><div id="keyMargin">—</div>
        <div>ROI</div><div id="keyROI">—</div>
        <div>Potential Profit</div><div id="keyPotProfit">—</div>
      </div>
    </div>
  </div>
</div>
<script>
// Code from previous response
var $ = function(s) { return document.querySelector(s); }
var PRICES_API = "https://prices.runescape.wiki/api/v1/osrs";
var WEIRD_GLOOP_API = "https://api.weirdgloop.org/exchange/history/osrs";
var mapping = [], latest = null, volumes = null, selected = null;
var currentSeries = null, view = "1d", zoom = 1.5, offset = 0, drawMode = "line";
var vpActive = false, ichiActive = false;
var membersOn = false;
var canvas = document.getElementById("chart");
var ctx = canvas.getContext("2d");
var tip = document.getElementById("tip");
var fmtGp = function(n) { return n == null ? "—" : Number(n).toLocaleString() + " gp"; }
var fmtNum = function(n) { return n == null ? "—" : Number(n).toLocaleString(); }
var abbreviateNumber = function(num) {
  if (num >= 1e9) {
    return (num / 1e9).toFixed(1).replace(/\.0$/, '') + 'b';
  }
  if (num >= 1e6) {
    return (num / 1e6).toFixed(1).replace(/\.0$/, '') + 'm';
  }
  if (num >= 1e3) {
    return (num / 1e3).toFixed(1).replace(/\.0$/, '') + 'k';
  }
  return num.toLocaleString();
};
function jget(url) {
  return fetch(url, { cache: "default" }).then(function(r) {
    if (!r.ok) throw new Error(url + " HTTP " + r.status);
    return r.json();
  });
}
var loadMapping = function() { return jget(PRICES_API + "/mapping"); }
var loadLatest = function() { return jget(PRICES_API + "/latest"); }
var loadVolumes = function() { return jget(PRICES_API + "/volumes"); }
var loadTS = function(step, id) { return jget(PRICES_API + "/timeseries?timestep=" + step + "&id=" + id); }
var loadHistorical = function(id) { return jget(WEIRD_GLOOP_API + "/all?id=" + id); }
function bigIconUrl(name) {
  var fileName = name.replace(/ /g, '_');
  return "https://oldschool.runescape.wiki/images/" + encodeURIComponent(fileName) + ".png";
}
function suggestPrices(low, high) {
  if (low == null || high == null) return { buyMin: null, buyMax: null, sellMin: null, sellMax: null };
  var spread = high - low;
  var buyMargin = Math.max(1, Math.floor(spread * 0.1));
  var sellMargin = Math.max(1, Math.floor(spread * 0.1));
  if (high < 100) {
    buyMargin = 2;
    sellMargin = 4;
  } else if (high < 1000) {
    buyMargin = 5;
    sellMargin = 10;
  } else if (high < 10000) {
    buyMargin = 10;
    sellMargin = 20;
  } else {
    buyMargin = Math.floor(high * 0.005);
    sellMargin = Math.floor(high * 0.01);
  }
  var buyMin = Math.max(1, low - buyMargin);
  var buyMax = low;
  var sellMin = high;
  var sellMax = Math.max(1, high + sellMargin);
  var tax = 0.01;
  var minSell = Math.ceil(buyMax / (1 - tax)) + 1;
  sellMin = Math.max(sellMin, minSell);
  sellMax = Math.max(sellMax, minSell + Math.max(2, Math.floor(sellMargin / 2)));
  return { buyMin: buyMin, buyMax: buyMax, sellMin: sellMin, sellMax: sellMax };
}
function seriesFromTS(ts) {
  var src = ts ? ts.data : [];
  var rows = src.map(function(r) {
    return {
      t: Number(r.timestamp || r.ts || r.time),
      lo: r.avgLowPrice || r.low || null,
      hi: r.avgHighPrice || r.high || null,
      vol: (r.lowPriceVolume || 0) + (r.highPriceVolume || 0) || r.volume || null
    };
  }).filter(function(r) { return r.t && (r.lo != null || r.hi != null); }).sort(function(a, b) { return a.t - b.t; });
  return { labels: rows.map(function(r) { return r.t; }), low: rows.map(function(r) { return r.lo; }), high: rows.map(function(r) { return r.hi; }), vol: rows.map(function(r) { return r.vol || 0; }) };
}
function seriesFromHistorical(h) {
  var src = h ? h[String(selected.id)] : [];
  var rows = src.map(function(r) {
    return {
      t: Number(r.timestamp / 1000),
      lo: r.price,
      hi: r.price,
      vol: r.volume || 0
    };
  }).filter(function(r) { return r.t && r.lo != null; }).sort(function(a, b) { return a.t - b.t; });
  return { labels: rows.map(function(r) { return r.t; }), low: rows.map(function(r) { return r.lo; }), high: rows.map(function(r) { return r.hi; }), vol: rows.map(function(r) { return r.vol || 0; }) };
}
function getPeriod(view) {
  var periods = {
    "1d": 86400,
    "1w": 604800,
    "1m": 2592000,
    "6m": 15552000,
    "1y": 31536000,
    "all": Infinity
  };
  return periods[view] || Infinity;
}
function filterSeries(series, view) {
  if (view === "all") return series;
  var period = getPeriod(view);
  var minT = Math.max.apply(null, series.labels) - period;
  var startIdx = series.labels.findIndex(function(t) { return t >= minT; });
  return {
    labels: series.labels.slice(startIdx),
    low: series.low.slice(startIdx),
    high: series.high.slice(startIdx),
    vol: series.vol.slice(startIdx)
  };
}
function ypx(v, vmin, vmax, y0, h) {
  if (vmin === vmax) return y0 + h / 2;
  var p = (v - vmin) / (vmax - vmin);
  return y0 + (1 - p) * h;
}
function linearRegression(x, y) {
  var n = x.length;
  var sumX = x.reduce(function(a, b) { return a + b; }, 0);
  var sumY = y.reduce(function(a, b) { return a + b; }, 0);
  var sumXY = x.reduce(function(sum, xi, i) { return sum + xi * y[i]; }, 0);
  var sumX2 = x.reduce(function(sum, xi) { return sum + xi * xi; }, 0);
  var meanX = sumX / n;
  var meanY = sumY / n;
  var slope = (sumXY - n * meanX * meanY) / (sumX2 - n * meanX * meanX);
  var intercept = meanY - slope * meanX;
  return { slope: slope, intercept: intercept };
}
function calculateIchimoku(series) {
  var mid = series.labels.map(function(_, i) { return (series.low[i] + series.high[i]) / 2; });
  var getHigh = function(arr, start, end) { return Math.max.apply(null, arr.slice(Math.max(0, start), end)); };
  var getLow = function(arr, start, end) { return Math.min.apply(null, arr.slice(Math.max(0, start), end)); };
  var tenkan = Array(mid.length).fill(null);
  var kijun = Array(mid.length).fill(null);
  var senkouA = Array(mid.length).fill(null);
  var senkouB = Array(mid.length).fill(null);
  var chikou = Array(26).fill(null).concat(mid.slice(0, mid.length - 26)); // shifted back
  var len = mid.length;
  for (var i = 8; i < len; i++) {
    tenkan[i] = (getHigh(mid, i - 8, i + 1) + getLow(mid, i - 8, i + 1)) / 2;
  }
  for (var i = 25; i < len; i++) {
    kijun[i] = (getHigh(mid, i - 25, i + 1) + getLow(mid, i - 25, i + 1)) / 2;
  }
  for (var i = 25; i < len; i++) {
    senkouA[i + 26] = (tenkan[i] + kijun[i]) / 2;
  }
  for (var i = 51; i < len; i++) {
    senkouB[i + 26] = (getHigh(mid, i - 51, i + 1) + getLow(mid, i - 51, i + 1)) / 2;
  }
  return { tenkan: tenkan, kijun: kijun, senkouA: senkouA, senkouB: senkouB, chikou: chikou };
}
function drawChart(series, context, can, z, off, mode) {
  context = context || ctx;
  can = can || canvas;
  z = z || zoom;
  off = off || offset;
  mode = mode || drawMode;
  var c = can;
  var W = c.width, H = c.height;
  var x0 = 70, y0 = 40, w = W - x0 - 30, h = H - y0 - 50;
  context.clearRect(0, 0, W, H);
  if (!series || !series.labels || !series.labels.length) { 
    context.fillStyle = "#fff"; 
    context.font = "bold 16px Segoe UI, Arial";
    context.fillText("No data available", W/2 - 80, H/2); 
    return; 
  }
  var n = series.labels.length;
  var win = Math.max(12, Math.floor(n / z));
  offset = Math.max(0, Math.min(n - win, off));
  var start = offset;
  var end = start + win;
  var L = series.labels.slice(start, end);
  var LO = series.low.slice(start, end);
  var HI = series.high.slice(start, end);
  var VO = series.vol.slice(start, end);
  var vals = LO.concat(HI).filter(function(v) { return v != null; });
  if (!vals.length) { 
    context.fillStyle = "#fff"; 
    context.font = "bold 16px Segoe UI, Arial";
    context.fillText("No price data", W/2 - 70, H/2); 
    return; 
  }
  var vmin = Math.min.apply(null, vals), vmax = Math.max.apply(null, vals);
  if (vmin === vmax) { vmin -= 1; vmax += 1; }
  context.strokeStyle = "#000"; context.globalAlpha = 0.5;
  context.beginPath(); context.moveTo(x0, y0); context.lineTo(x0, y0 + h); context.lineTo(x0 + w, y0 + h); context.stroke();
  context.globalAlpha = 1;
  context.fillStyle = "#fff"; context.font = "bold 16px Segoe UI, Arial";
  var lines = 5;
  for (var i = 0; i <= lines; i++) {
    var y = y0 + (h * i / lines);
    context.strokeStyle = "rgba(255,255,255,0.06)";
    context.beginPath(); context.moveTo(x0, y); context.lineTo(x0 + w, y); context.stroke();
  }
  var stepX = w / Math.max(1, (L.length - 1));
  function drawCandle(i, lo, hi) {
    if (lo == null || hi == null) return;
    var x = x0 + i * stepX;
    var yLo = ypx(lo, vmin, vmax, y0, h);
    var yHi = ypx(hi, vmin, vmax, y0, h);
    var mid = (lo + hi) / 2;
    var previousMid = i > 0 ? (LO[i-1] + HI[i-1]) / 2 : mid;
    var color = mid > previousMid ? getComputedStyle(document.documentElement).getPropertyValue('--high-color').trim() : getComputedStyle(document.documentElement).getPropertyValue('--low-color').trim();
    var bodyTop = Math.min(yLo, yHi);
    var bodyBottom = Math.max(yLo, yHi);
    var bodyHeight = bodyBottom - bodyTop;
    var bodyWidth = stepX * 0.8;
    context.fillStyle = color;
    context.fillRect(x - bodyWidth / 2, bodyTop, bodyWidth, bodyHeight);
    // Wick (thin line from lo to hi)
    context.strokeStyle = color;
    context.lineWidth = 2;
    context.beginPath();
    context.moveTo(x, yLo);
    context.lineTo(x, yHi);
    context.stroke();
  }
  function drawSeries(arr, color, mode) {
    context.strokeStyle = color;
    context.fillStyle = color;
    if (mode === "line") {
      context.beginPath();
      var started = false;
      for (var i = 0; i < arr.length; i++) {
        var v = arr[i]; if (v == null) { started = false; continue; }
        var x = x0 + i * stepX;
        var y = ypx(v, vmin, vmax, y0, h);
        if (!started) { context.moveTo(x, y); started = true; } else context.lineTo(x, y);
      }
      context.lineWidth = 3; context.stroke();
    } else if (mode === "dot") { // scatter
      for (var i = 0; i < arr.length; i++) {
        var v = arr[i]; if (v == null) continue;
        var x = x0 + i * stepX;
        var y = ypx(v, vmin, vmax, y0, h);
        context.beginPath(); context.arc(x, y, 4, 0, Math.PI * 2); context.fill();
      }
    }
  }
  var h_price = h * 0.8;
  var h_vol = h * 0.2;
  var y0_vol = y0 + h_price;
  for (var i = 0; i < LO.length; i++) {
    drawCandle(i, LO[i], HI[i]);
  }
  // Draw volume bars always at bottom
  var maxVol = Math.max.apply(null, VO) || 1; // avoid division by zero
  for (var i = 0; i < VO.length; i++) {
    var v = VO[i];
    if (v == null) continue;
    var x = x0 + i * stepX - stepX / 4;
    var width = stepX / 2;
    var height = (v / maxVol) * h_vol;
    var mid = (LO[i] + HI[i]) / 2;
    var previousMid = i > 0 ? (LO[i-1] + HI[i-1]) / 2 : mid;
    var color = mid > previousMid ? getComputedStyle(document.documentElement).getPropertyValue('--high-color').trim() : getComputedStyle(document.documentElement).getPropertyValue('--low-color').trim();
    context.fillStyle = color;
    context.fillRect(x, y0_vol + h_vol - height, width, height);
  }
  if (vpActive) {
    var mid = L.map(function(_, i) { return (LO[i] + HI[i]) / 2; }).filter(function(p) { return p != null; });
    if (mid.length === 0) return;
    var numBins = 50;
    var binSize = (vmax - vmin) / numBins;
    var bins = Array(numBins).fill(0);
    var maxBinIndex = 0;
    var maxBinVol = 0;
    for (var i = 0; i < mid.length; i++) {
      var p = mid[i];
      var binIndex = Math.min(numBins - 1, Math.floor((p - vmin) / binSize));
      bins[binIndex] += VO[i];
      if (bins[binIndex] > maxBinVol) {
        maxBinVol = bins[binIndex];
        maxBinIndex = binIndex;
      }
    }
    var maxBin = Math.max.apply(null, bins);
    for (var i = 0; i < numBins; i++) {
      var binVol = bins[i];
      if (binVol === 0) continue;
      var binCenter = vmin + (i + 0.5) * binSize;
      var y = ypx(binCenter, vmin, vmax, y0, h);
      var binH = (h / (vmax - vmin)) * binSize * 1.2; // slightly overlap for better look
      var binW = (binVol / maxBin) * 200;
      context.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
      context.fillRect(x0 + w + 10, y - binH / 2, binW, binH);
    }
    // Horizontal line for POC
    var pocPrice = vmin + (maxBinIndex + 0.5) * binSize;
    var pocY = ypx(pocPrice, vmin, vmax, y0, h);
    context.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
    context.lineWidth = 1;
    context.beginPath();
    context.moveTo(x0, pocY);
    context.lineTo(x0 + w, pocY);
    context.stroke();
  }
  if (ichiActive) {
    var ichi = calculateIchimoku({low: LO, high: HI, labels: L});
    // Draw cloud
    for (var i = 0; i < L.length; i++) {
      if (ichi.senkouA[i] == null || ichi.senkouB[i] == null) continue;
      var y1 = ypx(ichi.senkouA[i], vmin, vmax, y0, h);
      var y2 = ypx(ichi.senkouB[i], vmin, vmax, y0, h);
      var color = ichi.senkouA[i] > ichi.senkouB[i] ? 'rgba(144,238,144,0.2)' : 'rgba(255,182,193,0.2)';
      context.fillStyle = color;
      context.fillRect(x0 + i * stepX - stepX / 2, Math.min(y1, y2), stepX, Math.abs(y1 - y2));
    }
    drawSeries(ichi.tenkan, getComputedStyle(document.documentElement).getPropertyValue('--ichi-tenkan').trim(), "line");
    drawSeries(ichi.kijun, getComputedStyle(document.documentElement).getPropertyValue('--ichi-kijun').trim(), "line");
    drawSeries(ichi.chikou, getComputedStyle(document.documentElement).getPropertyValue('--ichi-chikou').trim(), "line");
    drawSeries(ichi.senkouA, getComputedStyle(document.documentElement).getPropertyValue('--ichi-senkou-a').trim(), "line");
    drawSeries(ichi.senkouB, getComputedStyle(document.documentElement).getPropertyValue('--ichi-senkou-b').trim(), "line");
  }
  function drawPrediction(arr, color) {
    var nonNull = arr.map(function(v, i) { return {v: v, i: i}; }).filter(function(obj) { return obj.v != null; });
    if (nonNull.length < 2) return;
    var xVals = nonNull.map(function(obj) { return obj.i; });
    var yVals = nonNull.map(function(obj) { return obj.v; });
    var slopeIntercept = linearRegression(xVals, yVals);
    var slope = slopeIntercept.slope;
    var intercept = slopeIntercept.intercept;
    context.save();
    context.setLineDash([6, 6]);
    context.strokeStyle = color;
    context.beginPath();
    var startX = x0;
    var startY = ypx(slope * 0 + intercept, vmin, vmax, y0, h);
    var endX = x0 + (arr.length - 1) * stepX + stepX * 0.2;
    var endY = ypx(slope * (arr.length - 1 + (arr.length * 0.2)) + intercept, vmin, vmax, y0, h);
    context.moveTo(startX, startY);
    context.lineTo(endX, endY);
    context.stroke();
    context.restore();
  }
  drawPrediction(LO, getComputedStyle(document.documentElement).getPropertyValue('--low-color').trim());
  drawPrediction(HI, getComputedStyle(document.documentElement).getPropertyValue('--high-color').trim());
  context.fillStyle = "#fff"; context.font = "bold 16px Segoe UI, Arial";
  for (var i = 0; i <= lines; i++) {
    var y = y0 + (h * i / lines);
    var v = Math.round(vmax - (vmax - vmin) * i / lines);
    context.fillText(abbreviateNumber(v), 6, y - 4);
  }
  context.fillStyle = "#fff"; context.font = "bold 14px Segoe UI, Arial";
  var numLabels = 6;
  var labelStep = Math.floor(L.length / (numLabels - 1)) || 1;
  for (var i = 0; i < L.length; i += labelStep) {
    var dateStr = new Date(L[i] * 1000).toLocaleDateString();
    var x = x0 + i * stepX;
    context.fillText(dateStr, x - 30, H - 10);
  }
  var isDragging = false;
  var startX = 0;
  c.onmousedown = function(ev) {
    isDragging = true;
    startX = ev.clientX;
  };
  c.onmouseup = function() { isDragging = false; };
  c.onmouseleave = function() { isDragging = false; tip.style.display = "none"; };
  c.onmousemove = function(ev) {
    var rect = c.getBoundingClientRect();
    var mx = ev.clientX - rect.left, my = ev.clientY - rect.top;
    if (isDragging) {
      var dx = ev.clientX - startX;
      startX = ev.clientX;
      var pointWidth = w / (end - start);
      offset -= dx / pointWidth;
      offset = Math.max(0, Math.min(n - win, offset));
      drawChart(series);
      return;
    }
    if (mx < x0 || mx > x0 + w || my < y0 || my > y0 + h) { tip.style.display = "none"; return; }
    var idx = Math.max(0, Math.min(L.length - 1, Math.round((mx - x0) / stepX)));
    var t = L[idx] * 1000;
    var lo = LO[idx], hi = HI[idx], vol = VO[idx] || 0;
    tip.style.display = "block";
    tip.style.left = (mx + 12) + "px";
    tip.style.top = (my - 10) + "px";
    tip.innerHTML = "<strong>" + new Date(t).toLocaleString() + "</strong><br/>Low: " + fmtGp(lo) + "<br/>High: " + fmtGp(hi) + "<br/>Vol: " + fmtNum(vol);
  };
  c.onwheel = function(ev) {
    ev.preventDefault();
    var delta = ev.deltaY < 0 ? 1.25 : 0.8;
    zoom *= delta;
    zoom = Math.max(1, Math.min(8, zoom));
    drawChart(series);
  };
}
function setItem(m) {
  selected = m;
  $("#query").value = m.name;
  document.title = m.name + " - Grant Exchange";
  $("#itemIcon").src = bigIconUrl(m.name);
  $("#status").textContent = "Loading latest…";
  return loadLatest().then(function(data) { latest = data; return loadVolumes(); }).then(function(data) { volumes = data; var node = latest.data[String(m.id)]; var lo = node ? node.low || node.avgLowPrice : null; var hi = node ? node.high || node.avgHighPrice : null; $("#buyPrice span").textContent = fmtGp(lo); $("#sellPrice span").textContent = fmtGp(hi); $("#status").textContent = "Loading chart…"; var step = (view === "1d" ? "1h" : view === "1w" ? "6h" : "24h"); var loadFn = view === "all" ? loadHistorical(m.id) : loadTS(step, m.id); return loadFn; }).then(function(ts) { currentSeries = view === "all" ? seriesFromHistorical(ts) : seriesFromTS(ts); currentSeries = filterSeries(currentSeries, view); offset = Math.max(0, (currentSeries.labels.length - Math.floor(currentSeries.labels.length / zoom))); drawChart(currentSeries); var vol = volumes.data[String(m.id)] || 0; var limit = selected.buy_limit || 0; var tax = hi ? Math.floor(hi * 0.01) : 0; var margin = hi && lo ? hi - lo - tax : 0; var roi = lo ? ((margin / lo) * 100).toFixed(2) + '%' : '0%'; var potProfit = margin * limit; $("#keyBuyPrice").textContent = fmtGp(lo); $("#keySellPrice").textContent = fmtGp(hi); $("#keyVolume").textContent = fmtNum(vol); $("#keyLimit").textContent = fmtNum(limit); $("#keyTax").textContent = fmtGp(tax); $("#keyMargin").textContent = (margin > 0 ? '+' : '') + fmtGp(margin); $("#keyROI").textContent = (margin > 0 ? '+' : '') + roi; $("#keyPotProfit").textContent = (margin > 0 ? '+' : '') + fmtGp(potProfit); $("#status").textContent = "Ready"; });
}
function boot() {
  loadMapping().then(function(data) { mapping = data; return loadLatest(); }).then(function(data) { latest = data; return loadVolumes(); }).then(function(data) { volumes = data; var sb = $("#suggestBox"); $("#query").addEventListener("input", function() { var q = $("#query").value.trim().toLowerCase(); if (!q) { sb.style.display = "none"; sb.innerHTML = ""; return; } var list = mapping.filter(function(x) { return x.name.toLowerCase().includes(q); }).slice(0, 20); sb.innerHTML = list.map(function(x) { return '<div data-id="' + x.id + '"><img src="' + bigIconUrl(x.name) + '">' + x.name + '</div>'; }).join(""); sb.style.display = list.length ? "block" : "none"; }); sb.addEventListener("click", function(e) { var id = e.target.closest('div') ? e.target.closest('div').dataset.id : null; if (!id) return; var m = mapping.find(function(x) { return String(x.id) === String(id); }); if (m) { sb.style.display = "none"; setItem(m); } }); document.querySelectorAll(".view-btn").forEach(function(b) { b.onclick = function() { document.querySelectorAll(".view-btn").forEach(function(x) { x.classList.remove("active"); }); b.classList.add("active"); view = b.dataset.view; if (selected) setItem(selected); } }); $("#zIn").onclick = function() { zoom = Math.min(8, zoom * 1.25); drawChart(currentSeries); }; $("#zOut").onclick = function() { zoom = Math.max(1, zoom / 1.25); drawChart(currentSeries); }; $("#lineMode").onclick = function() { if ($("#dotMode").classList.contains("active")) $("#dotMode").classList.remove("active"); $("#lineMode").classList.add("active"); drawMode = "line"; drawChart(currentSeries); }; $("#dotMode").onclick = function() { if ($("#lineMode").classList.contains("active")) $("#lineMode").classList.remove("active"); $("#dotMode").classList.add("active"); drawMode = "dot"; drawChart(currentSeries); }; $("#vpMode").onclick = function() { vpActive = !vpActive; if (vpActive) $("#vpMode").classList.add("active"); else $("#vpMode").classList.remove("active"); drawChart(currentSeries); }; $("#ichiMode").onclick = function() { ichiActive = !ichiActive; if (ichiActive) $("#ichiMode").classList.add("active"); else $("#ichiMode").classList.remove("active"); drawChart(currentSeries); }; $("#btnF2P").onclick = function() { membersOn = false; $("#btnF2P").classList.add("active"); $("#btnMembers").classList.remove("active"); if (selected) setItem(selected); }; $("#btnMembers").onclick = function() { membersOn = true; $("#btnMembers").classList.add("active"); $("#btnF2P").classList.remove("active"); if (selected) setItem(selected); }; $("#refreshBtn").onclick = function() { $("#status").textContent = "Refreshing…"; loadLatest().then(function(data) { latest = data; return loadVolumes(); }).then(function(data) { volumes = data; if (selected) setItem(selected); $("#status").textContent = "Ready"; }); }; var gildedScimitar = mapping.find(function(x) { return x.name.toLowerCase() === "gilded scimitar"; }); if (gildedScimitar) setItem(gildedScimitar); }).catch(function(e) { console.error('Boot error:', e); $("#status").textContent = "Error"; });
}
boot();
</script>
</body>
</html>