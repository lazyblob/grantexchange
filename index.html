<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Grant Exchange</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="https://oldschool.runescape.wiki/images/Gilded_scimitar.png">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0f0b08;color:#eee5cf;font-family:system-ui,sans-serif;height:100vh;display:flex;flex-direction:column}
.header{background:#1e1810;border-bottom:2px solid #6a4f2b;padding:14px 20px;display:flex;justify-content:space-between;align-items:center}
h1{font-size:28px;color:#f39c12;font-weight:900}
.version{background:#2b2110;padding:4px 10px;border-radius:20px;border:1px solid #6a4f2b;font-size:13px}
.mode button{background:#2b2110;border:1px solid #6a4f2b;color:#eee5cf;padding:8px 16px;border-radius:10px;font-weight:bold;cursor:pointer}
.mode button.active{background:#f39c12;color:#000}
.main{flex:1;background:#1e1810;margin:12px;border:1px solid #6a4f2b;border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
.top{padding:16px;display:grid;grid-template-columns:110px 1fr 340px;gap:16px;align-items:center}
.imgbox{width:110px;height:110px;background:#111;border:2px solid #6a4f2b;border-radius:14px;overflow:hidden;display:flex;align-items:center;justify-content:center}
.imgbox img{max-width:90%;max-height:90%;image-rendering:pixelated}
#query{width:100%;background:#2b2110;border:2px solid #6a4f2b;color:#eee5cf;padding:14px 18px;border-radius:12px;font-size:18px}
#query:focus{border-color:#f39c12;outline:none}
.prices{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.price{background:#2b2110;border:1px solid #6a4f2b;border-radius:12px;padding:12px;text-align:center}
.price div{font-size:13px;color:#cbbf99;text-transform:uppercase}
.price strong{font-size:24px;font-weight:900}
.price.buy strong{color:#2ecc71}
.price.sell strong{color:#e74c3c}
.controls{padding:0 16px 12px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.tabs button,.tool{background:#2b2110;border:1px solid #6a4f2b;color:#eee5cf;padding:8px 14px;border-radius:10px;font-weight:600;text-transform:uppercase;font-size:13px;cursor:pointer}
.tabs button.active,.tool.active{background:#f39c12;color:#000;box-shadow:0 0 12px rgba(243,156,18,.4)}
.chart{flex:1;background:#111;position:relative}
canvas{width:100%;height:100%}
#tip{position:absolute;background:rgba(0,0,0,0.9);color:#fff;padding:8px 12px;border-radius:8px;font-size:13px;pointer-events:none;display:none;z-index:100;border:1px solid #444}
.legend{padding:12px;display:flex;gap:20px;font-size:14px;justify-content:center}
.legend span{display:flex;align-items:center;gap:6px}
.legend span::before{content:"";width:16px;height:4px;border-radius:2px}
.legend .low::before{background:#e74c3c}
.legend .high::before{background:#2ecc71}
.suggest{position:absolute;top:100%;left:16px;right:16px;background:#2b2110;border:1px solid #6a4f2b;border-radius:12px;max-height:300px;overflow-y:auto;z-index:10;display:none}
.suggest div{padding:10px 14px;cursor:pointer;display:flex;align-items:center;gap:12px}
.suggest div:hover{background:#3a2f17}
.suggest img{width:32px;height:32px}
</style>
</head>
<body>

<div class="header">
  <div style="display:flex;align-items:center;gap:14px">
    <h1>Grant Exchange</h1>
    <div class="version">v4.0</div>
  </div>
  <div class="mode">
    <button id="f2p" class="active">F2P</button>
    <button id="members">Members</button>
  </div>
</div>

<div class="main">
  <div class="top">
    <div class="imgbox"><img id="img" src="" alt=""></div>
    <div style="position:relative">
      <input id="query" placeholder="Search any item...">
      <div id="suggest" class="suggest"></div>
    </div>
    <div class="prices">
      <div class="price buy"><div>BUY PRICE</div><strong id="buy">--</strong></div>
      <div class="price sell"><div>SELL PRICE</div><strong id="sell">--</strong></div>
    </div>
  </div>

  <div class="controls">
    <div class="tabs">
      <button data-t="day" class="active">1D</button>
      <button data-t="week">1W</button>
      <button data-t="month">1M</button>
      <button data-t="6month">6M</button>
      <button data-t="year">1Y</button>
      <button data-t="all">ALL</button>
    </div>
    <div style="display:flex;gap:8px">
      <button class="tool" id="zin">Zoom +</button>
      <button class="tool" id="zout">Zoom -</button>
      <button class="tool active" id="line">Line</button>
      <button class="tool" id="dots">Dots</button>
      <button class="tool" id="vp">VP</button>
      <button class="tool" id="ichi">Ichimoku</button>
      <button class="tool" id="refresh">Refresh</button>
    </div>
  </div>

  <div class="chart">
    <canvas id="c"></canvas>
    <div id="tip"></div>
  </div>

  <div class="legend">
    <span class="low">Low Price</span>
    <span class="high">High Price</span>
  </div>
</div>

<script>
const API = "https://prices.runescape.wiki/api/v1/osrs";
let map = [], latest = null, item = null;
let data = [], timeframe = "day", zoom = 1.8, mode = "line", showVP = false, showIchi = false;
let members = false;

const c = document.getElementById("c"), ctx = c.getContext("2d");
const tip = document.getElementById("tip");

async function get(u){try{const r=await fetch(u,{cache:"force-cache"});return r.ok?await r.json():null}catch(e){return null}}

const loadMap = ()=>get(API+"/mapping");
const loadLatest = ()=>get(API+"/latest");
const loadTS = (step,id)=>get(API+`/timeseries?timestep=${step}&id=${id}`);

function img(id){
  const i = map.find(x=>x.id==id);
  return i?`https://oldschool.runescape.wiki/images/${i.name.replace(/ /g,"_")}.png`:"https://oldschool.runescape.wiki/images/Question_mark.png";
}

function series(ts){
  if(!ts?.data) return [];
  return ts.data.map(d=>({
    t:+d.timestamp*1000,
    l:d.avgLowPrice??d.low??null,
    h:d.avgHighPrice??d.high??null,
    v:d.lowPriceVolume??d.highPriceVolume??d.volume??0
  })).filter(d=>d.l!==null||d.h!==null);
}

function draw(){
  if(!data.length) return;
  const W=c.width,H=c.height;
  const L=70,R=110,T=30,B=60;
  const w=W-L-R,h=H-T-B;
  const vH=h*0.22,pH=h-vH;

  const n=data.length;
  const win=Math.max(10,Math.floor(n/zoom));
  const s=Math.max(0,Math.min(n-win,Math.floor(offset)));
  const e=s+win;

  const slice=a=>a.slice(s,e);
  const t=slice(data.map(d=>d.t));
  const l=slice(data.map(d=>d.l));
  const h=slice(data.map(d=>d.h));
  const v=slice(data.map(d=>d.v));

  const prices=[...l,...h].filter(x=>x!==null);
  const min=Math.min(...prices),max=Math.max(...prices);
  const vMax=Math.max(...v,1);

  ctx.clearRect(0,0,W,H);

  // Grid
  ctx.strokeStyle="#ffffff0a";
  for(let i=0;i<=6;i++){
    const y=T+pH*i/6;
    ctx.beginPath();ctx.moveTo(L,y);ctx.lineTo(W-R,y);ctx.stroke();
  }

  const step=w/Math.max(1,t.length-1);

  // Price lines
  line(l,"#e74c3c",mode==="line"?3:0);
  line(h,"#2ecc71",mode==="line"?3:0);
  if(mode==="dot"){dots(l,"#e74c3c");dots(h,"#2ecc71");}

  // Volume
  v.forEach((vv,i)=>{
    const x=L+i*step;
    const bh=(vv/vMax)*vH;
    ctx.fillStyle=vv>(v[i-1]||0)?"#2ecc71":"#e74c3c";
    ctx.globalAlpha=0.6;
    ctx.fillRect(x-step*0.4,H-B,step*0.8,-bh);
    ctx.globalAlpha=1;
  });

  // Y labels
  ctx.fillStyle="#fff";ctx.font="bold 14px Arial";
  for(let i=0;i<=6;i++){
    const y=T+pH*i/6;
    const val=Math.round(max-(max-min)*i/6);
    ctx.fillText(val.toLocaleString(),10,y+5);
  }
}

function line(arr,col,w=2){
  ctx.strokeStyle=col;ctx.lineWidth=w;ctx.beginPath();
  let s=false;
  arr.forEach((v,i)=>{
    if(v===null){s=false;return}
    const x=70+i*step;
    const y=30+pH-(v-min)/(max-min)*pH;
    s?ctx.lineTo(x,y):ctx.moveTo(x,y);s=true;
  });
  ctx.stroke();
}
function dots(arr,col){
  ctx.fillStyle=col;
  arr.forEach((v,i)=>{
    if(v===null)return;
    const x=70+i*step;
    const y=30+pH-(v-min)/(max-min)*pH;
    ctx.beginPath();ctx.arc(x,y,3.5,0,Math.PI*2);ctx.fill();
  });
}

async function load(id){
  const i = map.find(x=>x.id==id);
  if(!i) return;
  document.getElementById("query").value = i.name;
  document.getElementById("img").src = img(id);

  latest = await loadLatest();
  const d = latest?.data?.[id];
  document.getElementById("buy").textContent = d?(d.low??d.avgLowPrice).toLocaleString()+" gp":"--";
  document.getElementById("sell").textContent = d?(d.high??d.avgHighPrice).toLocaleString()+" gp":"--";

  const step = timeframe==="day"?"1h":timeframe==="week"?"6h":"24h";
  const ts = await loadTS(step,id);
  data = series(ts)||[];
  draw();
}

// Search
document.getElementById("query").oninput = async e=>{
  const q=e.target.value.toLowerCase().trim();
  const s=document.getElementById("suggest");
  s.innerHTML="";
  if(q.length<2){s.style.display="none";return}
  const matches = map.filter(i=>(members||!i.members)&&i.name.toLowerCase().includes(q)).slice(0,12);
  s.innerHTML = matches.map(i=>`<div data-id="${i.id}"><img src="${img(i.id)}" onerror="this.src='https://oldschool.runescape.wiki/images/Question_mark.png'"><span>${i.name}</span></div>`).join("");
  s.style.display="block";
};
document.getElementById("suggest").onclick=e=>{
  const id=e.target.closest("[data-id]")?.dataset.id;
  if(id) load(id);
};

// Controls
document.querySelectorAll(".tabs button").forEach(b=>b.onclick=()=>{document.querySelector(".tabs .active")?.classList.remove("active");b.classList.add("active");timeframe=b.dataset.t;if(item)load(item.id)});
document.getElementById("zin").onclick=()=>{zoom=Math.min(10,zoom*1.3);draw();}
document.getElementById("zout").onclick=()=>{zoom=Math.max(1,zoom/1.3);draw();}
document.getElementById("line").onclick=()=>{mode="line";document.getElementById("line").classList.add("active");document.getElementById("dots").classList.remove("active");draw();}
document.getElementById("dots").onclick=()=>{mode="dot";document.getElementById("dots").classList.add("active");document.getElementById("line").classList.remove("active");draw();}
document.getElementById("f2p").onclick=()=>{members=false;document.getElementById("f2p").classList.add("active");document.getElementById("members").classList.remove("active");if(item)load(item.id);}
document.getElementById("members").onclick=()=>{members=true;document.getElementById("members").classList.add("active");document.getElementById("f2p").classList.remove("active");if(item)load(item.id);}

// Init
(async()=>{
  map = await loadMap();
  const g = map.find(x=>x.name.toLowerCase().includes("gilded scimitar"));
  if(g) load(g.id);

  function r(){
    c.width = c.offsetWidth * devicePixelRatio;
    c.height = c.offsetHeight * devicePixelRatio;
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    if(data.length) draw();
  }
  r();
  window.onresize=r;
})();
</script>
</body>
</html>