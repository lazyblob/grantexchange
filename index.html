<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=5.0, user-scalable=yes"/>
<title>Grant Exchange - OSRS Charting Tool</title>
<meta name="description" content="Advanced charting tool for OSRS Grand Exchange items with indicators like Ichimoku Cloud, Volume Profile, and Volume. Analyze trends from 1 day to 5 years.">
<meta name="keywords" content="OSRS Grand Exchange, OSRS GE, RuneScape Grand Exchange, OSRS charting, OSRS price charts, OSRS indicators, Ichimoku Cloud OSRS, Volume Profile OSRS">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://grantexchange.net/">
<!-- Open Graph -->
<meta property="og:title" content="Grant Exchange - OSRS Charting Tool">
<meta property="og:description" content="Advanced charting tool for OSRS Grand Exchange items with indicators like Ichimoku Cloud, Volume Profile, and Volume. Analyze trends from 1 day to 5 years.">
<meta property="og:image" content="https://oldschool.runescape.wiki/images/Gilded_scimitar.png">
<meta property="og:url" content="https://grantexchange.net/">
<meta property="og:type" content="website">
<!-- Favicon -->
<link rel="icon" type="image/png" sizes="48x48" href="https://oldschool.runescape.wiki/images/Gilded_scimitar.png">
<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Grant Exchange - OSRS Charting Tool">
<meta name="twitter:description" content="Advanced charting tool for OSRS Grand Exchange items with indicators like Ichimoku Cloud, Volume Profile, and Volume. Analyze trends from 1 day to 5 years.">
<meta name="twitter:image" content="https://oldschool.runescape.wiki/images/Gilded_scimitar.png">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Grant Exchange - OSRS Charting Tool",
  "url": "https://grantexchange.net/",
  "description": "Advanced charting tool for OSRS Grand Exchange items with indicators like Ichimoku Cloud, Volume Profile, and Volume. Analyze trends from 1 day to 5 years.",
  "applicationCategory": "Game",
  "operatingSystem": "Web",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  }
}
</script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-43YM2RCX1R"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-43YM2RCX1R');
</script>
<!-- CSS -->
<style>
:root{
  --bg:#1b140a; --panel:#2b2110; --edge:#6a4f2b;
  --gold:#cfb36a; --orange:#f0a020; --ink:#eee5cf; --muted:#cbbf99;
  --low-color:#fb6a6a; --high-color:#5cc76a; --grid:#3b2f19; --accent:#ffce4f; --shadow:#0b0703;
  --teal: #00ffff;
  --ichi-tenkan: #069af3; --ichi-kijun: #ec2b88; --ichi-chikou: #22b14c;
  --ichi-senkou-a: #a1d8a0; --ichi-senkou-b: #d8a0a6;
  --cloud-green: rgba(161,216,160,0.2); --cloud-red: rgba(216,160,166,0.2);
}
* {box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:radial-gradient(1200px 600px at 20% -10%,#2b2210 0%,#1b140a 60%),#1b140a;
  color:var(--ink);
  font-family:Segoe UI,Inter,system-ui,Arial;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
/* Layout */
.wrap{max-width:1280px;margin:18px auto;padding:0 7px; min-height: calc(100vh - 36px);
  display:grid;grid-template-columns:1fr;gap:16px;align-items:start}
.header{grid-column:1 / -1;display:grid;
  grid-template-columns:1fr auto auto;gap:12px;align-items:center}
/* Branding */
h1{margin:0;font-size:26px;font-weight:900;color:var(--orange);text-shadow:0 1px 0 #000;cursor:pointer}
.badge{font-size:12px;border:1px solid var(--edge);border-radius:999px;
  padding:2px 8px;color:var(--muted);background:#20190e}
.small{font-size:12px;color:var(--muted)}
.status-error{color:#ffb4b4}
/* Cards */
.card{background:linear-gradient(180deg,#2d220f 0%, #241b0c 100%);
  border:1px solid var(--edge);border-radius:16px;padding:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.28)}
.left{display:flex;flex-direction:column}
.hr{border:none;border-top:1px solid var(--edge);margin:10px 0}
/* Main grid: image / search / stats */
.grid{display:grid;grid-template-columns:240px 1fr 260px;
  gap:14px;align-items:center}
.imgbox{
  width:240px;height:240px;border:1px solid var(--edge);
  border-radius:14px;background:#22180b;
  display:flex;align-items:center;justify-content:center;
  box-shadow:inset 0 0 0 1px #151008,0 8px 18px rgba(0,0,0,.25) }
.imgbox img{width:100%;height:100%;object-fit:contain;image-rendering:pixelated}
/* Search */
.label{font-size:26px;color:var(--orange);font-weight:900;margin-bottom:0}
.sbar{display:flex;gap:10px;margin-top:2px;position:relative}
.sbar input{
  flex:1;background:#1e170c;border:3px solid var(--edge);color:var(--ink);
  border-radius:14px;padding:16px;font-size:20px;outline:none;
  box-shadow:0 0 0 0 rgba(240,160,32,0);transition:box-shadow .18s,border-color .18s }
.sbar input:focus{border-color:var(--orange);
  box-shadow:0 0 0 4px rgba(240,160,32,0.25)}
.sbar button{
  background:#2b2212;border:1px solid var(--edge);color:var(--gold);
  border-radius:12px;padding:12px 16px;cursor:pointer;font-size:15px;
  text-transform:uppercase;letter-spacing:.5px;transition:box-shadow .18s,border-color .18s }
.sbar button:focus{border-color:var(--orange);
  box-shadow:0 0 0 4px rgba(240,160,32,0.25)}
.suggest{margin-top:6px;border:1px solid var(--edge);border-radius:10px;
  max-height:360px;overflow:auto;background:#231b0d;position:absolute;z-index:10;width: calc(100% - 90px); left:0;}
.suggest::-webkit-scrollbar {width:8px; background:var(--panel);}
.suggest::-webkit-scrollbar-thumb {background:var(--edge); border-radius:4px;}
.suggest div{display:flex;align-items:center;gap:6px;
  padding:8px 10px;border-bottom:1px solid #3e3119;cursor:pointer; word-break: break-word; white-space: normal; word-wrap: break-word;}
.suggest div:hover{background:#2d220f}
.suggest img{width:20px;height:20px;image-rendering:pixelated}
/* Stats */
.title{font-size:15px;letter-spacing:.3px;
  text-transform:uppercase;margin-bottom:4px}
.title.low{color:var(--low-color)}
.title.high{color:var(--high-color)}
.big-buy{font-size:36px;font-weight:900;color:var(--low-color)}
.big-sell{font-size:36px;font-weight:900;color:var(--high-color)}
.kv{display:flex;justify-content:space-between;margin:5px 0}
.kv strong.spread{font-size:24px;animation: rainbow 5s linear infinite;}
.kv .price-adjust{display:flex;align-items:center;gap:5px;border:1px solid var(--edge);padding:8px;border-radius:8px;background:#2b2212}
.kv .price-adjust button{padding:0 5px;font-size:24px;font-weight:bold;color:var(--gold);background:transparent;border:none;cursor:pointer;}
.kv .price-adjust.low button{color:var(--low-color)}
.kv .price-adjust.high button{color:var(--high-color)}
.kv .price-adjust span{font-size:24px;font-weight:bold}
.kv .price-adjust.low span{color:var(--low-color)}
.kv .price-adjust.high span{color:var(--high-color)}
.kv .price-input{width:140px; text-align:center; font-size:24px; background:transparent; border:none; color:var(--gold)}
.kv .buy-limit-input{width:140px; text-align:center; font-size:24px; background:transparent; border:none; color:var(--gold)}
/* Tabs + Tools */
.viewtabs, .mode-pill {display:flex;gap:6px;}
.viewtabs button, .mode-pill button{background:#2b2212;border:1px solid var(--edge);
  color:var(--ink);border-radius:10px;padding:6px 10px;
  cursor:pointer;text-transform:uppercase;font-weight: bold; font-size: 14px;transition:box-shadow .18s,border-color .18s}
.viewtabs button.active, .mode-pill button.active{background:#3a2f17; box-shadow: 0 0 10px rgba(240,160,32,0.8);border-color:var(--orange)}
.viewtabs button:focus, .mode-pill button:focus{border-color:var(--orange);
  box-shadow:0 0 0 4px rgba(240,160,32,0.25)}
.tools{display:flex;gap:6px;align-items:center;margin-top:6px}
.tools button{background:#2b2212;border:1px solid var(--edge);
  color:var(--ink);border-radius:10px;padding:5px 9px;cursor:pointer;
  text-transform:uppercase;font-weight: bold; font-size: 14px;transition:box-shadow .18s,border-color .18s}
.tools button.active{background:#3a2f17; box-shadow: 0 0 10px rgba(240,160,32,0.8);border-color:var(--orange)}
.tools button:focus{border-color:var(--orange);
  box-shadow:0 0 0 4px rgba(240,160,32,0.25)}
/* Chart */
.chartWrap{position:relative}
.chart{
  width:100%;height:500px;
  background:repeating-linear-gradient(to bottom,
    rgba(255,255,255,0.03),rgba(255,255,255,0.03) 1px,
    transparent 1px,transparent 24px),#181208;
  border:1px solid var(--edge);border-radius:12px }
.chart-tip{
  position:absolute;display:none;background:rgba(0,0,0,.85);
  color:#fff;padding:6px 8px;border-radius:6px;font-size:12px;
  pointer-events:none;white-space:nowrap;border:1px solid #000 }
.legend{display:flex;gap:12px;font-size:12px;margin-top:6px;color:var(--muted)}
.legend .sell::before{content:"";display:inline-block;width:14px;height:3px;
  background:var(--low-color);margin-right:6px;border-radius:2px}
.legend .buy::before{content:"";display:inline-block;width:14px;height:3px;
  background:var(--high-color);margin-right:6px;border-radius:2px}
/* Refresh button glow */
.refreshRow{display:flex;align-items:center;gap:12px;margin:6px 0}
.btn-refresh{
  padding:12px 20px;border-radius:18px;border:2px solid var(--edge);
  background:linear-gradient(180deg,#3a2f17 0%,#2b2212 100%);
  color:var(--gold);font-weight:900;cursor:pointer;font-size:16px;
  text-transform:uppercase;letter-spacing:.5px;
  box-shadow:0 4px 12px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.5);
  transition:transform .08s ease,filter .12s ease,box-shadow .12s ease }
.btn-refresh:hover{filter:brightness(1.05);
  transform:translateY(-1px);
  box-shadow:0 6px 16px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.5)}
.btn-refresh:active{transform:translateY(0);
  box-shadow:0 2px 8px rgba(0,0,0,.2), inset 0 1px 0 rgba(255,255,255,.5)}
.btn-refresh.loading {
  animation: pulse-rs 1.5s infinite;
}
@keyframes pulse-rs {
  0% { box-shadow: 0 0 0 0 rgba(240,160,32,0.7); }
  70% { box-shadow: 0 0 0 10px rgba(240,160,32,0); }
  100% { box-shadow: 0 0 0 0 rgba(240,160,32,0); }
}
/* Loader overlay */
#loader-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  flex-direction: column;
  color: var(--ink);
  font-size: 18px;
}
.loader-wheel {
  border: 8px solid var(--edge);
  border-top: 8px solid var(--orange);
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 2s linear infinite;
  margin-bottom: 20px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
/* Mobile Responsiveness */
@media (max-width: 768px) {
  .wrap {grid-template-columns: 1fr; padding: 0 8px; gap: 10px;}
  .grid {grid-template-columns: 1fr;}
  .imgbox {width: 80px; height: 80px; margin: 0;}
  .label {font-size: 16px; margin: 0;}
  .sbar input {font-size: 14px; padding: 8px;}
  .kv {margin: 2px 0; font-size: 12px;}
  .kv strong {font-size: 14px;}
  .chart {height: 280px;}
  .key-info {grid-template-columns: repeat(2, 1fr); gap: 8px;}
  .key-value {font-size: 18px;}
  .key-label {font-size: 12px;}
  .sbar {gap: 5px;}
  .sbar input {padding: 12px; font-size: 16px;}
  .viewtabs, .mode-pill {gap: 3px;}
  .viewtabs button, .mode-pill button {padding: 4px 8px; font-size: 12px;}
  .tools {gap: 3px;}
  .tools button {padding: 3px 6px; font-size: 12px;}
  .refreshRow {gap: 5px;}
  .btn-refresh {padding: 8px 12px; font-size: 14px;}
  #chart, #historicalChart {width: 100% !important;}
  .chartWrap {overflow-x: hidden;}
}
</style>
</head>
<body>
<div id="loader-overlay" style="display:none;">
  <div class="loader-wheel"></div>
  Fetching the most recent market data please wait..
</div>
<div class="wrap">
  <div class="header">
    <div><h1 onclick="location.reload();">Grant Exchange</h1><span class="badge">v3.3</span> <span class="badge">OSRS Charts</span></div>
    <div id="status" class="small">Ready</div>
    <div style="display:flex;gap:10px;align-items:center">
      <div class="mode-pill" id="modePill">
        <button data-mode="f2p" id="btnF2P" class="active">F2P</button>
        <button data-mode="members" id="btnMembers">Members</button>
      </div>
    </div>
  </div>
  <!-- Main panel -->
  <div class="card left">
    <div class="grid">
      <!-- Large item image -->
      <div class="imgbox"><img id="itemImg" alt="Item"/></div>
      <!-- Search column -->
      <div>
        <div class="label">What item?</div>
        <div class="sbar">
          <input id="query" placeholder="Type here… e.g., Uncut diamond" autocomplete="off"/>
          <div id="suggestBox" class="suggest" style="display:none"></div>
        </div>
        <div class="kv" style="margin-top:4px"><span id="flipProfitLabel">Expected Flip Profit</span><strong id="flipProfit" style="color:var(--gold);font-size:20px">—</strong></div>
        <div class="kv" style="margin-top:12px"><span>Capital Required</span><strong id="capitalRequired" style="color:var(--gold);font-size:20px">—</strong></div>
        <div class="small" id="buyLimitInfo"></div>
        <div id="spreadMargin" class="spread-margin">1h Spread: —</div>
      </div>
      <!-- Smart prices -->
      <div>
        <div class="title low">Smart Low Buy (Offer)</div>
        <div class="kv price-adjust low"><button onclick="adjustPrice('buy', -1)">↓</button><input id="smartBuyInput" class="price-input" type="text" value="—" onchange="updateSmartBuyFromInput()" /><button onclick="adjustPrice('buy', 1)">↑</button></div>
        <div class="title high" style="margin-top:10px">Smart High Sell (List)</div>
        <div class="kv price-adjust high"><button onclick="adjustPrice('sell', -1)">↓</button><input id="smartSellInput" class="price-input" type="text" value="—" onchange="updateSmartSellFromInput()" /><button onclick="adjustPrice('sell', 1)">↑</button></div>
        <div class="title" style="margin-top:10px">Buy Limit</div>
        <div class="kv price-adjust"><button onclick="adjustBuyLimit(-1)">↓</button><input id="buyLimitDisplay" class="buy-limit-input" type="text" value="—" onchange="updateBuyLimitFromInput()" /><button onclick="adjustBuyLimit(1)">↑</button></div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="refreshRow">
      <div class="viewtabs">
        <button data-view="1d" class="active">1D</button>
        <button data-view="1w">1W</button>
        <button data-view="1m">1M</button>
        <button data-view="6m">6M</button>
        <button data-view="1y">1Y</button>
        <button data-view="5y">5Y</button>
        <button data-view="all">All</button>
      </div>
      <div class="tools">
        <span class="small">Zoom:</span><button id="zIn">+</button><button id="zOut">−</button>
        <span class="small" style="margin-left:10px">Mode:</span>
        <button id="lineMode" class="active">Line</button>
        <button id="dotMode">Scatter</button>
        <span class="small" style="margin-left:10px">View:</span>
        <button id="popoutBtn">Popout</button>
      </div>
    </div>
    <div class="chartWrap">
      <canvas id="chart" class="chart" width="980" height="500"></canvas>
      <div id="tip" class="chart-tip"></div>
    </div>
    <div class="legend"><span class="sell">Low (Buy)</span><span class="buy">High (Sell)</span></div>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; gap:10px;">
      <div style="display:flex; gap:10px; align-items:center;">
        <label class="color-picker">Low: <input type="color" id="lowColorPicker" value="#fb6a6a"></label>
        <label class="color-picker">High: <input type="color" id="highColorPicker" value="#5cc76a"></label>
      </div>
      <div style="display:flex; gap:10px;">
        <button id="refreshBtn" class="btn-refresh">Refresh All Data</button>
      </div>
    </div>
    <div id="itemDesc" class="help" style="margin-top:20px"></div>
  </div>
</div>
<!-- SCRIPT -->
<script>
/* ========== Constants & API ========== */
const $ = s => document.querySelector(s);
const API = "https://prices.runescape.wiki/api/v1/osrs";
let mapping=[], latest=null, volumes=null, selected=null;
let currentSeries=null, view="1d", zoom=1.5, offset=0, drawMode="line";
let membersOn=false; // F2P by default (false)
let enabledIndicators = [];
let adjustedBuy = null;
let adjustedSell = null;
let buyLimit = 0;
const buyLimits = {}; // Cached buy limits (lazy-loaded from items-json/${id}.json)
const canvas = document.getElementById("chart");
const ctx = canvas.getContext("2d");
const tip = document.getElementById("tip");
/* ---------- Utilities ---------- */
const fmtGp = n => n==null ? "—" : Number(n).toLocaleString() + " gp";
const fmtNum = n => n==null ? "—" : Number(n).toLocaleString();
const abbreviateNumber = (num) => {
  if (num >= 1e9) {
    return (num / 1e9).toFixed(1).replace(/\.0$/, '') + 'b';
  }
  if (num >= 1e6) {
    return (num / 1e6).toFixed(1).replace(/\.0$/, '') + 'm';
  }
  if (num >= 1e3) {
    return (num / 1e3).toFixed(1).replace(/\.0$/, '') + 'k';
  }
  return num.toLocaleString();
};
async function jget(url){
  const r=await fetch(url, {cache: "default"});
  if(!r.ok) throw new Error(url+" HTTP "+r.status);
  return await r.json();
}
const loadMapping=()=>jget(API+"/mapping");
const loadLatest =()=>jget(API+"/latest");
const loadVolumes=()=>jget(API+"/volumes");
const loadTS =(step,id)=> jget(API+`/timeseries?timestep=${step}&id=${id}`);
function bigIconUrl(id){ 
  return `./images/${id}.png`; // Relative path; works locally and on GitHub Pages 
}
function suggestPrices(low, high) {
  if (low == null || high == null) return { buyMin: null, buyMax: null, sellMin: null, sellMax: null };
  const spread = high - low;
  let buyMargin = Math.max(1, Math.floor(spread * 0.1)); // Increased to 10% for lower buy prices
  let sellMargin = Math.max(1, Math.floor(spread * 0.1)); // Increased to 10% for higher sell prices
  if (high < 100) {
    buyMargin = 2;
    sellMargin = 4;
  } else if (high < 1000) {
    buyMargin = 5;
    sellMargin = 10;
  } else if (high < 10000) {
    buyMargin = 10;
    sellMargin = 20;
  } else {
    buyMargin = Math.floor(high * 0.005); // Increased to 0.5%
    sellMargin = Math.floor(high * 0.01); // Increased to 1%
  }
  const buyMin = Math.max(1, low - buyMargin);
  const buyMax = low;
  let sellMin = high;
  let sellMax = Math.max(1, high + sellMargin);
  const tax = 0.01;
  const minSell = Math.ceil(buyMax / (1 - tax)) + 1;
  sellMin = Math.max(sellMin, minSell);
  sellMax = Math.max(sellMax, minSell + Math.max(2, Math.floor(sellMargin / 2)));
  return { buyMin, buyMax, sellMin, sellMax };
}
/* Map backend timeseries to arrays */
function seriesFromTS(ts){
  const src = ts?.data || [];
  const rows = src.map(r=>({
    t: Number(r.timestamp ?? r.ts ?? r.time),
    lo: r.avgLowPrice ?? r.low ?? null,
    hi: r.avgHighPrice ?? r.high ?? null,
    vol: r.lowPriceVolume ?? r.highPriceVolume ?? r.volume ?? null
  })).filter(r=>r.t && (r.lo!=null || r.hi!=null)).sort((a,b)=>a.t-b.t);
  return { labels: rows.map(r=>r.t), low: rows.map(r=>r.lo), high: rows.map(r=>r.hi), vol: rows.map(r=>r.vol ?? 0) };
}
/* ========== Chart (line + scatter + hold line) ========== */
const ypx = (v, vmin, vmax, y0, h) => {
  if(vmin===vmax) return y0+h/2;
  const p=(v-vmin)/(vmax-vmin);
  return y0 + (1-p)*h;
};
function linearRegression(x, y) {
  const n = x.length;
  const sumX = x.reduce((a, b) => a + b, 0);
  const sumY = y.reduce((a, b) => a + b, 0);
  const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
  const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
  const meanX = sumX / n;
  const meanY = sumY / n;
  const slope = (sumXY - n * meanX * meanY) / (sumX2 - n * meanX * meanX);
  const intercept = meanY - slope * meanX;
  return { slope, intercept };
}
function drawChart(series, context = ctx, can = canvas, z = zoom, off = offset, mode = drawMode){
  const c = can;
  const W=c.width, H=c.height;
  const x0=60, y0=30, w=W-x0-14, h=H-y0-42;
  context.clearRect(0,0,W,H);
  if(!series || !series.labels?.length){ return; }
  // windowing (zoom + pan)
  const n = series.labels.length;
  const win = Math.max(12, Math.floor(n/z));
  const start = Math.max(0,Math.min(n-win, Math.floor(off)));
  const end = start + win;
  const L = series.labels.slice(start,end);
  const LO = series.low.slice(start,end);
  const HI = series.high.slice(start,end);
  const VO = (series.vol||[]).slice(start,end);
  // value domain from price series
  const vals = [...LO, ...HI].filter(v=>v!=null);
  if(!vals.length) return;
  let vmin = Math.min(...vals), vmax = Math.max(...vals);
  if(vmin===vmax){ vmin-=1; vmax+=1; }
  // axes
  context.strokeStyle="#000"; context.globalAlpha=0.5;
  context.beginPath(); context.moveTo(x0,y0); context.lineTo(x0,y0+h); context.lineTo(x0+w,y0+h); context.stroke();
  context.globalAlpha=1;
  // background grid
  context.fillStyle="#fff"; context.font="bold 14px Segoe UI, Arial";
  const lines=5;
  for(let i=0;i<=lines;i++){
    const y=y0 + (h*i/lines);
    context.strokeStyle="rgba(255,255,255,0.06)";
    context.beginPath(); context.moveTo(x0,y); context.lineTo(x0+w,y); context.stroke();
  }
  const stepX = w / Math.max(1,(L.length-1));
  // draw low (offer) red and high (list) green
  function drawSeries(arr, color, mode){
    context.strokeStyle=color;
    context.fillStyle=color;
    if(mode==="line"){
      context.beginPath();
      for(let i=0;i<arr.length;i++){
        const v=arr[i]; if(v==null) continue;
        const x=x0 + i*stepX;
        const y=ypx(v, vmin, vmax, y0, h);
        if(i===0) context.moveTo(x,y); else context.lineTo(x,y);
      }
      context.lineWidth=2; context.stroke();
    }else{ // scatter
      for(let i=0;i<arr.length;i++){
        const v=arr[i]; if(v==null) continue;
        const x=x0 + i*stepX;
        const y=ypx(v, vmin, vmax, y0, h);
        context.beginPath(); context.arc(x,y,3,0,Math.PI*2); context.fill();
      }
    }
  }
  // draw low (offer) red and high (list) green
  drawSeries(LO, getComputedStyle(document.documentElement).getPropertyValue('--low-color').trim(), (mode==="line"?"line":"dot"));
  let highColor = getComputedStyle(document.documentElement).getPropertyValue('--high-color').trim();
  if (can.id === 'historicalChart') highColor = '#ff69b4';
  drawSeries(HI, highColor, (mode==="line"?"line":"dot"));
  // Dotted prediction lines
  function drawPrediction(arr, color) {
    const nonNull = arr.map((v, i) => ({v, i})).filter(({v}) => v != null);
    if (nonNull.length < 2) return;
    const xVals = nonNull.map(({i}) => i);
    const yVals = nonNull.map(({v}) => v);
    const { slope, intercept } = linearRegression(xVals, yVals);
    context.save();
    context.setLineDash([6,6]);
    context.strokeStyle = color;
    context.beginPath();
    const startX = x0;
    const startY = ypx(slope * 0 + intercept, vmin, vmax, y0, h);
    const endX = x0 + (arr.length - 1) * stepX + stepX * 0.2; // extend 20%
    const endY = ypx(slope * (arr.length - 1 + (arr.length * 0.2)) + intercept, vmin, vmax, y0, h);
    context.moveTo(startX, startY);
    context.lineTo(endX, endY);
    context.stroke();
    context.restore();
  }
  drawPrediction(LO, getComputedStyle(document.documentElement).getPropertyValue('--low-color').trim());
  drawPrediction(HI, highColor);
  // y labels on top
  context.fillStyle="#fff"; context.font="bold 14px Segoe UI, Arial";
  for(let i=0;i<=lines;i++){
    const y=y0 + (h*i/lines);
    const v = Math.round(vmax - (vmax-vmin)*i/lines);
    context.fillText(abbreviateNumber(v), 6, y-4);
  }
  // X axis labels (dates) on top
  context.fillStyle="#fff"; context.font="bold 12px Segoe UI, Arial";
  const numLabels = 6;
  const labelStep = Math.floor(L.length / (numLabels - 1)) || 1;
  for(let i=0; i < L.length; i += labelStep){
    let dateStr;
    if (can.id === 'historicalChart') {
      dateStr = new Date(L[i]*1000).getFullYear().toString();
    } else {
      dateStr = new Date(L[i]*1000).toLocaleDateString();
    }
    const x = x0 + i*stepX;
    context.fillText(dateStr, x - 20, H - 10);
  }
  // hover tooltip
  c.onmousemove = (ev)=>{
    const rect=c.getBoundingClientRect();
    const mx=ev.clientX-rect.left, my=ev.clientY-rect.top;
    if(mx<x0 || mx>x0+w || my<y0 || my>y0+h){ tip.style.display="none"; return; }
    const idx=Math.max(0,Math.min(L.length-1, Math.round((mx-x0)/stepX)));
    const t=L[idx]*1000;
    const lo=LO[idx], hi=HI[idx], vol=VO[idx]||0;
    tip.style.display="block";
    tip.style.left = (mx+12)+"px";
    tip.style.top = (my-10)+"px";
    tip.innerHTML = `<strong>${new Date(t).toLocaleString()}</strong><br/>
      Low: ${fmtGp(lo)}<br/>
      High: ${fmtGp(hi)}<br/>
      Vol: ${fmtNum(vol)}`;
  };
  c.onmouseleave = () => tip.style.display="none";
}
/* ---------- Item selection & sidebar ---------- */
async function getBuyLimit(id) {
  if (buyLimits[id]) return buyLimits[id];
  try {
    const res = await fetch(`./items-json/${id}.json`);
    const data = await res.json();
    buyLimits[id] = data.buy_limit;
    return buyLimits[id];
  } catch (e) {
    console.warn(`Failed to load buy limit for item ${id}:`, e);
    return null;
  }
}
async function getItemId(name) {
  const m = mapping.find(x => x.name.toLowerCase() === name.toLowerCase());
  return m ? m.id : null;
}
async function getAlchValue(id) {
  try {
    const data = await jget(`./items-json/${id}.json`);
    return data.highalch || 0;
  } catch (e) {
    return 0;
  }
}
async function setItem(m){
  selected=m; $("#query").value=m.name;
  document.title = `${m.name} Live Prices, Graphs, Historical Data - (OSRS) GE - Flipping Tool`;
  const img=$("#itemImg");
  img.src=bigIconUrl(m.id);
  img.alt = m.name; // e.g., "Gilded scimitar"
  img.onerror=()=>{ img.onerror=null; img.src=wikiIconUrl(m.icon||m.name); };
  $("#status").textContent="Loading latest…";
  latest = await loadLatest();
  volumes= await loadVolumes();
  const node=latest.data[String(m.id)];
  const lo=node?.low ?? node?.avgLowPrice ?? null;
  const hi=node?.high ?? node?.avgHighPrice ?? null;
  let rec=suggestPrices(lo,hi);
  adjustedBuy = rec.buyMin ? Math.floor((rec.buyMin + rec.buyMax) / 2) : null;
  adjustedSell = rec.sellMin ? Math.floor((rec.sellMin + rec.sellMax) / 2) : null;
  buyLimit = await getBuyLimit(m.id) || 10000; // Lazy load + cache
  $("#smartBuyInput").value = adjustedBuy ? adjustedBuy.toLocaleString() : "—";
  $("#smartSellInput").value = adjustedSell ? adjustedSell.toLocaleString() : "—";
  $("#buyLimitDisplay").value = buyLimit.toLocaleString();
  $("#flipProfitLabel").textContent = "Expected Flip Profit";
  updateFlipProfit();
  $("#capitalRequired").textContent = adjustedBuy ? fmtGp(adjustedBuy * buyLimit) : "—";
  $("#buyLimitInfo").textContent = `with ${buyLimit.toLocaleString()} units (4h buy limit)`;
  $("#status").textContent="Loading chart…";
  const step = (view==="1d"?"1h":view==="1w"?"6h":view==="1m"?"24h":"24h");
  const ts = await loadTS(step, m.id);
  currentSeries = seriesFromTS(ts);
  // Load recent 5m series to cap suggestions
  const tsRecent = await loadTS("5m", m.id);
  const seriesRecent = seriesFromTS(tsRecent);
  const recentHighs = seriesRecent.high.filter(v => v != null);
  const maxRecentHi = recentHighs.length ? Math.max(...recentHighs) : hi || 0;
  rec.sellMin = Math.min(rec.sellMin, maxRecentHi + Math.floor(maxRecentHi * 0.05)); // Relaxed cap to +5%
  rec.sellMax = Math.min(rec.sellMax, maxRecentHi + Math.floor(maxRecentHi * 0.1)); // Relaxed cap to +10%
  if(view === "1d") zoom = 6;
  else if(view === "1m") zoom = 1;
  else zoom = 1.5;
  offset = Math.max(0, (currentSeries.labels.length - Math.floor(currentSeries.labels.length / zoom)));
  drawChart(currentSeries);
  // Update 1h spread
  const ts1h = await loadTS("1h", m.id);
  const series1h = seriesFromTS(ts1h);
  const lo1h = series1h.low[series1h.low.length - 1] || lo;
  const hi1h = series1h.high[series1h.high.length - 1] || hi;
  const spread1h = hi1h - lo1h;
  $("#spreadMargin").textContent = `1h Spread: ${fmtGp(spread1h)}`;
  // Update small historical chart with lifetime data (using 24h for more history)
  const tsHistorical = await loadTS("24h", m.id);
  const historicalSeries = seriesFromTS(tsHistorical);
  const histSeries = {...historicalSeries, low: historicalSeries.low.map(()=>null)}; // Only high line
  drawChart(histSeries, $("#historicalChart").getContext("2d"), $("#historicalChart"), 4, 0, "line");
  // Update lifetime title
  const historicalH3 = document.querySelector('.side .card-like h3');
  historicalH3.innerHTML = `1 Year: <span style="color:var(--ink)">${m.name}</span>`;
  // Fetch item description from OSRS Wiki
  let desc = '';
  try {
    const response = await fetch(`https://oldschool.runescape.wiki/api.php?action=query&prop=extracts&exintro&explaintext&redirects=1&titles=${encodeURIComponent(m.name)}&format=json`);
    const data = await response.json();
    const page = Object.values(data.query.pages)[0];
    desc = page.extract || 'No description available.';
  } catch (e) {
    desc = 'Failed to load description.';
  }
  $("#itemDesc").innerHTML = `<h3>About ${m.name}</h3><p>${desc}</p>`;
  $("#status").textContent="Ready";
  // Update add to watchlist button
  $("#addWatchBtn").disabled = customWatchlist.includes(m.id);
}
function updateSmartBuyFromInput(){
  adjustedBuy = parseInt($("#smartBuyInput").value.replace(/,/g, '')) || null;
  $("#smartBuyInput").value = adjustedBuy ? adjustedBuy.toLocaleString() : "—";
  $("#capitalRequired").textContent = adjustedBuy ? fmtGp(adjustedBuy * buyLimit) : "—";
  updateFlipProfit();
}
function updateSmartSellFromInput(){
  adjustedSell = parseInt($("#smartSellInput").value.replace(/,/g, '')) || null;
  $("#smartSellInput").value = adjustedSell ? adjustedSell.toLocaleString() : "—";
  updateFlipProfit();
}
function adjustPrice(type, delta){
  if (type === 'buy') {
    adjustedBuy = (adjustedBuy || 0) + delta;
    $("#smartBuyInput").value = adjustedBuy.toLocaleString() + ' gp';
    $("#capitalRequired").textContent = fmtGp(adjustedBuy * buyLimit);
  } else if (type === 'sell') {
    adjustedSell = (adjustedSell || 0) + delta;
    $("#smartSellInput").value = adjustedSell.toLocaleString() + ' gp';
  }
  updateFlipProfit();
}
function adjustBuyLimit(delta){
  buyLimit += delta;
  if (buyLimit < 1) buyLimit = 1;
  $("#buyLimitDisplay").value = buyLimit.toLocaleString();
  $("#buyLimitInfo").textContent = `with ${buyLimit.toLocaleString()} units (4h buy limit)`;
  $("#capitalRequired").textContent = adjustedBuy ? fmtGp(adjustedBuy * buyLimit) : "—";
  updateFlipProfit();
}
function updateBuyLimitFromInput(){
  buyLimit = parseInt($("#buyLimitDisplay").value.replace(/,/g, '')) || 10000;
  $("#buyLimitDisplay").value = buyLimit.toLocaleString();
  $("#buyLimitInfo").textContent = `with ${buyLimit.toLocaleString()} units (4h buy limit)`;
  $("#capitalRequired").textContent = adjustedBuy ? fmtGp(adjustedBuy * buyLimit) : "—";
  updateFlipProfit();
}
function updateFlipProfit(){
  if (adjustedBuy && adjustedSell && buyLimit) {
    const profitPerItem = adjustedSell - adjustedBuy - Math.min(5000000, Math.floor(adjustedSell * 0.01)); // 1% tax, cap 5m
    const totalProfit = profitPerItem * Math.min(buyLimit, 100); // Cap at 100 units for realistic profit
    $("#flipProfit").textContent = fmtGp(totalProfit);
  } else {
    $("#flipProfit").textContent = "—";
  }
}
function rowIcon(m){ return bigIconUrl(m.id); }
async function buildSidebar(){
  if(!latest||!mapping) return;
  const candidates = [];
  const volMin = 50000; // Increased for higher volume
  const minPrice = 500; // Increased for higher price items
  const minProfit = 50000; // Minimum expected profit
  for(const m of mapping){
    if(dismissed.includes(m.id)) continue;
    if(!membersOn && m.members) continue; // hide member items in F2P mode
    const node=latest.data[String(m.id)];
    if(!node) continue;
    const lo=node.low??node.avgLowPrice;
    const hi=node.high??node.avgHighPrice;
    if(lo==null||hi==null) continue;
    const spread=(hi-lo);
    if(spread <=1 || (lo && (spread / lo < 0.01))) continue; // Skip low margin
    const vol=volumes?.data?.[String(m.id)] ?? 0;
    if(vol < volMin) continue;
    const rec = suggestPrices(lo, hi);
    const medianBuy = rec.buyMin ? Math.floor((rec.buyMin + rec.buyMax) / 2) : null;
    const medianSell = rec.sellMin ? Math.floor((rec.sellMin + rec.sellMax) / 2) : null;
    if (medianBuy < minPrice) continue; // Skip low value
    const profitPerItem = medianSell - medianBuy - Math.min(5000000, Math.floor(medianSell * 0.01));
    // Temp expectedProfit without buyLimit (we'll recalculate after fetching)
    const tempExpectedProfit = profitPerItem * 10000; // Default for pre-filter
    if (tempExpectedProfit < minProfit) continue;
    candidates.push({id:m.id, name:m.name, icon:rowIcon(m), spread, vol, medianBuy, medianSell, preScore: vol * spread});
  }
  candidates.sort((a,b) => b.preScore - a.preScore);
  const topCandidates = candidates.slice(0, 100); // Limit to top 100 for speed
  // Fetch timeseries in parallel for top candidates
  const tsPromises = topCandidates.map(c => loadTS("5m", c.id));
  const tsResults = await Promise.all(tsPromises);
  // Fetch buy limits in parallel for top candidates
  const buyLimitPromises = topCandidates.map(c => getBuyLimit(c.id));
  const buyLimitResults = await Promise.all(buyLimitPromises);
  topCandidates.forEach((c, i) => {
    const seriesRecent = seriesFromTS(tsResults[i]);
    const recentLows = seriesRecent.low.filter(v => v != null).slice(-10); // Last 10 points
    const avgRecentLow = recentLows.length ? recentLows.reduce((a,b)=>a+b,0)/recentLows.length : c.lo;
    const dropPercent = (avgRecentLow - c.lo) / avgRecentLow;
    c.isGoodDeal = dropPercent > 0.1; // >10% drop from recent avg
    c.profitPerItem = c.medianSell - c.medianBuy - Math.min(5000000, Math.floor(c.medianSell * 0.01));
    c.buyLimit = buyLimitResults[i] || 10000; // Use fetched/cached value
    c.expectedProfit = c.profitPerItem * c.buyLimit;
    c.score = c.vol * c.spread * (1 + dropPercent);
  });
  topCandidates.sort((a,b)=> b.expectedProfit - a.expectedProfit); // Prioritize by total expected profit
  flipSuggestions = topCandidates;
  updateSmartSuggest();
}
function updateSmartSuggest(){
  if(flipSuggestions.length === 0) return;
  const top = flipSuggestions[suggestIndex % flipSuggestions.length];
  const m = mapping.find(x=>x.id === top.id);
  if(!m) return;
  $("#smartSuggest").innerHTML = `
    <img src="${bigIconUrl(top.id)}" alt="${m.name}">
    <div class="details">
      <div class="name">${m.name}</div>
      <div class="prices">
        <div class="price buy"><label>Buy</label><strong>${top.medianBuy ? top.medianBuy.toLocaleString() + ' gp' : '—'}</strong></div>
        <div class="price sell"><label>Sell</label><strong>${top.medianSell ? top.medianSell.toLocaleString() + ' gp' : '—'}</strong></div>
      </div>
    </div>
    ${top.isGoodDeal ? '<div class="good-deal">Good Deal Alert!</div>' : ''}
  `;
  $("#smartSuggest").dataset.id = top.id;
  $("#smartSuggest").onclick = () => {
    const mItem = mapping.find(x => x.id == top.id);
    if (mItem) setItem(mItem);
  };
  const profitPerItem = top.medianSell - top.medianBuy - Math.min(5000000, Math.floor(top.medianSell * 0.01));
  const itemBuyLimit = top.buyLimit; // Use pre-fetched from buildSidebar
  const totalProfit = profitPerItem * Math.min(itemBuyLimit, 100); // Cap for realistic profit
  $("#suggestProfit strong").textContent = fmtGp(totalProfit);
}
/* ---------- Popout Chart ---------- */
function popoutChart(){
  const popup = window.open('', '_blank', 'width=900,height=600');
  popup.document.write(`
    <html>
    <head><title>Chart Popout</title></head>
    <body style="margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,Inter,system-ui,Arial;">
    <div style="padding:10px;display:flex;flex-direction:column;height:100%;">
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;">
      <div class="viewtabs">
        <button data-view="1d" class="active">1D</button>
        <button data-view="1w">1W</button>
        <button data-view="1m">1M</button>
        <button data-view="6m">6M</button>
        <button data-view="1y">1Y</button>
        <button data-view="5y">5Y</button>
        <button data-view="all">All</button>
      </div>
      <div class="tools" style="margin-left:auto;display:flex;gap:6px;align-items:center;">
        <span class="small">Zoom:</span><button id="zIn">+</button><button id="zOut">−</button>
        <span class="small" style="margin-left:10px">Mode:</span>
        <button id="lineMode" class="active">Line</button>
        <button id="dotMode">Scatter</button>
      </div>
    </div>
    <canvas id="popChart" style="flex:1;background:var(--grid);border:1px solid var(--edge);border-radius:12px;"></canvas>
    <div class="legend" style="display:flex;gap:12px;font-size:12px;margin-top:6px;color:var(--muted)">
      <span class="sell">Low (Buy)</span><span class="buy">High (Sell)</span>
    </div>
    <div id="foot" class="small" style="margin-top:6px"></div>
    </div>
    </body>
    </html>
  `);
  popup.document.head.appendChild(document.createElement('style')).textContent = document.querySelector('style').textContent;
  const popCanvas = popup.document.getElementById('popChart');
  popCanvas.width = 880;
  popCanvas.height = 480;
  const popCtx = popCanvas.getContext('2d');
  let popSeries = currentSeries;
  let popView = view;
  let popZoom = zoom;
  let popOffset = offset;
  let popDrawMode = drawMode;
  function popDraw() {
    drawChart(popSeries, popCtx, popCanvas, popZoom, popOffset, popDrawMode);
    popup.document.getElementById('foot').textContent = $("#foot").textContent;
  }
  popup.document.querySelectorAll('.viewtabs button').forEach(b=>{
    b.onclick=async ()=>{
      popup.document.querySelector('.viewtabs button.active').classList.remove("active");
      b.classList.add("active");
      popView=b.dataset.view;
      const step = (popView==="1d"?"1h":popView==="1w"?"6h":popView==="1m"?"24h":"24h");
      const ts = await loadTS(step, selected.id);
      popSeries = seriesFromTS(ts);
      popZoom = 1.5;
      popOffset = Math.max(0, (popSeries.labels.length - 60));
      popDraw();
    }
  });
  popup.document.getElementById("zIn").onclick = ()=>{ popZoom=Math.min(8, popZoom*1.25); popDraw(); };
  popup.document.getElementById("zOut").onclick= ()=>{ popZoom=Math.max(1, popZoom/1.25); popDraw(); };
  popup.document.getElementById("lineMode").onclick=()=>{ popDrawMode="line"; popup.document.getElementById("lineMode").classList.add("active"); popup.document.getElementById("dotMode").classList.remove("active"); popDraw(); };
  popup.document.getElementById("dotMode").onclick =()=>{ popDrawMode="dot"; popup.document.getElementById("dotMode").classList.add("active"); popup.document.getElementById("lineMode").classList.remove("active"); popDraw(); };
  popDraw();
}
/* ---------- Boot ---------- */
(async function boot(){
  try{
    $("#status").textContent="Fetching mapping…";
    mapping = await loadMapping();
    // Load categoryItems from categories.json
    let categoryItems = {}; // Default to empty
    try {
      const categoriesResponse = await fetch('./categories.json');
      categoryItems = await categoriesResponse.json();
    } catch (e) {
      console.warn("Failed to load categories.json:", e);
    }
    // Load watchlist
    let watchKey = membersOn ? 'watchlist_members' : 'watchlist_f2p';
    watchlist = JSON.parse(localStorage.getItem(watchKey)) || [];
    customWatchlist = JSON.parse(localStorage.getItem('customWatchlist')) || [];
    dismissed = [];
    const membersOnlyCategories = ['herbs', 'potions', '3rd-age-items', 'charging-items', 'mage-armour', 'melee-armour', 'range-armour'];
    const categorySelect = $("#categorySelect");
    function updateCategoryOptions() {
      categorySelect.innerHTML = '';
      const option = document.createElement('option');
      option.value = 'custom';
      option.textContent = 'Custom Watchlist';
      categorySelect.appendChild(option);
      Object.keys(categoryItems).forEach(cat => {
        if (cat !== 'custom' && (membersOn || !membersOnlyCategories.includes(cat))) {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat.replace(/-/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
          categorySelect.appendChild(option);
        }
      });
    }
    updateCategoryOptions(); // Call after loading categoryItems
    categorySelect.value = 'gems'; // Default, assuming 'gems' exists in categories.json
    const loadCategory = async (cat) => {
      if (cat === 'custom') {
        watchlist = customWatchlist;
      } else {
        const itemNames = categoryItems[cat] || []; // Now from loaded JSON
        watchlist = [];
        for (const name of itemNames) {
          const m = mapping.find(x => x.name.toLowerCase() === name.toLowerCase());
          if (m && (membersOn || !m.members)) watchlist.push(m.id);
        }
      }
      latest = await loadLatest();
      watchlist.sort((a,b) => {
        const pa = latest.data[a]?.high || 0;
        const pb = latest.data[b]?.high || 0;
        return pb - pa; // descending
      });
      localStorage.setItem(watchKey, JSON.stringify(watchlist));
      buildWatchlist();
    };
    loadCategory('gems');
    categorySelect.addEventListener('change', () => loadCategory(categorySelect.value));
    // Autocomplete
    const sb=$("#suggestBox");
    $("#query").addEventListener("input", ()=>{
      const q=$("#query").value.trim().toLowerCase();
      if(!q){ sb.style.display="none"; sb.innerHTML=""; return; }
      const list=mapping.filter(x=> (!membersOn && x.members ? false : true) && x.name.toLowerCase().includes(q)).slice(0,20);
      sb.innerHTML=list.map(x=>`<div data-id="${x.id}">${x.name}</div>`).join("");
      sb.style.display=list.length?"block":"none";
    });
    sb.addEventListener("click", (e)=>{
      const id=e.target?.dataset?.id;
      if(!id) return;
      const m=mapping.find(x=>String(x.id)===String(id));
      if(m){ sb.style.display="none"; setItem(m); }
    });
    // View buttons
    document.querySelectorAll(".viewtabs button").forEach(b=>{
      b.onclick=()=>{
        document.querySelectorAll(".viewtabs button").forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        view=b.dataset.view;
        if(selected) setItem(selected);
      }
    });
    // Chart tools
    $("#zIn").onclick = ()=>{ zoom=Math.min(8, zoom*1.25); offset = currentSeries.labels.length - Math.floor(currentSeries.labels.length / zoom); drawChart(currentSeries); };
    $("#zOut").onclick= ()=>{ zoom=Math.max(1, zoom/1.25); offset = currentSeries.labels.length - Math.floor(currentSeries.labels.length / zoom); drawChart(currentSeries); };
    $("#lineMode").onclick=()=>{ drawMode="line"; $("#lineMode").classList.add("active"); $("#dotMode").classList.remove("active"); drawChart(currentSeries); };
    $("#dotMode").onclick =()=>{ drawMode="dot"; $("#dotMode").classList.add("active"); $("#lineMode").classList.remove("active"); drawChart(currentSeries); };
    $("#popoutBtn").onclick = () => popoutChart();
    // Mode pill for F2P/Members
    $("#btnF2P").onclick=()=>{
      membersOn=false; $("#btnF2P").classList.add("active"); $("#btnMembers").classList.remove("active");
      watchKey = 'watchlist_f2p';
      watchlist = JSON.parse(localStorage.getItem(watchKey)) || [];
      updateCategoryOptions();
      loadCategory(categorySelect.value);
      buildSidebar(); buildWatchlist(); buildAlchList(); buildSetsList(); buildCraftList(); buildEnchantList(); buildSmithList();
    };
    $("#btnMembers").onclick=()=>{
      membersOn=true; $("#btnMembers").classList.add("active"); $("#btnF2P").classList.remove("active");
      watchKey = 'watchlist_members';
      watchlist = JSON.parse(localStorage.getItem(watchKey)) || [];
      updateCategoryOptions();
      loadCategory(categorySelect.value);
      buildSidebar(); buildWatchlist(); buildAlchList(); buildSetsList(); buildCraftList(); buildEnchantList(); buildSmithList();
    };
    // Add to watchlist
    $("#addWatchBtn").onclick = ()=>{
      if(selected && !customWatchlist.includes(selected.id)){
        customWatchlist.push(selected.id);
        localStorage.setItem('customWatchlist', JSON.stringify(customWatchlist));
        if (categorySelect.value === 'custom') {
          buildWatchlist();
        }
        $("#addWatchBtn").disabled = true;
      }
    };
    // Next suggestion
    $("#nextSuggest").onclick = () => {
      suggestIndex = (suggestIndex + 1) % flipSuggestions.length;
      updateSmartSuggest();
    };
    // Refresh
    $("#refreshBtn").onclick=async ()=>{
      $("#loader-overlay").style.display = "flex";
      $("#status").textContent="Refreshing…";
      latest = await loadLatest();
      volumes = await loadVolumes();
      dismissed = [];
      await buildSidebar();
      buildWatchlist();
      if(selected) await setItem(selected);
      await buildAlchList();
      await buildSetsList();
      await buildCraftList();
      await buildEnchantList();
      await buildSmithList();
      $("#loader-overlay").style.display = "none";
      $("#status").textContent="Live data refreshed";
      setTimeout(()=>$("#status").textContent="Ready", 1200);
    };
    // Initial load
    latest = await loadLatest();
    volumes = await loadVolumes();
    await buildSidebar();
    buildWatchlist();
    // Preload a default item if present
    const gildedScimitar = mapping.find(x=>x.name.toLowerCase()==="gilded scimitar");
    if(gildedScimitar) setItem(gildedScimitar);
    // Color pickers
    const lowColorPicker = document.getElementById('lowColorPicker');
    const highColorPicker = document.getElementById('highColorPicker');
    const savedLowColor = localStorage.getItem('lowColor') || '#fb6a6a';
    const savedHighColor = localStorage.getItem('highColor') || '#5cc76a';
    document.documentElement.style.setProperty('--low-color', savedLowColor);
    document.documentElement.style.setProperty('--high-color', savedHighColor);
    lowColorPicker.value = savedLowColor;
    highColorPicker.value = savedHighColor;
    lowColorPicker.addEventListener('change', (e) => {
      document.documentElement.style.setProperty('--low-color', e.target.value);
      localStorage.setItem('lowColor', e.target.value);
      if (currentSeries) drawChart(currentSeries);
    });
    highColorPicker.addEventListener('change', (e) => {
      document.documentElement.style.setProperty('--high-color', e.target.value);
      localStorage.setItem('highColor', e.target.value);
      if (currentSeries) drawChart(currentSeries);
    });
    // Watchlist sorting
    let sortDirections = {symbol: 'desc', buy: 'desc', sell: 'desc'};
    function updateSortArrows() {
      $('#sortSymbol .sort-arrow').textContent = sortDirections.symbol === 'asc' ? '▲' : '▼';
      $('#sortBuy .sort-arrow').textContent = sortDirections.buy === 'asc' ? '▲' : '▼';
      $('#sortSell .sort-arrow').textContent = sortDirections.sell === 'asc' ? '▲' : '▼';
    }
    $("#sortSymbol").onclick = () => {
      sortDirections.symbol = sortDirections.symbol === 'asc' ? 'desc' : 'asc';
      buildWatchlist('name');
      updateSortArrows();
    };
    $("#sortBuy").onclick = () => {
      sortDirections.buy = sortDirections.buy === 'asc' ? 'desc' : 'asc';
      buildWatchlist('buy');
      updateSortArrows();
    };
    $("#sortSell").onclick = () => {
      sortDirections.sell = sortDirections.sell === 'asc' ? 'desc' : 'asc';
      buildWatchlist('sell');
      updateSortArrows();
    };
    updateSortArrows();
    // Tab switching
    const tabs = {
      faq: $('#faqContent'),
      alch: $('#alchContent'),
      sets: $('#setsContent'),
      crafting: $('#craftingTabContent'),
      enchanting: $('#enchantingContent'),
      smithing: $('#smithingContent'),
      contact: $('#contactContent')
    };
    const tabButtons = {
      faq: $('#faqTab'),
      alch: $('#alchTab'),
      sets: $('#setsTab'),
      crafting: $('#craftingTab'),
      enchanting: $('#enchantingTab'),
      smithing: $('#smithingTab'),
      contact: $('#contactTab')
    };
    function switchTab(tabName, buildFunc) {
      Object.values(tabButtons).forEach(btn => btn.classList.remove('active'));
      Object.values(tabs).forEach(content => content.classList.remove('active'));
      tabButtons[tabName].classList.add('active');
      tabs[tabName].classList.add('active');
      if (buildFunc) buildFunc();
    }
    $('#faqTab').onclick = () => switchTab('faq');
    $('#alchTab').onclick = () => switchTab('alch', buildAlchList);
    $('#setsTab').onclick = () => switchTab('sets', buildSetsList);
    $('#craftingTab').onclick = () => switchTab('crafting', buildCraftList);
    $('#enchantingTab').onclick = () => switchTab('enchanting', buildEnchantList);
    $('#smithingTab').onclick = () => switchTab('smithing', buildSmithList);
    $('#contactTab').onclick = () => switchTab('contact');
    // Initial alch build (optional; or lazy on tab)
    // New: Real-time price alerts (poll every 5 mins)
    let previousPrices = {}; // Store previous high prices
    watchlist.forEach(id => previousPrices[id] = latest.data[id]?.high || 0); // Initial
    setInterval(async () => {
      const newLatest = await loadLatest();
      watchlist.forEach(id => {
        const oldHi = previousPrices[id] || 0;
        const newHi = newLatest.data[id]?.high || 0;
        if (oldHi === 0) return;
        const changePercent = ((newHi - oldHi) / oldHi) * 100;
        const row = document.querySelector(`#watch .row [data-id="${id}"]`)?.parentNode;
        if (!row) return;
        row.style.border = '1px solid var(--edge)'; // Reset
        row.style.animation = 'none';
        if (changePercent <= -20) {
          row.style.border = '2px solid #8b0000'; // Dark red drop
        } else if (changePercent <= -10) {
          row.style.border = '2px solid #ff0000'; // Red drop
        } else if (changePercent <= -5) {
          row.style.border = '2px solid #ffff00'; // Yellow drop
        } else if (changePercent >= 20) {
          row.style.border = '2px solid #00ff00'; // Green gain + glow
          row.style.animation = 'glow 1.5s infinite alternate';
        } else if (changePercent >= 10) {
          row.style.border = '2px solid #00ff00'; // Green gain
        } else if (changePercent >= 5) {
          row.style.border = '2px solid #00ffff'; // Cyan gain
        }
        previousPrices[id] = newHi;
      });
      latest = newLatest; // Update global
      buildWatchlist(); // Refresh watchlist
      buildAlchList();
      buildSetsList();
      buildCraftList();
      buildEnchantList();
      buildSmithList();
    }, 300000); // 5 mins
  } catch (e) {
    console.error('Boot error:', e);
    try { $("#status").textContent = "Error"; } catch (_) {}
  }
})();
</script>
</body>
</html>